

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="https://fang-kang.gitee.io/blog-img/head.png">
  <link rel="icon" href="https://fang-kang.gitee.io/blog-img/head.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="房康的个人博客，凌烟的个人博客，博客，记录生活">
  
    <meta name="description" content="这篇主要内容：  项目架构规划 入口文件配置说明 依赖安装 配置模板引擎和静态文件 静态模板 系统配置和应用配置 数据库之用户表 注册 使用 node-mailer 发送邮件 登录和第三方认证 github 登录 session 和 cookie 找回密码和登出  项目架构规划设计一个好的文件结构约定，会让我们开发合作、维护管理，节省很多不必要沟通。 这里我src文件规划：    文件 说明">
<meta property="og:type" content="article">
<meta property="og:title" content="nest.js学习（二）">
<meta property="og:url" content="https://fang-kang.gitee.io/blog/2021/01/29/node/nest_2/index.html">
<meta property="og:site_name" content="凌烟">
<meta property="og:description" content="这篇主要内容：  项目架构规划 入口文件配置说明 依赖安装 配置模板引擎和静态文件 静态模板 系统配置和应用配置 数据库之用户表 注册 使用 node-mailer 发送邮件 登录和第三方认证 github 登录 session 和 cookie 找回密码和登出  项目架构规划设计一个好的文件结构约定，会让我们开发合作、维护管理，节省很多不必要沟通。 这里我src文件规划：    文件 说明">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://fang-kang.gitee.io/blog-img/nest2.png">
<meta property="article:published_time" content="2021-01-29T18:20:00.000Z">
<meta property="article:modified_time" content="2023-04-10T06:32:05.589Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="node">
<meta property="article:tag" content="nest">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://fang-kang.gitee.io/blog-img/nest2.png">
  
  
  
  <title>nest.js学习（二） - 凌烟</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/blog/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/blog/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/blog/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"fang-kang.gitee.io","root":"/blog/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"|","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":200}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/blog/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/blog/js/utils.js" ></script>
  <script  src="/blog/js/color-schema.js" ></script>
  

  

  

  

  

  

  

  



  
<meta name="generator" content="Hexo 5.0.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 60vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/blog/">
      <strong>凌烟</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" target="_blank" rel="noopener" href="https://fang-kang.github.io/note">
                <i class="iconfont icon-books"></i>
                <span>笔记</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://fang-kang.gitee.io/blog-img/blog/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="nest.js学习（二）"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2021-01-29 18:20" pubdate>
          2021年1月29日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          <!-- compatible with older versions-->
          86k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          <!-- compatible with older versions-->
          713 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
        <div class="scroll-down-bar">
          <i class="iconfont icon-arrowdown"></i>
        </div>
      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">nest.js学习（二）</h1>
            
            
              <div class="markdown-body">
                
                <p>这篇主要内容：</p>
<ul>
<li>项目架构规划</li>
<li>入口文件配置说明</li>
<li>依赖安装</li>
<li>配置模板引擎和静态文件</li>
<li>静态模板</li>
<li>系统配置和应用配置</li>
<li>数据库之用户表</li>
<li>注册</li>
<li>使用 node-mailer 发送邮件</li>
<li>登录和第三方认证 github 登录</li>
<li>session 和 cookie</li>
<li>找回密码和登出</li>
</ul>
<h2 id="项目架构规划设计"><a href="#项目架构规划设计" class="headerlink" title="项目架构规划设计"></a>项目架构规划设计</h2><p>一个好的文件结构约定，会让我们开发合作、维护管理，节省很多不必要沟通。</p>
<p>这里我<code>src</code>文件规划：</p>
<table>
<thead>
<tr>
<th>文件</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>main.ts</td>
<td>入口</td>
</tr>
<tr>
<td>main.hmr.ts</td>
<td>热更新入口</td>
</tr>
<tr>
<td>app.service.ts</td>
<td>APP 服务（选择）</td>
</tr>
<tr>
<td>app.module.ts</td>
<td>APP 模块（根模块，必须）</td>
</tr>
<tr>
<td>app.controller.ts</td>
<td>APP 控制器（选择）</td>
</tr>
<tr>
<td>app.controller.spec.ts</td>
<td>APP 控制器单元测试用例（选择）</td>
</tr>
<tr>
<td>config</td>
<td>配置模块</td>
</tr>
<tr>
<td>core</td>
<td>核心模块（申明过滤器、管道、拦截器、守卫、中间件、全局模块）</td>
</tr>
<tr>
<td>feature</td>
<td>特性模块（主要业务模块）</td>
</tr>
<tr>
<td>shared</td>
<td>共享模块（共享 mongodb、redis 封装服务、通用服务）</td>
</tr>
<tr>
<td>tools</td>
<td>工具（提供一些小工具函数）</td>
</tr>
</tbody></table>
<blockquote>
<p>这是我参考我<code>Angular</code>项目的结构，写了几个<code>nest</code>项目后发现这个很不错。把<code>mongodb</code>服务和业务模块分开，还有一个好处就是减少<code>nest</code>循环依赖注入深坑，后面会讲怎么解决它。</p>
</blockquote>
<h2 id="入口文件配置说明"><a href="#入口文件配置说明" class="headerlink" title="入口文件配置说明"></a>入口文件配置说明</h2><p>打开<code>main.ts</code>文件</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">NestFactory</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/core&#x27;</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">AppModule</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./app.module&#x27;</span><br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">bootstrap</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> app = <span class="hljs-keyword">await</span> <span class="hljs-title class_">NestFactory</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">AppModule</span>)<br>  <span class="hljs-keyword">await</span> app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>)<br>&#125;<br><span class="hljs-title function_">bootstrap</span>()<br></code></pre></td></tr></table></figure>

<p><code>NestFactory</code> 创建一个 app 实例，监听<code>3000</code>端口。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Creates an instance of the NestApplication</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@returns</span> &#123;<span class="hljs-type">Promise</span>&#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-title function_">create</span>(<span class="hljs-attr">module</span>: <span class="hljs-built_in">any</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">INestApplication</span> &amp; <span class="hljs-title class_">INestExpressApplication</span>&gt;;<br><span class="hljs-title function_">create</span>(<span class="hljs-attr">module</span>: <span class="hljs-built_in">any</span>, <span class="hljs-attr">options</span>: <span class="hljs-title class_">NestApplicationOptions</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">INestApplication</span> &amp; <span class="hljs-title class_">INestExpressApplication</span>&gt;;<br><span class="hljs-title function_">create</span>(<span class="hljs-attr">module</span>: <span class="hljs-built_in">any</span>, <span class="hljs-attr">httpServer</span>: <span class="hljs-title class_">FastifyAdapter</span>, options?: <span class="hljs-title class_">NestApplicationOptions</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">INestApplication</span> &amp; <span class="hljs-title class_">INestFastifyApplication</span>&gt;;<br><span class="hljs-title function_">create</span>(<span class="hljs-attr">module</span>: <span class="hljs-built_in">any</span>, <span class="hljs-attr">httpServer</span>: <span class="hljs-title class_">HttpServer</span>, options?: <span class="hljs-title class_">NestApplicationOptions</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">INestApplication</span> &amp; <span class="hljs-title class_">INestExpressApplication</span>&gt;;<br><span class="hljs-title function_">create</span>(<span class="hljs-attr">module</span>: <span class="hljs-built_in">any</span>, <span class="hljs-attr">httpServer</span>: <span class="hljs-built_in">any</span>, options?: <span class="hljs-title class_">NestApplicationOptions</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">INestApplication</span> &amp; <span class="hljs-title class_">INestExpressApplication</span>&gt;;<br></code></pre></td></tr></table></figure>

<p><code>create</code>方法有 1-3 参数，第一个是入口模块<code>AppModule</code>, 第二个是一个<code>httpServer</code>,如果要绑定<code>Express</code>中间件，需要传递<code>Express</code>实例。第三个全局配置：</p>
<ul>
<li>logger 打印日志</li>
<li>cors 跨域配置</li>
<li>bodyParser post 和 put 解析 body 中间件配置</li>
<li>httpsOptions https 配置</li>
</ul>
<p><code>app</code> 带方法有哪些<br><code>INestApplication</code>下</p>
<ul>
<li>init 初始化应用程序，直接调用此方法并非强制。（效果不明）</li>
<li>use 注册中间件</li>
<li>enableCors 启用 CORS（跨源资源共享）</li>
<li>listen 启动应用程序。</li>
<li>listenAsync 同步启动应用程序。</li>
<li>setGlobalPrefix 注册每个 HTTP 路由路径的前缀</li>
<li>useWebSocketAdapter 安装将在网关内部使用的 Ws 适配器。使用时覆盖，默认<code>socket.io</code>库。</li>
<li>connectMicroservice 将微服务连接到 NestApplication 实例。 将应用程序转换为混合实例。</li>
<li>getMicroservices 返回连接到 NestApplication 的微服务的数组。</li>
<li>getHttpServer 返回基础的本地 HTTP 服务器。</li>
<li>startAllMicroservices 异步启动所有连接的微服务</li>
<li>startAllMicroservicesAsync 同步启动所有连接的微服务</li>
<li>useGlobalFilters 将异常过滤器注册为全局过滤器（将在每个 HTTP 路由处理程序中使用）</li>
<li>useGlobalPipes 将管道注册为全局管道（将在每个 HTTP 路由处理程序中使用）</li>
<li>useGlobalInterceptors 将拦截器注册为全局拦截器（将在每个 HTTP 路由处理器中使用）</li>
<li>useGlobalGuards 注册警卫作为全局警卫（将在每个 HTTP 路由处理程序中使用）</li>
<li>close 终止应用程序（包括 NestApplication，网关和每个连接的微服务）<br><code>INestExpressApplication</code>下</li>
<li>set 围绕本地<code>express.set()</code>方法的包装函数。</li>
<li>engine 围绕本地<code>express.engine()</code>方法的包装函数。</li>
<li>enable 围绕本地<code>express.enable()</code>方法的包装函数。</li>
<li>disable 围绕本地<code>express.disable()</code>方法的包装函数。</li>
<li>useStaticAssets 为静态资源设置基础目录。围绕本地<code>express.static(path, options)</code>方法的包装函数。</li>
<li>setBaseViewsDir 设置模板（视图）的基本目录。围绕本地<code>express.set(&#39;views&#39;, path)</code>方法的包装函数。</li>
<li>setViewEngine 为模板（视图）设置视图引擎。围绕本地<code>express.set(&#39;view engine&#39;, engine)</code>方法的包装函数。</li>
</ul>
<h2 id="依赖安装"><a href="#依赖安装" class="headerlink" title="依赖安装"></a>依赖安装</h2><h3 id="核心依赖"><a href="#核心依赖" class="headerlink" title="核心依赖"></a>核心依赖</h3><p>因为目前 CNode 采用<code>Egg</code>编写，里面大量使用与<code>Egg</code>集成的<code>egg-xxx</code>包，这里我把相关的连对应的依赖都一一来出来。</p>
<h4 id="模板引擎"><a href="#模板引擎" class="headerlink" title="模板引擎"></a>模板引擎</h4><p><code>Egg-CNode</code>使用<code>egg-view-ejs</code>，本项目使用<code>ejs</code>包，唯一缺点没有<code>layout</code>功能，可以麻烦点，在每个文件引入头和尾即可，也有另外一个包<code>ejs-mate</code>，它有<code>layout</code>功能，后面会介绍它怎么使用。</p>
<h4 id="redis"><a href="#redis" class="headerlink" title="redis"></a>redis</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">Egg-CNode`使用`egg-redis`操作`redis`，其实它是包装的`ioredis`包，我也一直在nodejs里使用这个包，需要安装生产`ioredis`和开发`@types/ioredis<br></code></pre></td></tr></table></figure>

<h4 id="mongoose"><a href="#mongoose" class="headerlink" title="mongoose"></a>mongoose</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">Egg-CNode`使用`egg-mongoose`操作`mongodb`，`Nest`提供了`@nestjs/mongoose`，需要安装生产`mongoose`和开发`@types/mongoose<br></code></pre></td></tr></table></figure>

<h4 id="passport"><a href="#passport" class="headerlink" title="passport"></a>passport</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">Egg-CNode`使用`egg-passport、egg-passport-github、egg-passport-local`做身份验证，`Nest`提供了`@nestjs/passport`，需要安装生产`passport、passport-github、passport-local<br></code></pre></td></tr></table></figure>

<p>其他依赖在后面用到时候在详细介绍，这几个是比较重要的依赖。</p>
<h2 id="配置-Views-视图模板和-public-静态资源"><a href="#配置-Views-视图模板和-public-静态资源" class="headerlink" title="配置 Views 视图模板和 public 静态资源"></a>配置 Views 视图模板和 public 静态资源</h2><p><code>CNode</code> 使用的是<code>egg-ejs</code>,为了简单点，减少静态文件编写，我也用<code>ejs</code>。发现区别就是少了<code>layout</code>功能，需要我们拆分<code>layout/header.ejs</code>和<code>layout/footer.ejs</code>在使用了。<br>但是有一个包可以做到类似的功能<code>ejs-mate</code>，这个是<a target="_blank" rel="noopener" href="https://github.com/JacksonTian">@JacksonTian</a> 朴灵大神的作品。</p>
<p>新建模板存放<code>views</code>文件夹(root/views)和静态资源存放<code>public</code>文件夹(root/public)</p>
<p><strong>注意</strong>：<code>nest-cli</code>默认只处理<code>src</code>里面的 ts 文件，如有其他文件需要自己写脚本处理，<code>gulp</code>或者<code>webpack</code>都可以，这里就简单一点，直接把<code>views</code>和<code>public</code>放在<code>src</code>平级的根目录里面了。后面会说怎么处理它们设置问题。</p>
<h3 id="模板引擎-1"><a href="#模板引擎-1" class="headerlink" title="模板引擎"></a>模板引擎</h3><p>安装<code>ejs-mate</code>依赖：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm install ejs-mate --save<br></code></pre></td></tr></table></figure>

<p>用法很简单了，关于文件名后缀，默认使用<code>.ejs</code>，<code>.ejs</code>虽然会让它语法高亮，有个坑就<code>html</code>标签不会自动补全提示。那需要换成<code>.html</code>后缀。</p>
<p>设置模板引擎：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> &#123; join &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;path&#x27;</span>;<br><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> ejsMate <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;ejs-mate&#x27;</span>;<br><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">bootstrap</span>(<span class="hljs-params"></span>) &#123;<br>    ....<br>      <span class="hljs-comment">// 获取根目录 nest-cnode</span><br>    <span class="hljs-keyword">const</span> rootDir = <span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">&#x27;..&#x27;</span>);<br>    <span class="hljs-comment">// 指定视图引擎 处理.html后缀文件</span><br>    app.<span class="hljs-title function_">engine</span>(<span class="hljs-string">&#x27;html&#x27;</span>, ejsMate);<br>    <span class="hljs-comment">// 视图引擎</span><br>    app.<span class="hljs-title function_">set</span>(<span class="hljs-string">&#x27;view engine&#x27;</span>, <span class="hljs-string">&#x27;html&#x27;</span>);<br>    <span class="hljs-comment">// 配置模板（视图）的基本目录</span><br>    app.<span class="hljs-title function_">setBaseViewsDir</span>(<span class="hljs-title function_">join</span>(rootDir, <span class="hljs-string">&#x27;views&#x27;</span>));<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意</strong>：当前启动程序是<code>src/main.ts</code>，因为<code>views</code>和<code>public</code>在根目录，所有我们就需要去获取获取根目录。其他注释已经说明，就不再赘述。</p>
</blockquote>
<p>使用模板引擎：</p>
<ol>
<li>我们在<code>views</code>文件夹里面新建一个<code>layout.html</code>和一个<code>index.html</code>。</li>
<li>写通用的<code>layout.html</code></li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;zh-CN&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>我是layout模板<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    &lt;%- body -%&gt;<br>  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure>

<ol>
<li>写的<code>index.html</code></li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs html">&lt;% layout(&#x27;layout&#x27;) -%&gt;<br><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>我是首页<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br></code></pre></td></tr></table></figure>

<ol>
<li>渲染模板引擎</li>
</ol>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Get</span>, <span class="hljs-title class_">Controller</span>, <span class="hljs-title class_">Render</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/common&#x27;</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">AppService</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./app.service&#x27;</span><br><br><span class="hljs-meta">@Controller</span>()<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppController</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> appService: AppService</span>) &#123;&#125;<br><br>  <span class="hljs-meta">@Get</span>()<br>  <span class="hljs-meta">@Render</span>(<span class="hljs-string">&#x27;index&#x27;</span>)<br>  <span class="hljs-title function_">root</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> &#123;&#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>注意</strong>：<code>@Render()</code>里面一定要写模板文件名(可以省略后缀)，不然访问页面显示是<code>json</code>对象。</p>
<p>访问首页<code>http://localhost:3000/</code>看结果。</p>
<p><a target="_blank" rel="noopener" href="https://user-images.githubusercontent.com/6111778/44764383-043ced00-ab82-11e8-8ae4-35d9cedcd26d.png"><img src="https://user-images.githubusercontent.com/6111778/44764383-043ced00-ab82-11e8-8ae4-35d9cedcd26d.png" srcset="/blog/img/loading.gif" lazyload alt="3nc4l2 l_nbp_di0fkomamc"></a></p>
<p><code>ejs-mate</code>语法：</p>
<p><code>ejs-mate</code>兼容<a target="_blank" rel="noopener" href="https://ejs.bootcss.com/">ejs</a>语法，语法很简单，这里顺便带一下：</p>
<ul>
<li>&lt;% ‘脚本’ 标签，用于流程控制，无输出。</li>
<li>&lt;%_ 删除其前面的空格符</li>
<li>&lt;%= 输出数据到模板（输出是转义 HTML 标签）</li>
<li>&lt;%- 输出非转义的数据到模板</li>
<li>&lt;%# 注释标签，不执行、不输出内容</li>
<li>&lt;%% 输出字符串 ‘&lt;%’</li>
<li>%&gt; 一般结束标签</li>
<li>-%&gt; 删除紧随其后的换行符</li>
<li>_%&gt; 将结束标签后面的空格符删除</li>
</ul>
<p>说几个常用的写法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash">&lt;% 直接写js代码，不输出：%&gt;<br><br>&lt;ul&gt;<br>  &lt;% users.forEach(<span class="hljs-keyword">function</span>(user)&#123; %&gt;<br>    &lt;%- include(<span class="hljs-string">&#x27;user/show&#x27;</span>, &#123;user: user&#125;); %&gt;<br>  &lt;% &#125;); %&gt;<br>&lt;/ul&gt;<br><br>&lt;%<span class="hljs-comment"># 输出变量：%&gt;</span><br><br>&lt;%= <span class="hljs-string">&#x27;变量&#x27;</span> %&gt;<br><br>&lt;%<span class="hljs-comment"># 输出HTML：%&gt;</span><br><br>&lt;%- <span class="hljs-string">&#x27;&lt;h1&gt;标题&lt;/h1&gt;&#x27;</span> %&gt;<br><br>&lt;%<span class="hljs-comment"># 引入其他ejs文件（注意：2个参数，第一个是路径：相对于当前模板路径中的模板片段包含进来；第二个是传递数据对象。）：%&gt;</span><br><br>&lt;%- include(<span class="hljs-string">&#x27;user/show&#x27;</span>, &#123;user: user&#125;); %&gt;<br></code></pre></td></tr></table></figure>

<p>说明：</p>
<p><strong>注意</strong>：以上语法基本一样，有一样不一样，<code>include</code>需要用<code>partial</code>代替。他们俩用法一模一样。</p>
<p><code>layout</code>功能，需要在引用的页面，比如<code>index.html</code>里面使用<code>&lt;% layout(&#39;layout&#39;) -%&gt;</code>，<strong>注意</strong>：这里<code>&#39;layout&#39;</code>是指<code>layout.html</code>。</p>
<p>还有一个比较重要的功能是<code>block</code>。它是在指定的位置插入自定义内容。类似于<code>angularjs</code>的<code>transclude</code>，<code>angular</code>的<code>&lt;ng-content select=&quot;[xxx]&quot;&gt;&lt;/ng-content&gt;</code>，<code>vue</code>的<code>&lt;slot&gt;&lt;/slot&gt;</code>。</p>
<p><code>slot</code>写法：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html">&lt;%- block(&#x27;head&#x27;).toString() %&gt;<br></code></pre></td></tr></table></figure>

<p><code>block(&#39;head&#39;)</code>，是一个占位标识符，<code>toString</code>是合并所有的插入使用<code>join</code>转成字符串。</p>
<p>使用：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs html">&lt;% block(&#x27;head&#x27;).append(&#x27;<span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/css&quot;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;/append.css&quot;</span> /&gt;</span>&#x27;) %&gt; &lt;% block(&#x27;head&#x27;).prepend(&#x27;<span class="hljs-tag">&lt;<span class="hljs-name">link</span></span><br><span class="hljs-tag">  <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/css&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;/prepend.css&quot;</span></span><br><span class="hljs-tag">/&gt;</span>&#x27;) %&gt;<br></code></pre></td></tr></table></figure>

<p><code>append</code>和<code>prepend</code>是插入的顺序，<code>append</code>总是插槽位置插入在最后，<code>prepend</code>总是插槽位置插入在最前。</p>
<p>我们来验证一下。</p>
<p>现在<code>layout.html</code>的<code>head</code>里面写上</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>  ...<br>  <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/css&quot;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;/style.css&quot;</span> /&gt;</span><br>  &lt;%- block(&#x27;head&#x27;).toString() %&gt;<br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p><code>index.html</code>的结尾写上</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs html">... &lt;% block(&#x27;head&#x27;).append(&#x27;<span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/css&quot;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;/append.css&quot;</span> /&gt;</span>&#x27;) %&gt; &lt;% block(&#x27;head&#x27;).prepend(&#x27;<span class="hljs-tag">&lt;<span class="hljs-name">link</span></span><br><span class="hljs-tag">  <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/css&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;/prepend.css&quot;</span></span><br><span class="hljs-tag">/&gt;</span>&#x27;) %&gt; &lt;% block(&#x27;head&#x27;).prepend(&#x27;<span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/css&quot;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;/prepend2.css&quot;</span> /&gt;</span>&#x27;) %&gt; &lt;% block(&#x27;head&#x27;).append(&#x27;<span class="hljs-tag">&lt;<span class="hljs-name">link</span></span><br><span class="hljs-tag">  <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/css&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;/append2.css&quot;</span></span><br><span class="hljs-tag">/&gt;</span>&#x27;) %&gt;<br></code></pre></td></tr></table></figure>

<p>访问首页<code>http://localhost:3000/</code>看结果。</p>
<p><a target="_blank" rel="noopener" href="https://user-images.githubusercontent.com/6111778/44764409-1ae34400-ab82-11e8-9177-aba90b3d799d.png"><img src="https://user-images.githubusercontent.com/6111778/44764409-1ae34400-ab82-11e8-9177-aba90b3d799d.png" srcset="/blog/img/loading.gif" lazyload alt="7d kp 0rh t 7 i4"></a></p>
<p><strong>注意</strong>：<code>index.html</code>里书写<code>block(&#39;head&#39;).append</code>的位置不影响它显示插槽的位置，只受定义插槽<code>&lt;%- block(&#39;head&#39;).toString() %&gt;</code></p>
<p>还有一个方法<code>replace</code>，没看懂怎么用的，文档里面也没有说明，基本<code>append</code>、<code>prepend</code>、<code>toString</code>就够用了。</p>
<p>总结：<code>toString</code>是定义插槽位置，<code>append</code>、<code>prepend</code>往插槽插入指定的内容。他们主要做什么了，<code>layout</code>载入公共的<code>css</code>、<code>js</code>，如果有的页面有不一样地方，就需要插入当前页面的 js 了，那么一来这个插槽功能就有用，如果使用<code>layout</code>功能插入，就会包含在<code>layout</code>位置，无论是语义还是加载都是不合理的。就有了<code>block</code>的功能，在另一款模板引擎<code>Jade</code>里面也有同样的功能也叫<code>block</code>功能。</p>
<h3 id="静态资源"><a href="#静态资源" class="headerlink" title="静态资源"></a>静态资源</h3><p><code>public</code>文件夹里面内容直接拷贝<code>egg-cnode</code>下的<code>public</code>的静态资源</p>
<p>还需要安装几个依赖：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm i --save loader loader-connect loader-builder<br></code></pre></td></tr></table></figure>

<p>这几个模块是加载 css 和 js 使用，也是<a target="_blank" rel="noopener" href="https://github.com/JacksonTian">@JacksonTian</a> 朴灵大神的作品。</p>
<p>main.ts 配置</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">import</span> &#123; join &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;path&#x27;</span>;<br><br><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> loaderConnect <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;loader-connect&#x27;</span>;<br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">bootstrap</span>(<span class="hljs-params"></span>) &#123;<br>  ...<br>  <span class="hljs-comment">// 根目录 nest-cnode</span><br>  <span class="hljs-keyword">const</span> rootDir = <span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">&#x27;..&#x27;</span>);<br>  <span class="hljs-comment">// 注意：这个要在express.static之前调用，loader2.0之后要使用loader-connect</span><br>  <span class="hljs-comment">// 自动转换less为css</span><br>  <span class="hljs-keyword">if</span> (isDevelopment) &#123;<br>    app.<span class="hljs-title function_">use</span>(loaderConnect.<span class="hljs-title function_">less</span>(rootDir));<br>  &#125;<br>  <span class="hljs-comment">// 所有的静态文件路径都前缀&quot;/public&quot;, 需要使用“挂载”功能</span><br>  app.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;/public&#x27;</span>, express.<span class="hljs-title function_">static</span>(<span class="hljs-title function_">join</span>(rootDir, <span class="hljs-string">&#x27;public&#x27;</span>)));<br>  <span class="hljs-comment">// 官方指定是这个 默认访问根目录</span><br>  <span class="hljs-comment">// app.useStaticAssets(join(__dirname, &#x27;..&#x27;, &#x27;public&#x27;));</span><br>  ...<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>注意</strong>：如果静态文件路径都前缀<code>/public</code>，需要使用<code>use</code>去挂载<code>express.static</code>路径。只有<code>express</code>是这样的</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-title function_">useStaticAssets</span>(<span class="hljs-params">path: <span class="hljs-built_in">string</span>, options: ServeStaticOptions</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">static</span>(path, options));<br>&#125;<br></code></pre></td></tr></table></figure>

<p>它的源码是这样写的，如果这样的，你的静态资源路径就是从根目录开始，如果需要加前缀<code>/public</code>，就需要<code>express</code>提供的<a target="_blank" rel="noopener" href="http://expressjs.jser.us/4x_zh-cn/api.html#app.use">方式</a></p>
<p>测试我们静态资源路径设置是否正常工作</p>
<p>在<code>index.html</code>里面引入<code>public/images/logo.png</code>图片</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs html">...<br><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;/public/images/logo.png&quot;</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;logo&quot;</span> /&gt;</span><br>...<br></code></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://user-images.githubusercontent.com/6111778/44764424-2e8eaa80-ab82-11e8-9a94-44979c2265e6.png"><img src="https://user-images.githubusercontent.com/6111778/44764424-2e8eaa80-ab82-11e8-9a94-44979c2265e6.png" srcset="/blog/img/loading.gif" lazyload alt="l8p0 psc xxuk6 zyea0nvs"></a></p>
<p>如果有问题，请找原因，路径是否正确，设置是否正确，如果都 ok，还是不能访问，可以联系我。</p>
<p>关于<code>loader</code>使用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;!-- style --&gt;<br>&lt;%- <span class="hljs-title class_">Loader</span>(<span class="hljs-string">&#x27;/public/stylesheets/index.min.css&#x27;</span>)<br>.<span class="hljs-title function_">css</span>(<span class="hljs-string">&#x27;/public/libs/bootstrap/css/bootstrap.css&#x27;</span>)<br>.<span class="hljs-title function_">css</span>(<span class="hljs-string">&#x27;/public/stylesheets/common.css&#x27;</span>)<br>.<span class="hljs-title function_">css</span>(<span class="hljs-string">&#x27;/public/stylesheets/style.less&#x27;</span>)<br>.<span class="hljs-title function_">css</span>(<span class="hljs-string">&#x27;/public/stylesheets/responsive.css&#x27;</span>)<br>.<span class="hljs-title function_">css</span>(<span class="hljs-string">&#x27;/public/stylesheets/jquery.atwho.css&#x27;</span>)<br>.<span class="hljs-title function_">css</span>(<span class="hljs-string">&#x27;/public/libs/editor/editor.css&#x27;</span>)<br>.<span class="hljs-title function_">css</span>(<span class="hljs-string">&#x27;/public/libs/webuploader/webuploader.css&#x27;</span>)<br>.<span class="hljs-title function_">css</span>(<span class="hljs-string">&#x27;/public/libs/code-prettify/prettify.css&#x27;</span>)<br>.<span class="hljs-title function_">css</span>(<span class="hljs-string">&#x27;/public/libs/font-awesome/css/font-awesome.css&#x27;</span>)<br>.<span class="hljs-title function_">done</span>(assets, config.<span class="hljs-property">site_static_host</span>, config.<span class="hljs-property">mini_assets</span>)<br>%&gt;<br><br>&lt;!-- scripts --&gt;<br>&lt;%- <span class="hljs-title class_">Loader</span>(<span class="hljs-string">&#x27;/public/index.min.js&#x27;</span>)<br>.<span class="hljs-title function_">js</span>(<span class="hljs-string">&#x27;/public/libs/jquery-2.1.0.js&#x27;</span>)<br>.<span class="hljs-title function_">js</span>(<span class="hljs-string">&#x27;/public/libs/lodash.compat.js&#x27;</span>)<br>.<span class="hljs-title function_">js</span>(<span class="hljs-string">&#x27;/public/libs/jquery-ujs.js&#x27;</span>)<br>.<span class="hljs-title function_">js</span>(<span class="hljs-string">&#x27;/public/libs/bootstrap/js/bootstrap.js&#x27;</span>)<br>.<span class="hljs-title function_">js</span>(<span class="hljs-string">&#x27;/public/libs/jquery.caret.js&#x27;</span>)<br>.<span class="hljs-title function_">js</span>(<span class="hljs-string">&#x27;/public/libs/jquery.atwho.js&#x27;</span>)<br>.<span class="hljs-title function_">js</span>(<span class="hljs-string">&#x27;/public/libs/markdownit.js&#x27;</span>)<br>.<span class="hljs-title function_">js</span>(<span class="hljs-string">&#x27;/public/libs/code-prettify/prettify.js&#x27;</span>)<br>.<span class="hljs-title function_">js</span>(<span class="hljs-string">&#x27;/public/libs/qrcode.js&#x27;</span>)<br>.<span class="hljs-title function_">js</span>(<span class="hljs-string">&#x27;/public/javascripts/main.js&#x27;</span>)<br>.<span class="hljs-title function_">js</span>(<span class="hljs-string">&#x27;/public/javascripts/responsive.js&#x27;</span>)<br>.<span class="hljs-title function_">done</span>(assets, config.<span class="hljs-property">site_static_host</span>, config.<span class="hljs-property">mini_assets</span>)<br>%&gt;<br></code></pre></td></tr></table></figure>

<ul>
<li><code>Loader</code>可以加载<code>.js</code>方法也可以加载<code>.coffee</code>、<code>.es</code>类型的文件，<code>.css</code>方法可以加载<code>.less</code>、<code>.styl</code>文件。</li>
<li><code>Loader(&#39;/public/index.min.js&#39;)</code>是合并后名字</li>
<li><code>.js(&#39;/public/libs/jquery-2.1.0.js&#39;)</code>是加载每一个文件地址</li>
<li><code>.done(assets, config.site_static_host, config.mini_assets)</code>是处理文件，第一个参数合并压缩后的路径（后面讲解），第二个参数静态文件服务器地址，第三个参数是否压缩</li>
</ul>
<p><code>assets</code>从哪里来</p>
<p>在<code>package.json</code>的<code>scripts</code>配置</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    ...<br>    <span class="hljs-attr">&quot;assets&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;loader /views /&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>loader 的写法是：<code>loader &lt;views_dir&gt; &lt;output_dir&gt;</code>。<code>views_dir</code>是模板引擎目录，<code>output_dir</code>是<code>assets.json</code>文件输出的目录，<code>/</code>表示根目录。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm run assets<br></code></pre></td></tr></table></figure>

<p>直接运行会报错，这个问题在<code>egg-node</code>有人提<a target="_blank" rel="noopener" href="https://github.com/cnodejs/egg-cnode/issues/129">issues</a></p>
<p><a target="_blank" rel="noopener" href="https://user-images.githubusercontent.com/6111778/44764434-3b130300-ab82-11e8-9322-088c7688949a.png"><img src="https://user-images.githubusercontent.com/6111778/44764434-3b130300-ab82-11e8-9322-088c7688949a.png" srcset="/blog/img/loading.gif" lazyload alt="z90d4zb w t t26e_2 l"></a></p>
<p>主要是静态资源<code>css</code>引用的背景图片和字体地址有错误，需要修改哪些文件：</p>
<p>错误信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">no such file or directory, open <span class="hljs-string">&#x27;E:\github\nest-cnode\E:\public\img\glyphicons-halflings.png&#x27;</span><br></code></pre></td></tr></table></figure>

<p>谁引用了它 <code>Error! File:/public/libs/bootstrap/css/bootstrap.css</code></p>
<p>/public/libs/bootstrap/css/bootstrap.css</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs css">...<br><span class="hljs-selector-attr">[class^=<span class="hljs-string">&quot;icon-&quot;</span>]</span>,<br><span class="hljs-selector-attr">[class*=<span class="hljs-string">&quot; icon-&quot;</span>]</span> &#123;<br>    <span class="hljs-attribute">display</span>: inline-block;<br>    <span class="hljs-attribute">width</span>: <span class="hljs-number">14px</span>;<br>    <span class="hljs-attribute">height</span>: <span class="hljs-number">14px</span>;<br>    <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">1px</span>;<br>    *<span class="hljs-attribute">margin-right</span>: .<span class="hljs-number">3em</span>;<br>    <span class="hljs-attribute">line-height</span>: <span class="hljs-number">14px</span>;<br>    <span class="hljs-attribute">vertical-align</span>: text-top;<br>    <span class="hljs-attribute">background-image</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">&quot;/public/libs/bootstrap/img/glyphicons-halflings.png&quot;</span>);<br>    <span class="hljs-attribute">background-position</span>: <span class="hljs-number">14px</span> <span class="hljs-number">14px</span>;<br>    <span class="hljs-attribute">background-repeat</span>: no-repeat;<br>&#125;<br>...<br><br><span class="hljs-selector-class">.icon-white</span>,<br><span class="hljs-selector-class">.nav-pills</span> &gt; <span class="hljs-selector-class">.active</span> &gt; <span class="hljs-selector-tag">a</span> &gt; <span class="hljs-selector-attr">[class^=<span class="hljs-string">&quot;icon-&quot;</span>]</span>,<br><span class="hljs-selector-class">.nav-pills</span> &gt; <span class="hljs-selector-class">.active</span> &gt; <span class="hljs-selector-tag">a</span> &gt; <span class="hljs-selector-attr">[class*=<span class="hljs-string">&quot; icon-&quot;</span>]</span>,<br><span class="hljs-selector-class">.nav-list</span> &gt; <span class="hljs-selector-class">.active</span> &gt; <span class="hljs-selector-tag">a</span> &gt; <span class="hljs-selector-attr">[class^=<span class="hljs-string">&quot;icon-&quot;</span>]</span>,<br><span class="hljs-selector-class">.nav-list</span> &gt; <span class="hljs-selector-class">.active</span> &gt; <span class="hljs-selector-tag">a</span> &gt; <span class="hljs-selector-attr">[class*=<span class="hljs-string">&quot; icon-&quot;</span>]</span>,<br><span class="hljs-selector-class">.navbar-inverse</span> <span class="hljs-selector-class">.nav</span> &gt; <span class="hljs-selector-class">.active</span> &gt; <span class="hljs-selector-tag">a</span> &gt; <span class="hljs-selector-attr">[class^=<span class="hljs-string">&quot;icon-&quot;</span>]</span>,<br><span class="hljs-selector-class">.navbar-inverse</span> <span class="hljs-selector-class">.nav</span> &gt; <span class="hljs-selector-class">.active</span> &gt; <span class="hljs-selector-tag">a</span> &gt; <span class="hljs-selector-attr">[class*=<span class="hljs-string">&quot; icon-&quot;</span>]</span>,<br><span class="hljs-selector-class">.dropdown-menu</span> &gt; <span class="hljs-selector-tag">li</span> &gt; <span class="hljs-selector-tag">a</span><span class="hljs-selector-pseudo">:hover</span> &gt; <span class="hljs-selector-attr">[class^=<span class="hljs-string">&quot;icon-&quot;</span>]</span>,<br><span class="hljs-selector-class">.dropdown-menu</span> &gt; <span class="hljs-selector-tag">li</span> &gt; <span class="hljs-selector-tag">a</span><span class="hljs-selector-pseudo">:focus</span> &gt; <span class="hljs-selector-attr">[class^=<span class="hljs-string">&quot;icon-&quot;</span>]</span>,<br><span class="hljs-selector-class">.dropdown-menu</span> &gt; <span class="hljs-selector-tag">li</span> &gt; <span class="hljs-selector-tag">a</span><span class="hljs-selector-pseudo">:hover</span> &gt; <span class="hljs-selector-attr">[class*=<span class="hljs-string">&quot; icon-&quot;</span>]</span>,<br><span class="hljs-selector-class">.dropdown-menu</span> &gt; <span class="hljs-selector-tag">li</span> &gt; <span class="hljs-selector-tag">a</span><span class="hljs-selector-pseudo">:focus</span> &gt; <span class="hljs-selector-attr">[class*=<span class="hljs-string">&quot; icon-&quot;</span>]</span>,<br><span class="hljs-selector-class">.dropdown-menu</span> &gt; <span class="hljs-selector-class">.active</span> &gt; <span class="hljs-selector-tag">a</span> &gt; <span class="hljs-selector-attr">[class^=<span class="hljs-string">&quot;icon-&quot;</span>]</span>,<br><span class="hljs-selector-class">.dropdown-menu</span> &gt; <span class="hljs-selector-class">.active</span> &gt; <span class="hljs-selector-tag">a</span> &gt; <span class="hljs-selector-attr">[class*=<span class="hljs-string">&quot; icon-&quot;</span>]</span>,<br><span class="hljs-selector-class">.dropdown-submenu</span><span class="hljs-selector-pseudo">:hover</span> &gt; <span class="hljs-selector-tag">a</span> &gt; <span class="hljs-selector-attr">[class^=<span class="hljs-string">&quot;icon-&quot;</span>]</span>,<br><span class="hljs-selector-class">.dropdown-submenu</span><span class="hljs-selector-pseudo">:focus</span> &gt; <span class="hljs-selector-tag">a</span> &gt; <span class="hljs-selector-attr">[class^=<span class="hljs-string">&quot;icon-&quot;</span>]</span>,<br><span class="hljs-selector-class">.dropdown-submenu</span><span class="hljs-selector-pseudo">:hover</span> &gt; <span class="hljs-selector-tag">a</span> &gt; <span class="hljs-selector-attr">[class*=<span class="hljs-string">&quot; icon-&quot;</span>]</span>,<br><span class="hljs-selector-class">.dropdown-submenu</span><span class="hljs-selector-pseudo">:focus</span> &gt; <span class="hljs-selector-tag">a</span> &gt; <span class="hljs-selector-attr">[class*=<span class="hljs-string">&quot; icon-&quot;</span>]</span> &#123;<br>    <span class="hljs-attribute">background-image</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">&quot;/public/libs/bootstrap/img/glyphicons-halflings-white.png&quot;</span>);<br>&#125;<br>...<br></code></pre></td></tr></table></figure>

<p>大约<code>2296</code>和<code>2320</code>行位置，你可以用查找搜索<code>glyphicons-halflings.png</code>，默认是<code>background-image: url(&quot;../img/glyphicons-halflings.png&quot;);</code>, 替换为上面写法。</p>
<p>/public/stylesheets/style.less</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs css">...<br><span class="hljs-selector-class">.navbar</span> <span class="hljs-selector-class">.search-query</span> &#123;<br>  -webkit-<span class="hljs-attribute">box-shadow</span>: none;<br>  -moz-<span class="hljs-attribute">box-shadow</span>: none;<br>  <span class="hljs-attribute">background</span>: <span class="hljs-number">#888</span> <span class="hljs-built_in">url</span>(<span class="hljs-string">&#x27;/public/images/search.png&#x27;</span>) no-repeat <span class="hljs-number">4px</span> <span class="hljs-number">4px</span>;<br>  <span class="hljs-attribute">padding</span>: <span class="hljs-number">3px</span> <span class="hljs-number">5px</span> <span class="hljs-number">3px</span> <span class="hljs-number">22px</span>;<br>  <span class="hljs-attribute">color</span>: <span class="hljs-number">#666</span>;<br>  <span class="hljs-attribute">border</span>: <span class="hljs-number">0px</span>;<br>  <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">2px</span>;<br><br>  &amp;<span class="hljs-selector-pseudo">:hover</span> &#123;<br>    <span class="hljs-attribute">background-color</span>: white;<br>  &#125;<br>  <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.5s</span>;<br><br>  &amp;<span class="hljs-selector-pseudo">:focus</span>, &amp;<span class="hljs-selector-class">.focused</span> &#123;<br>    <span class="hljs-attribute">background-color</span>: white;<br>  &#125;<br>&#125;<br>...<br></code></pre></td></tr></table></figure>

<p>大约<code>850</code>行位置</p>
<blockquote>
<p>简单解释就是换成相对于根目录的路径，后面错误就类似。</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://user-images.githubusercontent.com/6111778/44764444-45350180-ab82-11e8-9f65-a6b319a11fec.png"><img src="https://user-images.githubusercontent.com/6111778/44764444-45350180-ab82-11e8-9f65-a6b319a11fec.png" srcset="/blog/img/loading.gif" lazyload alt="45 7el q a5ph tf g84r 0"></a></p>
<p>打包成功以后会输出一个<code>assets.json</code>在根目录。<code>assets</code>指的就是这个 json 文件，后面我们会讲如果把它们关联起来。</p>
<h2 id="静态模板"><a href="#静态模板" class="headerlink" title="静态模板"></a>静态模板</h2><p>我们上面已经配置好了模板引擎和静态资源，我们先要去扩展他们，先让页面好看点。</p>
<p>打开<a target="_blank" rel="noopener" href="https://cnodejs.org/">cnode</a>，然后右键查看源代码。把里面内容复制，拷贝到<code>index.html</code>里去。</p>
<p>访问<code>http://localhost:3000/</code>就可以瞬间看到和<code>cnode</code>首页一样的内容了。</p>
<p><a target="_blank" rel="noopener" href="https://user-images.githubusercontent.com/6111778/44771917-006b9380-ab9f-11e8-9122-ed902df536a7.png"><img src="https://user-images.githubusercontent.com/6111778/44771917-006b9380-ab9f-11e8-9122-ed902df536a7.png" srcset="/blog/img/loading.gif" lazyload alt="1"></a></p>
<p>有模板以后，我们需要改造他们:</p>
<ol>
<li>使用 HTML5 推荐的<code>DOCTYPE</code>申明</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;zh-CN&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure>

<ol>
<li>拆分<code>body</code>标签之外到<code>layout.html</code></li>
</ol>
<p>浏览<code>cnode</code>所有页面<code>head</code>内容，除了<code>title</code>标签内容其他一样</p>
<p>基础<code>layout.html</code>模板</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;zh-CN&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>我是layout模板<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;viewport&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;width=device-width, initial-scale=1.0&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">&quot;X-UA-Compatible&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;ie=edge&quot;</span> /&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><br>  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    &lt;%- body -%&gt;<br>  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>把<code>index.html</code>里的<code>head</code>标签内容都移动到<code>layout.html</code>的<code>head</code>，同名的直接替换。</p>
<p>替换之后的<code>layout.html</code>模板</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;zh-CN&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>CNode：Node.js专业中文社区<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;viewport&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;width=device-width, initial-scale=1.0&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">&quot;X-UA-Compatible&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;ie=edge&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;description&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;CNode：Node.js专业中文社区&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;viewport&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;width=device-width, initial-scale=1&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;keywords&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;nodejs, node, express, connect, socket.io&quot;</span> /&gt;</span><br>    <span class="hljs-comment">&lt;!-- see http://smerity.com/articles/2013/where_did_all_the_http_referrers_go.html --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;referrer&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;always&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;author&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;EDP@TaoBao&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;wb:webmaster&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;617be6bd946c6b96&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;_csrf&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;csrf-param&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;vlUgGvkx-SgmuzendL9gAP3DHXVS3834IpC4&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;csrf-token&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">title</span>=<span class="hljs-string">&quot;RSS&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;application/rss+xml&quot;</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">&quot;alternate&quot;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;/rss&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">&quot;icon&quot;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;//o4j806krb.qnssl.com/public/images/cnode_icon_32.png&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;image/x-icon&quot;</span> /&gt;</span><br>    <span class="hljs-comment">&lt;!-- style --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">&quot;stylesheet&quot;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;//o4j806krb.qnssl.com/public/stylesheets/index.min.23a5b1ca.min.css&quot;</span> <span class="hljs-attr">media</span>=<span class="hljs-string">&quot;all&quot;</span> /&gt;</span><br>    &lt;%- block(&#x27;styles&#x27;).toString() %&gt;<br>  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><br>  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    &lt;%- body -%&gt;<br>    <span class="hljs-comment">&lt;!-- scripts --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;//o4j806krb.qnssl.com/public/index.min.f7c13f64.min.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br>    &lt;%- block(&#x27;scripts&#x27;).toString() %&gt;<br>  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>style 放头部，script 放底部，并且利用模板引擎做了 2 个插槽，一个<code>styles</code>和<code>scripts</code></p>
</blockquote>
<ol>
<li>拆分<code>body</code>标签之内到<code>layout.html</code></li>
</ol>
<p>浏览<code>cnode</code>所有页面内容，发现头部黑色部分和底部白色部分都是一样的。那么我们需要把它们提取出来。</p>
<p><code>cnode</code>模板</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs html">...<br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;navbar&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;main&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;backtotop&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;footer&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;sidebar-mask&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br></code></pre></td></tr></table></figure>

<ul>
<li><code>backtotop</code>和<code>sidebar-mask</code>是 2 个和 js 相关的功能标签，直接保留它们。</li>
<li>class<code>navbar</code>对应到<code>header</code>标签</li>
<li>id<code>main</code>对应到<code>main</code>标签</li>
<li>id<code>footer</code>对应到<code>footer</code>标签</li>
<li>并且把除了<code>main</code>标签之外内容都放到对应的标签里面</li>
<li>模板里面关于网站访问统计的代码，我们就不需要了，直接去掉了。</li>
</ul>
<p>改版后的<code>layout.html</code>模板</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs html">...<br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">header</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;navbar&quot;</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">main</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;main&quot;</span>&gt;</span>&lt;%- body -%&gt;<span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">footer</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;footer&quot;</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">footer</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;backtotop&quot;</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;sidebar-mask&quot;</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>  ...<br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>把剩下<code>index.html</code>里面的<code>styles</code>和<code>scripts</code>使用</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html">&lt;% block(&#x27;styles&#x27;).append(``) %&gt; &lt;% block(&#x27;scripts&#x27;).append(``) %&gt;<br></code></pre></td></tr></table></figure>

<p>最好是写成<code>script</code>和<code>style</code>文件。</p>
<ol>
<li>拆分<code>main</code>标签之内到<code>sidebar.html</code></li>
</ol>
<p>浏览<code>cnode</code>所有主体内容，发现右边侧边栏除了<code>api</code>页面没有，注册登录找回密码，是另外一种模板内容，其他页面都是一样。</p>
<p>当前<code>index.html</code>模板</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs html">... &lt;% layout(&#x27;layout&#x27;) -%&gt;<br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;sidebar&quot;</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;content&quot;</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>...<br></code></pre></td></tr></table></figure>

<p>替换后的<code>index.html</code>模板</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs html">... &lt;% layout(&#x27;layout&#x27;) -%&gt; &lt;%- partial(&#x27;./sidebar.html&#x27;) %&gt;<br><span class="hljs-tag">&lt;<span class="hljs-name">article</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;content&quot;</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">article</span>&gt;</span><br>...<br></code></pre></td></tr></table></figure>

<p>这样我们首页模板已经完成了。</p>
<h2 id="系统配置和应用配置"><a href="#系统配置和应用配置" class="headerlink" title="系统配置和应用配置"></a>系统配置和应用配置</h2><p>系统配置是系统级别的配置，如数据配置，端口，host，签名，加密 keys 等</p>
<p>应用配置是应用级别的配置，如网站标题，关键字，描述等</p>
<p>系统配置使用<code>.env</code>文件，大部分语言都有这个文件，我们需要用<code>dotenv</code>读取它们里面的内容。</p>
<p><code>dotenv</code>支持的<code>.env</code>语法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 测试单行注释</span><br>KEY=<br>KEY=<span class="hljs-string">&#x27;&#x27;</span><br>KEY=value<br>KEY=<span class="hljs-string">&#x27;value&#x27;</span><br>KEY=&#123;<span class="hljs-string">&quot;foo&quot;</span>: <span class="hljs-string">&quot;bar&quot;</span>&#125;<br>KEY=<span class="hljs-string">&#x27;&#123;&quot;foo&quot;: &quot;bar&quot;&#125;&#x27;</span><br>KEY=[<span class="hljs-string">&quot;foo&quot;</span>, <span class="hljs-string">&quot;bar&quot;</span>]<br>KEY=<span class="hljs-string">&#x27;[&quot;foo&quot;, &quot;bar&quot;]&#x27;</span><br>KEY=<span class="hljs-literal">true</span><br>KEY=0<br>KEY=<span class="hljs-string">&#x27;0&#x27;</span><br>KEY=null<br>KEY=<span class="hljs-string">&#x27;null&#x27;</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p><code>.env</code> 语法非常简单，<code>key</code> 只能是字符串（ps：最好大写带下划线分割单词），<code>value</code> 可以是空、字符串、数字、布尔值、字典对象、数组，<code>dotenv</code>最后获取也是字符串，需要你做相应处理。</p>
</blockquote>
<p><strong>注意</strong>：<code>.env</code> 文件主要的作用是存储环境变量，也就是会随着环境变化的东西，比如数据库的用户名、密码、静态文件的存储路径之类的，因为这些信息应该是和环境绑定的，不应该随代码的更新而变化，所以一般不会把 <code>.env</code> 文件放到版本控制中；</p>
<p>我们需要在<code>.gitignore</code>文件中排除它们：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># dotenv environment variables file</span><br>*.<span class="hljs-built_in">env</span><br>.<span class="hljs-built_in">env</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p><code>.env</code>配置文件，关于隐私配置，可以看<code>README.md</code>说明。<code>.env</code>文件模板</p>
</blockquote>
<h3 id="ConfigModule（配置模块）"><a href="#ConfigModule（配置模块）" class="headerlink" title="ConfigModule（配置模块）"></a>ConfigModule（配置模块）</h3><p>当我们使用<code>process global</code>对象时，很难保持测试的干净，因为测试类可能直接使用它。另一种方法是创建一个抽象层，即一个<code>ConfigModule</code>，它公开了一个装载配置变量的<code>ConfigService</code>。</p>
<p>关于配置模块，官网有详细的<a target="_blank" rel="noopener" href="https://docs.nestjs.com/techniques/configuration">栗子</a>，这里也是基本类似。这里说一些关键点：</p>
<ol>
<li>需要用到依赖：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm i --save dotenv  // 用来解析`.<span class="hljs-built_in">env</span>`配置文件<br><br>npm install --save joi  // 用来验证`.<span class="hljs-built_in">env</span>`配置文件<br>npm install --save-dev @types/joi<br></code></pre></td></tr></table></figure>

<ol>
<li>需要创建<code>.env</code>配置文件</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">development.env  开发配置<br>production.env  生产配置<br>test.env  测试配置<br>.env.tmp  .<span class="hljs-built_in">env</span>配置文件模板<br></code></pre></td></tr></table></figure>

<ol>
<li>怎么设置<code>NODE_ENV</code></li>
</ol>
<p><code>windows</code>和<code>mac</code>不一样</p>
<p>windows 设置</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-attr">&quot;scripts&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;start:dev&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;set NODE_ENV=development&amp;&amp; nodemon&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;start:prod&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;set NODE_ENV=production&amp;&amp; node dist/main.js&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;test&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;set NODE_ENV=test&amp;&amp; jest&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>mac 设置</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-attr">&quot;scripts&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;start:dev&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;export NODE_ENV=development&amp;&amp; nodemon&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;start:prod&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;export NODE_ENV=production&amp;&amp; node dist/main.js&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;test&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;export NODE_ENV=test&amp;&amp; jest&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>你会发现这个很麻烦，有没有什么方便地方了，可以通过<code>cross-env</code>来解决问题，它就是解决跨平台设置 NODE_ENV 的问题，默认情况下，windows 不支持 NODE_ENV=development 的设置方式，加上 cross-env 就可以跨平台。</p>
<p>安装<code>cross-env</code>依赖</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm i --save-dev cross-env<br></code></pre></td></tr></table></figure>

<p><code>cross-env</code>设置</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-attr">&quot;scripts&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;start:dev&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;cross-env NODE_ENV=development nodemon&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;start:prod&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;cross-env NODE_ENV=production node dist/main.js&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;test&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;cross-env NODE_ENV=test jest&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<ol>
<li>创建<code>config</code>模块:</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ nest generate module config<br>OR<br>$ nest g mo config<br></code></pre></td></tr></table></figure>

<ul>
<li>创建全局模块，全局模块不需要在注入到该模块，就能使用该模块导出的服务。</li>
<li>创建动态模块，动态模块可以创建可定制的模块，动态做依赖注入关系。</li>
</ul>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Module</span>, <span class="hljs-title class_">DynamicModule</span>, <span class="hljs-title class_">Global</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/common&#x27;</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">ConfigService</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./config.service&#x27;</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">ConfigurationToken</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./config.constants&#x27;</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">EnvConfig</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./config.interface&#x27;</span><br><br><span class="hljs-meta">@Global</span>()<br><span class="hljs-meta">@Module</span>(&#123;&#125;)<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigModule</span> &#123;<br>  <span class="hljs-keyword">static</span> forRoot&lt;T = <span class="hljs-title class_">EnvConfig</span>&gt;(filePath?: <span class="hljs-built_in">string</span>, validator?: <span class="hljs-function">(<span class="hljs-params">envConfig: T</span>) =&gt;</span> T): <span class="hljs-title class_">DynamicModule</span> &#123;<br>    <span class="hljs-keyword">return</span> &#123;<br>      <span class="hljs-attr">module</span>: <span class="hljs-title class_">ConfigModule</span>,<br>      <span class="hljs-attr">providers</span>: [<br>        &#123;<br>          <span class="hljs-attr">provide</span>: <span class="hljs-title class_">ConfigService</span>,<br>          <span class="hljs-attr">useValue</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConfigService</span>(filePath || <span class="hljs-string">`<span class="hljs-subst">$&#123;process.env.NODE_ENV || <span class="hljs-string">&#x27;development&#x27;</span>&#125;</span>.env`</span>, validator),<br>        &#125;,<br>        &#123;<br>          <span class="hljs-attr">provide</span>: <span class="hljs-title class_">ConfigToken</span>,<br>          <span class="hljs-attr">useFactory</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConfigService</span>(filePath || <span class="hljs-string">`<span class="hljs-subst">$&#123;process.env.NODE_ENV || <span class="hljs-string">&#x27;development&#x27;</span>&#125;</span>.env`</span>, validator),<br>        &#125;,<br>      ],<br>      <span class="hljs-attr">exports</span>: [<span class="hljs-title class_">ConfigService</span>, <span class="hljs-title class_">ConfigToken</span>],<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>&lt;T = EnvConfig&gt;</code>是一种什么写法，<code>T</code>是一个泛型，<code>EnvConfig</code>是一个默认值，如果使用者不传递就是默认类型，作用类似于函数默认值。</p>
<p>默认用 2 种注册服务的写法，一种是类，一种是工厂。前面基础篇已经提及了，后面讲怎么使用它们。</p>
<ol>
<li>创建<code>config</code>服务:</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ nest generate service config/config<br>OR<br>$ nest g s config/config<br></code></pre></td></tr></table></figure>

<p>首先,让我们写<code>ConfigService</code>类。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;fs&#x27;</span><br><span class="hljs-keyword">import</span> &#123; parse &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;dotenv&#x27;</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">EnvConfig</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./config.interface&#x27;</span><br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigService</span>&lt;T = <span class="hljs-title class_">EnvConfig</span>&gt; &#123;<br>  <span class="hljs-comment">// 系统配置</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">envConfig</span>: T<br><br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">filePath: <span class="hljs-built_in">string</span>, validator?: (envConfig: T) =&gt; T</span>) &#123;<br>    <span class="hljs-comment">// 解析配置文件</span><br>    <span class="hljs-keyword">const</span> <span class="hljs-attr">configFile</span>: T = <span class="hljs-title function_">parse</span>(fs.<span class="hljs-title function_">readFileSync</span>(filePath))<br>    <span class="hljs-comment">// 验证配置参数</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> validator === <span class="hljs-string">&#x27;function&#x27;</span>) &#123;<br>      <span class="hljs-keyword">const</span> <span class="hljs-attr">envConfig</span>: T = <span class="hljs-title function_">validator</span>(configFile)<br>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> envConfig !== <span class="hljs-string">&#x27;object&#x27;</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;validator return value is not object&#x27;</span>)<br>      &#125;<br>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">envConfig</span> = envConfig<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">envConfig</span> = configFile<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 获取配置</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> <span class="hljs-variable">key</span></span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> <span class="hljs-variable">defaultVal</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-title function_">get</span>(<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>, defaultVal?: <span class="hljs-built_in">any</span>): <span class="hljs-built_in">string</span> &#123;<br>    <span class="hljs-keyword">return</span> process.<span class="hljs-property">env</span>[key] || <span class="hljs-variable language_">this</span>.<span class="hljs-property">envConfig</span>[key] || defaultVal<br>  &#125;<br><br>  <span class="hljs-comment">/** 获取系统配置 */</span><br>  <span class="hljs-title function_">getKeys</span>(<span class="hljs-attr">keys</span>: <span class="hljs-built_in">string</span>[]): <span class="hljs-built_in">any</span> &#123;<br>    <span class="hljs-keyword">return</span> keys.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">obj, key: <span class="hljs-built_in">string</span></span>) =&gt;</span> &#123;<br>      obj[key] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">get</span>(key)<br>      <span class="hljs-keyword">return</span> obj<br>    &#125;, &#123;&#125;)<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 获取数字</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> <span class="hljs-variable">key</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-title function_">getNumber</span>(<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">number</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Number</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">get</span>(key))<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 获取布尔值</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> <span class="hljs-variable">key</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-title function_">getBoolean</span>(<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">boolean</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Boolean</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">get</span>(key))<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 获取字典对象和数组</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> <span class="hljs-variable">key</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-title function_">getJson</span>(<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>): &#123; [<span class="hljs-attr">prop</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">any</span> &#125; | <span class="hljs-literal">null</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">get</span>(key))<br>    &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span><br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 检查一个key是否存在</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> <span class="hljs-variable">key</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-title function_">has</span>(<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">boolean</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">get</span>(key) !== <span class="hljs-literal">undefined</span><br>  &#125;<br><br>  <span class="hljs-comment">/** 开发模式 */</span><br>  <span class="hljs-keyword">get</span> <span class="hljs-title function_">isDevelopment</span>(): <span class="hljs-built_in">boolean</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;NODE_ENV&#x27;</span>) === <span class="hljs-string">&#x27;development&#x27;</span><br>  &#125;<br>  <span class="hljs-comment">/** 生产模式 */</span><br>  <span class="hljs-keyword">get</span> <span class="hljs-title function_">isProduction</span>(): <span class="hljs-built_in">boolean</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;NODE_ENV&#x27;</span>) === <span class="hljs-string">&#x27;production&#x27;</span><br>  &#125;<br>  <span class="hljs-comment">/** 测试模式 */</span><br>  <span class="hljs-keyword">get</span> <span class="hljs-title function_">isTest</span>(): <span class="hljs-built_in">boolean</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;NODE_ENV&#x27;</span>) === <span class="hljs-string">&#x27;test&#x27;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>解析数据都存在<code>envConfig</code>里，封装一些获取并转义<code>value</code>的方法。</p>
<p>传递 2 个参数，一个是<code>.env</code>文件路径，一个是验证器，配合<code>Joi</code>使用，<code>nest</code>官网文档把配置服务和验证字段放在一起，我觉得这样不是很科学。<br>我在<code>.env</code>加一个配置就需要去修改<code>ConfigService</code>类，它本来就是不需要修改的，我就把验证部分提取出来，这样就不用关心验证问题了。<code>ConfigService</code>只关心取值问题。</p>
<p>上面模块里面还有一个<code>ConfigToken</code>服务，它是做什么的了，它叫做令牌。</p>
<ol>
<li>我们创建一个常量文件：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ <span class="hljs-built_in">touch</span> src/config/config.constants.ts<br>OR<br>编辑器新建文件config.constants.ts<br></code></pre></td></tr></table></figure>

<p>里面写入常量<code>configToken</code>并导出</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">export</span> const ConfigToken = <span class="hljs-string">&#x27;ConfigToken&#x27;</span>;<br></code></pre></td></tr></table></figure>

<p><code>ConfigModule</code>的<code>configToken</code>也是它。</p>
<ol>
<li>我们创建一个装饰器文件：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ <span class="hljs-built_in">touch</span> src/config/config.decorators.ts<br>OR<br>编辑器新建文件config.decorators.ts<br>import &#123; Inject &#125; from <span class="hljs-string">&#x27;@nestjs/common&#x27;</span>;<br><br>import &#123; ConfigToken &#125; from <span class="hljs-string">&#x27;./config.constants&#x27;</span>;<br><br><span class="hljs-built_in">export</span> const InjectConfig = () =&gt; Inject(ConfigToken);<br></code></pre></td></tr></table></figure>

<p>使用<code>Inject</code>依赖注入器注入令牌对应的服务</p>
<p><code>InjectConfig</code>是一个装饰器。装饰器在<code>nest</code>、<code>angular</code>有大量实践案例，各种装饰器，让你眼花缭乱。</p>
<p>简单科普一下装饰器：</p>
<p>写法：（总共四种：类，属性，方法，方法参数）</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">declare</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">ClassDecorator</span> = &lt;<span class="hljs-title class_">TFunction</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Function</span>&gt;<span class="hljs-function">(<span class="hljs-params">target: TFunction</span>) =&gt;</span> <span class="hljs-title class_">TFunction</span> | <span class="hljs-built_in">void</span><br><br><span class="hljs-keyword">declare</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">PropertyDecorator</span> = <span class="hljs-function">(<span class="hljs-params">target: <span class="hljs-built_in">Object</span>, propertyKey: <span class="hljs-built_in">string</span> | <span class="hljs-built_in">symbol</span></span>) =&gt;</span> <span class="hljs-built_in">void</span><br><br><span class="hljs-keyword">declare</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">MethodDecorator</span> = &lt;T&gt;<span class="hljs-function">(<span class="hljs-params"></span></span><br><span class="hljs-params"><span class="hljs-function">  target: <span class="hljs-built_in">Object</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">  propertyKey: <span class="hljs-built_in">string</span> | <span class="hljs-built_in">symbol</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">  descriptor: TypedPropertyDescriptor&lt;T&gt;</span></span><br><span class="hljs-params"><span class="hljs-function"></span>) =&gt;</span> <span class="hljs-title class_">TypedPropertyDescriptor</span>&lt;T&gt; | <span class="hljs-built_in">void</span><br><br><span class="hljs-keyword">declare</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">ParameterDecorator</span> = <span class="hljs-function">(<span class="hljs-params">target: <span class="hljs-built_in">Object</span>, propertyKey: <span class="hljs-built_in">string</span> | <span class="hljs-built_in">symbol</span>, parameterIndex: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">void</span><br></code></pre></td></tr></table></figure>

<p>执行顺序：</p>
<ul>
<li>类装饰器总是最后执行。</li>
<li>有多个方法参数装饰器时：从最后一个参数依次向前执行。</li>
<li>方法参数装饰器中参数装饰器先执行，方法参数装饰器执行完以后，方法装饰器执。</li>
<li>方法和属性装饰器，谁在前面谁先执行。（ps：方法参数属于方法一部分，参数会一直紧紧挨着方法执行。）</li>
</ul>
<ol>
<li>如何使用<code>config</code></li>
</ol>
<p>2 种方式：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-comment">// 装饰器依赖注入</span><br><span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span><br><span class="hljs-params">    <span class="hljs-meta">@InjectConfig</span>() <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> config: ConfigService&lt;EnvConfig&gt;,</span><br><span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;name&#x27;</span>);<br>&#125;<br><span class="hljs-comment">// 普通依赖注入</span><br><span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span><br><span class="hljs-params">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> config: ConfigService&lt;EnvConfig&gt;,</span><br><span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;name&#x27;</span>);<br>&#125;<br><span class="hljs-comment">// 通过app实例取</span><br><span class="hljs-keyword">const</span> <span class="hljs-attr">config</span>: <span class="hljs-title class_">ConfigService</span>&lt;<span class="hljs-title class_">EnvConfig</span>&gt; = app.<span class="hljs-title function_">get</span>(<span class="hljs-title class_">ConfigService</span>);<br><br>...<br>  <span class="hljs-keyword">if</span> (config.<span class="hljs-property">isDevelopment</span>) &#123;<br>    app.<span class="hljs-title function_">use</span>(loaderConnect.<span class="hljs-title function_">less</span>(rootDir));<br>  &#125;<br>...<br><span class="hljs-keyword">await</span> app.<span class="hljs-title function_">listen</span>(config.<span class="hljs-title function_">getNumber</span>(<span class="hljs-string">&#x27;PORT&#x27;</span>));<br></code></pre></td></tr></table></figure>

<p>普通依赖注入就够玩了，这里用装饰器依赖注入有些画蛇添足，只是说明装饰器和注入器注入令牌用法。<br>通过 app 实例取，一般用于系统启动初始化配置，后面还要其他的获取方式，用到在介绍。</p>
<h3 id="Config（应用配置）"><a href="#Config（应用配置）" class="headerlink" title="Config（应用配置）"></a>Config（应用配置）</h3><p>应用配置对比系统配置就没有这么麻烦了，大多数数据都可以写死就行了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ <span class="hljs-built_in">touch</span> src/core/constants/config.constants.ts<br>OR<br>编辑器新建文件config.constants.ts<br></code></pre></td></tr></table></figure>

<p>参考<code>cnode-egg</code>的<code>config/config.default.js</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">Config</span> = &#123;<br>  <span class="hljs-comment">// 网站名字、标题</span><br>  <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;CNode技术社区&#x27;</span>,<br>  <span class="hljs-comment">// 网站关键词</span><br>  <span class="hljs-attr">keywords</span>: <span class="hljs-string">&#x27;nodejs, node, express, connect, socket.io&#x27;</span>,<br>  <span class="hljs-comment">// 网站描述</span><br>  <span class="hljs-attr">description</span>: <span class="hljs-string">&#x27;CNode：Node.js专业中文社区&#x27;</span>,<br>  <span class="hljs-comment">// logo</span><br>  <span class="hljs-attr">logo</span>: <span class="hljs-string">&#x27;/public/images/cnodejs_light.svg&#x27;</span>,<br>  <span class="hljs-comment">// icon</span><br>  <span class="hljs-attr">icon</span>: <span class="hljs-string">&#x27;/public/images/cnode_icon_32.png&#x27;</span>,<br>  <span class="hljs-comment">// 版块</span><br>  <span class="hljs-attr">tabs</span>: [<br>    [<span class="hljs-string">&#x27;all&#x27;</span>, <span class="hljs-string">&#x27;全部&#x27;</span>],<br>    [<span class="hljs-string">&#x27;good&#x27;</span>, <span class="hljs-string">&#x27;精华&#x27;</span>],<br>    [<span class="hljs-string">&#x27;share&#x27;</span>, <span class="hljs-string">&#x27;分享&#x27;</span>],<br>    [<span class="hljs-string">&#x27;ask&#x27;</span>, <span class="hljs-string">&#x27;问答&#x27;</span>],<br>    [<span class="hljs-string">&#x27;job&#x27;</span>, <span class="hljs-string">&#x27;招聘&#x27;</span>],<br>    [<span class="hljs-string">&#x27;test&#x27;</span>, <span class="hljs-string">&#x27;测试&#x27;</span>],<br>  ],<br>  <span class="hljs-comment">// RSS配置</span><br>  <span class="hljs-attr">rss</span>: &#123;<br>    <span class="hljs-attr">title</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">description</span>,<br>    <span class="hljs-attr">link</span>: <span class="hljs-string">&#x27;/&#x27;</span>,<br>    <span class="hljs-attr">language</span>: <span class="hljs-string">&#x27;zh-cn&#x27;</span>,<br>    <span class="hljs-attr">description</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">description</span>,<br>    <span class="hljs-comment">// 最多获取的RSS Item数量</span><br>    <span class="hljs-attr">max_rss_items</span>: <span class="hljs-number">50</span>,<br>  &#125;,<br>  <span class="hljs-comment">// 帖子配置</span><br>  <span class="hljs-attr">topic</span>: &#123;<br>    <span class="hljs-comment">// 列表分页20</span><br>    <span class="hljs-attr">list_count</span>: <span class="hljs-number">20</span>,<br>    <span class="hljs-comment">// 每天每用户限额计数10</span><br>    <span class="hljs-attr">perDayPerUserLimitCount</span>: <span class="hljs-number">10</span>,<br>  &#125;,<br>  <span class="hljs-comment">// 用户配置</span><br>  <span class="hljs-attr">user</span>: &#123;<br>    <span class="hljs-comment">// 每个 IP 每天可创建用户数</span><br>    <span class="hljs-attr">create_user_per_ip</span>: <span class="hljs-number">1000</span>,<br>  &#125;,<br>  <span class="hljs-comment">// 默认搜索方式</span><br>  <span class="hljs-attr">search</span>: <span class="hljs-string">&#x27;baidu&#x27;</span>, <span class="hljs-comment">// &#x27;google&#x27;, &#x27;baidu&#x27;, &#x27;local&#x27;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>哪里需要直接导入就行了，这个比较简单。</p>
<p>系统配置和应用配置告一段落了，那么接下来需要配置数</p>
<h3 id="mongoose-连接"><a href="#mongoose-连接" class="headerlink" title="mongoose 连接"></a>mongoose 连接</h3><p>关于<code>mongoDB</code>安装，创建数据库，连接认证等操作，这里就展开了，这里有篇<a target="_blank" rel="noopener" href="https://github.com/jiayisheji/jianshu/blob/master/blog/%E8%BF%9E%E6%8E%A5MongoDB.md">文章</a></p>
<p>在<code>.env</code>文件里面，我们已经配置<code>mongoDB</code>相关数据。</p>
<ol>
<li>创建核心模块</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ nest generate module core<br>OR<br>$ nest g mo core<br></code></pre></td></tr></table></figure>

<p>核心模块，只会注入到<code>AppModule</code>，不会注入到<code>feature</code>和<code>shared</code>模块里面，专门做初始化配置工作，不需要导出任何模块。</p>
<p>它里面包括：守卫，管道，过滤器、拦截器、中间件、全局模块、常量、装饰器</p>
<p>其中全局中间件和全局模块需要模块里面注入和配置。</p>
<ol>
<li>配置<code>ConfigModule</code></li>
</ol>
<p>前面我们已经定义好了<code>ConfigModule</code>，现在把它添加到<code>CoreModule</code>中</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Module</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/common&#x27;</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">ConfigModule</span>, <span class="hljs-title class_">EnvConfig</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../config&#x27;</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">ConfigValidate</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./config.validate&#x27;</span><br><br><span class="hljs-meta">@Module</span>(&#123;<br>  <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">ConfigModule</span>.<span class="hljs-property">forRoot</span>&lt;<span class="hljs-title class_">EnvConfig</span>&gt;(<span class="hljs-literal">null</span>, <span class="hljs-title class_">ConfigValidate</span>.<span class="hljs-property">validateInput</span>)],<br>&#125;)<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CoreModule</span> &#123;&#125;<br></code></pre></td></tr></table></figure>

<p><code>ConfigValidate.validateInput</code> 是一个验证 <code>.env</code> 方法，<code>nest</code>和官网文档一样.</p>
<ol>
<li>配置<code>mongooseModule</code></li>
</ol>
<p><code>nest</code>为我们提供了<code>@nestjs/mongoose</code>。</p>
<p>安装依赖：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm install --save @nestjs/mongoose mongoose<br>npm install --save-dev @types/mongoose<br></code></pre></td></tr></table></figure>

<p>配置模块：<a target="_blank" rel="noopener" href="https://docs.nestjs.com/techniques/mongodb">文档</a></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs ts">...<br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">MongooseModule</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/mongoose&#x27;</span>;<br><br><span class="hljs-meta">@Module</span>(&#123;<br>    <span class="hljs-attr">imports</span>: [<br>        ...<br>        <span class="hljs-title class_">MongooseModule</span>.<span class="hljs-title function_">forRoot</span>(url, config)<br>    ],<br>&#125;)<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CoreModule</span> &#123;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>MongooseModule</code>提供了 2 个静态方法：</p>
<ul>
<li>forRoot(url, config): 对应的<code>Mongoose.connect()</code>方法</li>
<li>forRootAsync({<br>imports,<br>useFactory,<br>inject<br>}): <code>useFactory</code>返回对应的<code>Mongoose.connect()</code>方法参数，<code>imports</code>依赖模块，<code>inject</code>依赖服务</li>
<li>forFeature([{ name, schema }]): 对应的<code>mongoose.model()</code>方法</li>
<li>constructor(@InjectModel(‘Cat’) private readonly catModel: Model) {}：<code>@InjectModel</code>获取<code>mongoose.model</code>，参数和<code>forFeature</code>的<code>name</code>一样。</li>
</ul>
<p>根模块使用: (forRoot 和 forRootAsync，只能注入一次，所以要在根模块导入)</p>
<p>这里我们需要借助配置模块里面获取配置，需要用到<code>forRootAsync</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs ts">...<br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">MongooseModule</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/mongoose&#x27;</span>;<br><br><span class="hljs-meta">@Module</span>(&#123;<br>    <span class="hljs-attr">imports</span>: [<br>        ...<br>        <span class="hljs-title class_">MongooseModule</span>.<span class="hljs-title function_">forRootAsync</span>(&#123;<br>            <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">ConfigModule</span>],<br>            <span class="hljs-attr">useFactory</span>: <span class="hljs-keyword">async</span> (<span class="hljs-attr">configService</span>: <span class="hljs-title class_">ConfigService</span>) =&gt; (&#123;<br>                <span class="hljs-attr">uri</span>: configService.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;MONGODB_URI&#x27;</span>),<br>                <span class="hljs-attr">useNewUrlParser</span>: <span class="hljs-literal">true</span>,<br>            &#125;),<br>            <span class="hljs-attr">inject</span>: [<span class="hljs-title class_">ConfigService</span>],<br>        &#125;)<br>    ],<br>&#125;)<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CoreModule</span> &#123;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>如果要写<code>MongooseOptions</code>怎么办</p>
<p>直接在 uri 后面写，有个必须的配置要写：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">DeprecationWarning: current URL string parser is deprecated, and will be removed <span class="hljs-keyword">in</span> a future version. To use the new parser, pass option &#123; useNewUrlParser: <span class="hljs-literal">true</span> &#125; to MongoClient.connect.<br></code></pre></td></tr></table></figure>

<p>其他配置根据自己需求来添加</p>
<p>如果启动失败会显示：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">MongoError: Authentication failed.<br></code></pre></td></tr></table></figure>

<p>请检查 uri 是否正确，如果启动验证，账号是否验证通过，数据库名是否正确等等。</p>
<p>数据库连接成功，我们进行下一步，定义用户表。</p>
<h3 id="用户数据库模块"><a href="#用户数据库模块" class="headerlink" title="用户数据库模块"></a>用户数据库模块</h3><p>建立数据模型为后面控制器提供服务</p>
<h4 id="生成文件"><a href="#生成文件" class="headerlink" title="生成文件"></a>生成文件</h4><ol>
<li>创建<code>shared</code>模块</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ nest generate module shared<br>OR<br>$ nest g mo shared<br></code></pre></td></tr></table></figure>

<ol>
<li>创建<code>mongodb</code>模块</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ nest generate module shared/mongodb<br>OR<br>$ nest g mo shared/mongodb<br></code></pre></td></tr></table></figure>

<ol>
<li>创建<code>user</code>模块</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ nest generate module shared/mongodb/user<br>OR<br>$ nest g mo shared/mongodb/user<br></code></pre></td></tr></table></figure>

<ol>
<li>创建<code>user</code>服务</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ nest generate service shared/mongodb/user<br>OR<br>$ nest g s shared/mongodb/user<br></code></pre></td></tr></table></figure>

<ol>
<li>创建<code>user</code>的<code>interface</code>、<code>schema</code>、<code>index</code>。</li>
</ol>
<p>这三个文件无法用命令创建需要自己手动创建。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ <span class="hljs-built_in">touch</span> src/shared/mongodb/user/user.interface.ts<br>$ <span class="hljs-built_in">touch</span> src/shared/mongodb/user/user.schema.ts<br>$ <span class="hljs-built_in">touch</span> src/shared/mongodb/user/index.ts<br>OR<br>编辑器新建文件`user.interface.ts`<br>编辑器新建文件`user.schema.ts`<br>编辑器新建文件`index.ts`<br></code></pre></td></tr></table></figure>

<ul>
<li><code>interface</code>是<code>ts</code>接口定义 ts</li>
<li><code>schema</code>是定义<code>mongodb</code>的<code>schema</code></li>
</ul>
<p>最后完整的<code>user</code>文件夹是：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">index.ts<br>user.module.ts<br>user.service.ts<br>user.schema.ts<br>user.interface.ts<br></code></pre></td></tr></table></figure>

<blockquote>
<p>基本所有的<code>mongodb</code>模块都是这样的结构，后面不在介绍<code>生成文件</code>这项。</p>
</blockquote>
<h4 id="定义服务"><a href="#定义服务" class="headerlink" title="定义服务"></a>定义服务</h4><p>默认生产的模块文件</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Injectable</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/common&#x27;</span><br><br><span class="hljs-meta">@Injectable</span>()<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) &#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在正式写<code>UserService</code>之前，我们先思考一个问题，因为操作数据库服务基本都类似，常用几个方法如：</p>
<ul>
<li>findAll 获取指定条件全部数据</li>
<li>paginator 带分页结构数据</li>
<li>findOne 获取一个数据</li>
<li>findById 获取指定 id 数据</li>
<li>count 获取指定条件个数</li>
<li>create 创建数据</li>
<li>delete 删除数据</li>
<li>update 更新数据</li>
</ul>
<p>一个基本表应该有增删改查这样 8 个快捷操作方法，如果每个表都写一个这样的，就比较多余了。<code>Typescript</code>给我们提供一个抽象类，我们可以把这些公共方法写在里面，然后用其他服务来继承。那我们开始写<code>base.service.ts</code>:</p>
<p>base.service.ts</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 抽象CRUD操作基础服务</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@export</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@abstract</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@class</span> <span class="hljs-variable">BaseService</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@template</span> <span class="hljs-variable">T</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseService</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Document</span>&gt; &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> _model: Model&lt;T&gt;</span>) &#123;&#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 获取指定条件全部数据</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">*</span>&#125; <span class="hljs-variable">conditions</span></span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">(any | null)</span>&#125; [projection]</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">(&#123;</span></span><br><span class="hljs-type"><span class="hljs-comment">   *         sort?: any;</span></span><br><span class="hljs-type"><span class="hljs-comment">   *         limit?: number;</span></span><br><span class="hljs-type"><span class="hljs-comment">   *         skip?: number;</span></span><br><span class="hljs-type"><span class="hljs-comment">   *         populates?: ModelPopulateOptions[] | ModelPopulateOptions;</span></span><br><span class="hljs-type"><span class="hljs-comment">   *         [key: string]: any;</span></span><br><span class="hljs-type"><span class="hljs-comment">   *     </span>&#125;)&#125; [options]</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@returns</span> &#123;<span class="hljs-type">Promise&lt;T[]&gt;</span>&#125;</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@memberof</span> <span class="hljs-variable">BaseService</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-title function_">findAll</span>(<br>    <span class="hljs-attr">conditions</span>: <span class="hljs-built_in">any</span>,<br>    projection?: <span class="hljs-built_in">any</span> | <span class="hljs-literal">null</span>,<br>    options?: &#123;<br>      sort?: <span class="hljs-built_in">any</span><br>      limit?: <span class="hljs-built_in">number</span><br>      skip?: <span class="hljs-built_in">number</span><br>      populates?: <span class="hljs-title class_">ModelPopulateOptions</span>[] | <span class="hljs-title class_">ModelPopulateOptions</span><br>      [<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">any</span><br>    &#125;<br>  ): <span class="hljs-title class_">Promise</span>&lt;T[]&gt; &#123;<br>    <span class="hljs-keyword">const</span> &#123; option, populates &#125; = options<br>    <span class="hljs-keyword">const</span> docsQuery = <span class="hljs-variable language_">this</span>.<span class="hljs-property">_model</span>.<span class="hljs-title function_">find</span>(conditions, projection, option)<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">populates</span>&lt;T[]&gt;(docsQuery, populates)<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 获取带分页数据</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">*</span>&#125; <span class="hljs-variable">conditions</span></span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">(any | null)</span>&#125; [projection]</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">(&#123;</span></span><br><span class="hljs-type"><span class="hljs-comment">   *         sort?: any;</span></span><br><span class="hljs-type"><span class="hljs-comment">   *         limit?: number;</span></span><br><span class="hljs-type"><span class="hljs-comment">   *         offset?: number;</span></span><br><span class="hljs-type"><span class="hljs-comment">   *         page?: number;</span></span><br><span class="hljs-type"><span class="hljs-comment">   *         populates?: ModelPopulateOptions[] | ModelPopulateOptions;</span></span><br><span class="hljs-type"><span class="hljs-comment">   *         [key: string]: any;</span></span><br><span class="hljs-type"><span class="hljs-comment">   *     </span>&#125;)&#125; [options]</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@returns</span> &#123;<span class="hljs-type">Promise&lt;Paginator&lt;T&gt;&gt;</span>&#125;</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@memberof</span> <span class="hljs-variable">BaseService</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">paginator</span>(<br>    <span class="hljs-attr">conditions</span>: <span class="hljs-built_in">any</span>,<br>    projection?: <span class="hljs-built_in">any</span> | <span class="hljs-literal">null</span>,<br>    options?: &#123;<br>      sort?: <span class="hljs-built_in">any</span><br>      limit?: <span class="hljs-built_in">number</span><br>      offset?: <span class="hljs-built_in">number</span><br>      page?: <span class="hljs-built_in">number</span><br>      populates?: <span class="hljs-title class_">ModelPopulateOptions</span>[] | <span class="hljs-title class_">ModelPopulateOptions</span><br>      [<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">any</span><br>    &#125;<br>  ): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Paginator</span>&lt;T&gt;&gt; &#123;<br>    <span class="hljs-keyword">const</span> <span class="hljs-attr">result</span>: <span class="hljs-title class_">Paginator</span>&lt;T&gt; = &#123;<br>      <span class="hljs-attr">data</span>: [],<br>      <span class="hljs-attr">total</span>: <span class="hljs-number">0</span>,<br>      <span class="hljs-attr">limit</span>: options.<span class="hljs-property">limit</span> ? options.<span class="hljs-property">limit</span> : <span class="hljs-number">10</span>,<br>      <span class="hljs-attr">offset</span>: <span class="hljs-number">0</span>,<br>      <span class="hljs-attr">page</span>: <span class="hljs-number">1</span>,<br>      <span class="hljs-attr">pages</span>: <span class="hljs-number">0</span>,<br>    &#125;<br>    <span class="hljs-keyword">const</span> &#123; offset, page, option &#125; = options<br>    <span class="hljs-keyword">if</span> (offset !== <span class="hljs-literal">undefined</span>) &#123;<br>      result.<span class="hljs-property">offset</span> = options.<span class="hljs-property">offset</span><br>      options.<span class="hljs-property">skip</span> = offset<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (page !== <span class="hljs-literal">undefined</span>) &#123;<br>      result.<span class="hljs-property">page</span> = page<br>      options.<span class="hljs-property">skip</span> = (page - <span class="hljs-number">1</span>) * result.<span class="hljs-property">limit</span><br>      result.<span class="hljs-property">pages</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">ceil</span>(result.<span class="hljs-property">total</span> / result.<span class="hljs-property">limit</span>) || <span class="hljs-number">1</span><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      options.<span class="hljs-property">skip</span> = <span class="hljs-number">0</span><br>    &#125;<br>    result.<span class="hljs-property">data</span> = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">findAll</span>(conditions, projection, option)<br>    result.<span class="hljs-property">total</span> = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">count</span>(conditions)<br>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(result)<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 获取单条数据</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">*</span>&#125; <span class="hljs-variable">conditions</span></span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">*</span>&#125; [projection]</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">(&#123;</span></span><br><span class="hljs-type"><span class="hljs-comment">   *         lean?: boolean;</span></span><br><span class="hljs-type"><span class="hljs-comment">   *         populates?: ModelPopulateOptions[] | ModelPopulateOptions;</span></span><br><span class="hljs-type"><span class="hljs-comment">   *         [key: string]: any;</span></span><br><span class="hljs-type"><span class="hljs-comment">   *     </span>&#125;)&#125; [options]</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@returns</span> &#123;<span class="hljs-type">(Promise&lt;T | null&gt;)</span>&#125;</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@memberof</span> <span class="hljs-variable">BaseService</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-title function_">findOne</span>(<br>    <span class="hljs-attr">conditions</span>: <span class="hljs-built_in">any</span>,<br>    projection?: <span class="hljs-built_in">any</span>,<br>    options?: &#123;<br>      lean?: <span class="hljs-built_in">boolean</span><br>      populates?: <span class="hljs-title class_">ModelPopulateOptions</span>[] | <span class="hljs-title class_">ModelPopulateOptions</span><br>      [<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">any</span><br>    &#125;<br>  ): <span class="hljs-title class_">Promise</span>&lt;T | <span class="hljs-literal">null</span>&gt; &#123;<br>    <span class="hljs-keyword">const</span> &#123; option, populates &#125; = options<br>    <span class="hljs-keyword">const</span> docsQuery = <span class="hljs-variable language_">this</span>.<span class="hljs-property">_model</span>.<span class="hljs-title function_">findOne</span>(conditions, projection, option)<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">populates</span>&lt;T&gt;(docsQuery, populates)<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 根据id获取单条数据</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">(any | string | number)</span>&#125; <span class="hljs-variable">id</span></span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">*</span>&#125; [projection]</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">(&#123;</span></span><br><span class="hljs-type"><span class="hljs-comment">   *         lean?: boolean;</span></span><br><span class="hljs-type"><span class="hljs-comment">   *         populates?: ModelPopulateOptions[] | ModelPopulateOptions;</span></span><br><span class="hljs-type"><span class="hljs-comment">   *         [key: string]: any;</span></span><br><span class="hljs-type"><span class="hljs-comment">   *     </span>&#125;)&#125; [options]</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@returns</span> &#123;<span class="hljs-type">(Promise&lt;T | null&gt;)</span>&#125;</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@memberof</span> <span class="hljs-variable">BaseService</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-title function_">findById</span>(<br>    <span class="hljs-attr">id</span>: <span class="hljs-built_in">any</span> | <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span>,<br>    projection?: <span class="hljs-built_in">any</span>,<br>    options?: &#123;<br>      lean?: <span class="hljs-built_in">boolean</span><br>      populates?: <span class="hljs-title class_">ModelPopulateOptions</span>[] | <span class="hljs-title class_">ModelPopulateOptions</span><br>      [<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">any</span><br>    &#125;<br>  ): <span class="hljs-title class_">Promise</span>&lt;T | <span class="hljs-literal">null</span>&gt; &#123;<br>    <span class="hljs-keyword">const</span> &#123; option, populates &#125; = options<br>    <span class="hljs-keyword">const</span> docsQuery = <span class="hljs-variable language_">this</span>.<span class="hljs-property">_model</span>.<span class="hljs-title function_">findById</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">toObjectId</span>(id), projection, option)<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">populates</span>&lt;T&gt;(docsQuery, populates)<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 获取指定查询条件的数量</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">*</span>&#125; <span class="hljs-variable">conditions</span></span><br><span class="hljs-comment">   * <span class="hljs-doctag">@returns</span> &#123;<span class="hljs-type">Promise&lt;number&gt;</span>&#125;</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@memberof</span> <span class="hljs-variable">UserService</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-title function_">count</span>(<span class="hljs-attr">conditions</span>: <span class="hljs-built_in">any</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">number</span>&gt; &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">_model</span>.<span class="hljs-title function_">countDocuments</span>(conditions).<span class="hljs-title function_">exec</span>()<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 创建一条数据</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">T</span>&#125; <span class="hljs-variable">docs</span></span><br><span class="hljs-comment">   * <span class="hljs-doctag">@returns</span> &#123;<span class="hljs-type">Promise&lt;T&gt;</span>&#125;</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@memberof</span> <span class="hljs-variable">BaseService</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">create</span>(<span class="hljs-attr">docs</span>: <span class="hljs-title class_">Partial</span>&lt;T&gt;): <span class="hljs-title class_">Promise</span>&lt;T&gt; &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">_model</span>.<span class="hljs-title function_">create</span>(docs)<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 删除指定id数据</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">string</span>&#125; <span class="hljs-variable">id</span></span><br><span class="hljs-comment">   * <span class="hljs-doctag">@returns</span> &#123;<span class="hljs-type">Promise&lt;T&gt;</span>&#125;</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@memberof</span> <span class="hljs-variable">BaseService</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">delete</span>(<br>    <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>,<br>    <span class="hljs-attr">options</span>: &#123;<br>      <span class="hljs-comment">/** if multiple docs are found by the conditions, sets the sort order to choose which doc to update */</span><br>      sort?: <span class="hljs-built_in">any</span><br>      <span class="hljs-comment">/** sets the document fields to return */</span><br>      select?: <span class="hljs-built_in">any</span><br>    &#125;<br>  ): <span class="hljs-title class_">Promise</span>&lt;T | <span class="hljs-literal">null</span>&gt; &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">_model</span>.<span class="hljs-title function_">findByIdAndRemove</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">toObjectId</span>(id), options).<span class="hljs-title function_">exec</span>()<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 更新指定id数据</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">string</span>&#125; <span class="hljs-variable">id</span></span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">Partial&lt;T&gt;</span>&#125; [item=&#123;&#125;]</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@returns</span> &#123;<span class="hljs-type">Promise&lt;T&gt;</span>&#125;</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@memberof</span> <span class="hljs-variable">BaseService</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">update</span>(<br>    <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>,<br>    <span class="hljs-attr">update</span>: <span class="hljs-title class_">Partial</span>&lt;T&gt;,<br>    <span class="hljs-attr">options</span>: <span class="hljs-title class_">ModelFindByIdAndUpdateOptions</span> = &#123; <span class="hljs-attr">new</span>: <span class="hljs-literal">true</span> &#125;<br>  ): <span class="hljs-title class_">Promise</span>&lt;T | <span class="hljs-literal">null</span>&gt; &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">_model</span>.<span class="hljs-title function_">findByIdAndUpdate</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">toObjectId</span>(id), update, options).<span class="hljs-title function_">exec</span>()<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 删除所有匹配条件的文档集合</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">*</span>&#125; [conditions=&#123;&#125;]</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@returns</span> &#123;<span class="hljs-type">Promise&lt;WriteOpResult[&#x27;result&#x27;]&gt;</span>&#125;</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@memberof</span> <span class="hljs-variable">BaseService</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">clearCollection</span>(conditions = &#123;&#125;): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">WriteOpResult</span>[<span class="hljs-string">&#x27;result&#x27;</span>]&gt; &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">_model</span>.<span class="hljs-title function_">deleteMany</span>(conditions).<span class="hljs-title function_">exec</span>()<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 转换ObjectId</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@private</span></span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">string</span>&#125; <span class="hljs-variable">id</span></span><br><span class="hljs-comment">   * <span class="hljs-doctag">@returns</span> &#123;<span class="hljs-type">Types.ObjectId</span>&#125;</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@memberof</span> <span class="hljs-variable">BaseService</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">toObjectId</span>(<span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Types</span>.<span class="hljs-property">ObjectId</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Types</span>.<span class="hljs-title class_">ObjectId</span>(id)<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 填充其他模型</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@private</span></span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">*</span>&#125; <span class="hljs-variable">docsQuery</span></span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">*</span>&#125; <span class="hljs-variable">populates</span></span><br><span class="hljs-comment">   * <span class="hljs-doctag">@returns</span> &#123;<span class="hljs-type">(Promise&lt;T | T[] | null&gt;)</span>&#125;</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@memberof</span> <span class="hljs-variable">BaseService</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> populates&lt;R&gt;(docsQuery, populates): <span class="hljs-title class_">Promise</span>&lt;R | <span class="hljs-literal">null</span>&gt; &#123;<br>    <span class="hljs-keyword">if</span> (populates) &#123;<br>      ;[].<span class="hljs-title function_">concat</span>(populates).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> &#123;<br>        docsQuery.<span class="hljs-title function_">populate</span>(item)<br>      &#125;)<br>    &#125;<br>    <span class="hljs-keyword">return</span> docsQuery.<span class="hljs-title function_">exec</span>()<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里说几个上面没有提到的属性和方法：</p>
<ul>
<li>_model：当前模型的实例，我们使用它去扩展其他方法，如果上面方法不满足我们需求，我们可以随时自定义</li>
<li>clearCollection：删除所有匹配条件的文档集合</li>
<li>toObjectId：字符串 id 转换 ObjectId</li>
</ul>
<p>那么我们接下来的<code>UserService</code>就简单多了</p>
<p>user.service.ts</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Injectable</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/common&#x27;</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">BaseService</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../base.service&#x27;</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">InjectModel</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/mongoose&#x27;</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Model</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;mongoose&#x27;</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">User</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./user.interface&#x27;</span><br><br><span class="hljs-meta">@Injectable</span>()<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">BaseService</span>&lt;<span class="hljs-title class_">User</span>&gt; &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-meta">@InjectModel</span>(<span class="hljs-string">&#x27;User&#x27;</span>) <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> userModel: Model&lt;User&gt;</span>) &#123;<br>    <span class="hljs-variable language_">super</span>(userModel)<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>BaseService</code>是一个泛型，泛型是什么，简单理解就是你传什么它就是什么。<code>T</code>需要把我们<code>User</code>类型传进去,返回都是<code>User</code>类型，使用<code>@InjectModel(&#39;User&#39;)</code>注入模型实例，最后赋值给<code>_model</code>。</p>
<p>我们现在数据库<code>UserService</code>就已经完成了，接下来就需要定义<code>schema</code>和<code>interface</code>。</p>
<h4 id="定义-schema"><a href="#定义-schema" class="headerlink" title="定义 schema"></a>定义 schema</h4><p>有了上面服务的经验，现在是不是你会说<code>schema</code>有没有公用的，当然可以呀。</p>
<p>我们定一个<code>base.schema.ts</code>，思考一下需要抽出来，好像唯一可以抽出来就是：</p>
<ul>
<li>create_at：创建时间</li>
<li>update_at: 更新时间</li>
</ul>
<p>这 2 个我们可以用抽出来，可以使用<code>schema</code>配置参数里面的<code>timestamps</code>属性，可以开启它，它默认<code>createdAt</code>和<code>updatedAt</code>。我们修改它们字段名，使用它们好处，创建自动赋值，修改时候自动更新。<br><strong>注意</strong>：它们的存的时间和本地时间相差 8 小时，这个后面说怎么处理。</p>
<p>那么我们最终的配置就是：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">schemaOptions</span>: <span class="hljs-title class_">SchemaOptions</span> = &#123;<br>  <span class="hljs-attr">toJSON</span>: &#123;<br>    <span class="hljs-attr">virtuals</span>: <span class="hljs-literal">true</span>,<br>    <span class="hljs-attr">getters</span>: <span class="hljs-literal">true</span>,<br>  &#125;,<br>  <span class="hljs-attr">timestamps</span>: &#123;<br>    <span class="hljs-attr">createdAt</span>: <span class="hljs-string">&#x27;create_at&#x27;</span>,<br>    <span class="hljs-attr">updatedAt</span>: <span class="hljs-string">&#x27;update_at&#x27;</span>,<br>  &#125;,<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>toJSON</code>是做什么的，我们需要开启显示<code>virtuals</code>虚拟数据，<code>getters</code>获取数据。</p>
<p>关于 schema 定义</p>
<p>在创建表之前我们需要跟大家说一下 mongoDB 的数据类型，具体数据类型如下：</p>
<ul>
<li>字符串 - 这是用于存储数据的最常用的数据类型。<code>MongoDB</code>中的字符串必须为<code>UTF-8</code>。</li>
<li>整型 - 此类型用于存储数值。 整数可以是 32 位或 64 位，具体取决于服务器。</li>
<li>布尔类型 - 此类型用于存储布尔值(true / false)值。</li>
<li>双精度浮点数 - 此类型用于存储浮点值。</li>
<li>最小/最大键 - 此类型用于将值与最小和最大<code>BSON</code>元素进行比较。</li>
<li>数组 - 此类型用于将数组或列表或多个值存储到一个键中。</li>
<li>时间戳 - <code>ctimestamp</code>当文档被修改或添加时，可以方便地进行录制。</li>
<li>对象 - 此数据类型用于嵌入式文档。</li>
<li>对象 - 此数据类型用于嵌入式文档。</li>
<li>Null - 此类型用于存储 Null 值。</li>
<li>符号 - 该数据类型与字符串相同; 但是，通常保留用于使用特定符号类型的语言。</li>
<li>日期 - 此数据类型用于以 UNIX 时间格式存储当前日期或时间。您可以通过创建日期对象并将日，月，年的日期进行指定自己需要的日期时间。</li>
<li>对象 ID - 此数据类型用于存储文档的 ID。</li>
<li>二进制数据 - 此数据类型用于存储二进制数据。</li>
<li>代码 - 此数据类型用于将 JavaScript 代码存储到文档中。</li>
<li>正则表达式 - 此数据类型用于存储正则表达式。</li>
</ul>
<p><code>mongoose</code>使用<code>Schema</code>所定义的数据模型，再使用<code>mongoose.model(modelName, schema)</code>将定义好的<code>Schema</code>转换为<code>Model</code>。<br>在<code>Mongoose</code>的设计理念中，<code>Schema</code>用来也只用来定义数据结构，具体对数据的增删改查操作都由<code>Model</code>来执行</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Schema</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;mongoose&#x27;</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">UserSchema</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Schema</span>(&#123;<br>  <span class="hljs-comment">// 定义你的Schema</span><br>&#125;)<br><span class="hljs-title class_">UserSchema</span>.<span class="hljs-title function_">index</span>() <span class="hljs-comment">// 索引</span><br><span class="hljs-title class_">UserSchema</span>.<span class="hljs-title function_">virtual</span>() <span class="hljs-comment">// 虚拟值</span><br><span class="hljs-title class_">UserSchema</span>.<span class="hljs-title function_">pre</span>() <span class="hljs-comment">// 中间件</span><br><span class="hljs-title class_">UserSchema</span>.<span class="hljs-property">methods</span>.<span class="hljs-property">xxx</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;&#125; <span class="hljs-comment">// 实例方法</span><br><span class="hljs-title class_">UserSchema</span>.<span class="hljs-property">statics</span>.<span class="hljs-property">xxx</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;&#125; <span class="hljs-comment">// 静态方法</span><br><span class="hljs-title class_">UserSchema</span>.<span class="hljs-property">query</span>.<span class="hljs-property">xxx</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;&#125; <span class="hljs-comment">// 查询助手</span><br><span class="hljs-title class_">UserSchema</span>.<span class="hljs-property">query</span>.<span class="hljs-property">xxx</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;&#125; <span class="hljs-comment">// 查询助手</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意</strong>：这里面都要使用普通函数<code>function()&#123;&#125;</code>，不能使用<code>()=&gt;&#123;&#125;</code>，原因你懂的。</p>
</blockquote>
<p>user.schema.ts</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-comment">// 引入mongoose包</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Schema</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;mongoose&#x27;</span>;<br><span class="hljs-comment">// 一个工具包，使用MD5方法加密</span><br><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> utility <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;utility&#x27;</span>;<br><span class="hljs-comment">// 引入user接口</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">User</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./user.interface&#x27;</span>;<br><br><span class="hljs-comment">// 定义schema并导出</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">UserSchema</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Schema</span>(&#123;<br>    <span class="hljs-attr">name</span>: &#123; <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span> &#125;,<br>    <span class="hljs-attr">loginname</span>: &#123; <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span> &#125;,<br>    <span class="hljs-attr">pass</span>: &#123; <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span> &#125;,<br>    <span class="hljs-attr">email</span>: &#123; <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span> &#125;,<br>    <span class="hljs-attr">url</span>: &#123; <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span> &#125;,<br>    <span class="hljs-attr">profile_image_url</span>: &#123; <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span> &#125;,<br>    <span class="hljs-attr">location</span>: &#123; <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span> &#125;,<br>    <span class="hljs-attr">signature</span>: &#123; <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span> &#125;,<br>    <span class="hljs-attr">profile</span>: &#123; <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span> &#125;,<br>    <span class="hljs-attr">weibo</span>: &#123; <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span> &#125;,<br>    <span class="hljs-attr">avatar</span>: &#123; <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span> &#125;,<br>    <span class="hljs-attr">githubId</span>: &#123; <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span> &#125;,<br>    <span class="hljs-attr">githubUsername</span>: &#123; <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span> &#125;,<br>    <span class="hljs-attr">githubAccessToken</span>: &#123; <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span> &#125;,<br>    <span class="hljs-attr">is_block</span>: &#123; <span class="hljs-attr">type</span>: <span class="hljs-title class_">Boolean</span>, <span class="hljs-attr">default</span>: <span class="hljs-literal">false</span> &#125;,<br>    ...<br>&#125;, schemaOptions);<br><br><span class="hljs-comment">// 设置索引</span><br><span class="hljs-title class_">UserSchema</span>.<span class="hljs-title function_">index</span>(&#123; <span class="hljs-attr">loginname</span>: <span class="hljs-number">1</span> &#125;, &#123; <span class="hljs-attr">unique</span>: <span class="hljs-literal">true</span> &#125;);<br><span class="hljs-title class_">UserSchema</span>.<span class="hljs-title function_">index</span>(&#123; <span class="hljs-attr">email</span>: <span class="hljs-number">1</span> &#125;, &#123; <span class="hljs-attr">unique</span>: <span class="hljs-literal">true</span> &#125;);<br><span class="hljs-title class_">UserSchema</span>.<span class="hljs-title function_">index</span>(&#123; <span class="hljs-attr">score</span>: -<span class="hljs-number">1</span> &#125;);<br><span class="hljs-title class_">UserSchema</span>.<span class="hljs-title function_">index</span>(&#123; <span class="hljs-attr">githubId</span>: <span class="hljs-number">1</span> &#125;);<br><span class="hljs-title class_">UserSchema</span>.<span class="hljs-title function_">index</span>(&#123; <span class="hljs-attr">accessToken</span>: <span class="hljs-number">1</span> &#125;);<br><br><span class="hljs-comment">// 设置虚拟属性</span><br><span class="hljs-title class_">UserSchema</span>.<span class="hljs-title function_">virtual</span>(<span class="hljs-string">&#x27;avatar_url&#x27;</span>).<span class="hljs-title function_">get</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">let</span> url =<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">avatar</span> ||<br>        <span class="hljs-string">`https://gravatar.com/avatar/<span class="hljs-subst">$&#123;utility.md5(<span class="hljs-variable language_">this</span>.email.toLowerCase())&#125;</span>?size=48`</span>;<br><br>    <span class="hljs-comment">// www.gravatar.com 被墙</span><br>    url = url.<span class="hljs-title function_">replace</span>(<span class="hljs-string">&#x27;www.gravatar.com&#x27;</span>, <span class="hljs-string">&#x27;gravatar.com&#x27;</span>);<br><br>    <span class="hljs-comment">// 让协议自适应 protocol，使用 `//` 开头</span><br>    <span class="hljs-keyword">if</span> (url.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&#x27;http:&#x27;</span>) === <span class="hljs-number">0</span>) &#123;<br>        url = url.<span class="hljs-title function_">slice</span>(<span class="hljs-number">5</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// 如果是 github 的头像，则限制大小</span><br>    <span class="hljs-keyword">if</span> (url.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&#x27;githubusercontent&#x27;</span>) !== -<span class="hljs-number">1</span>) &#123;<br>        url += <span class="hljs-string">&#x27;&amp;s=120&#x27;</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> url;<br>&#125;);<br>...<br></code></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意</strong>：这里面使用<code>utility</code>工具包，需要安装一下，<code>npm install utility --save</code>。</p>
</blockquote>
<h4 id="定义-interface"><a href="#定义-interface" class="headerlink" title="定义 interface"></a>定义 interface</h4><p>因为有些公共的字段，我们在定义<code>interface</code>时候也需要抽离出来。使用<code>base.interface.ts</code></p>
<p>base.interface.ts</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Document</span>, <span class="hljs-title class_">Types</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;mongoose&#x27;</span><br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BaseInterface</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Document</span> &#123;<br>  <span class="hljs-attr">_id</span>: <span class="hljs-title class_">Types</span>.<span class="hljs-property">ObjectId</span> <span class="hljs-comment">// mongodb id</span><br>  <span class="hljs-attr">id</span>: <span class="hljs-title class_">Types</span>.<span class="hljs-property">ObjectId</span> <span class="hljs-comment">// mongodb id</span><br>  <span class="hljs-attr">create_at</span>: <span class="hljs-title class_">Date</span> <span class="hljs-comment">// 创建时间</span><br>  <span class="hljs-attr">update_at</span>: <span class="hljs-title class_">Date</span> <span class="hljs-comment">// 更新时间</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>interface</code> 文件内容和 <code>schema</code> 的基本一样，只需要字段名和类型就好了。</p>
<p>user.interface.ts</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">BaseInterface</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../base.interface&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseInterface</span> &#123;<br>    <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;  <span class="hljs-comment">// 显示名字</span><br>    <span class="hljs-attr">loginname</span>: <span class="hljs-built_in">string</span>;  <span class="hljs-comment">// 登录名</span><br>    <span class="hljs-attr">pass</span>: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 密码</span><br>    <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>;  <span class="hljs-comment">// 年龄</span><br>    <span class="hljs-attr">email</span>: <span class="hljs-built_in">string</span>;  <span class="hljs-comment">// 邮箱</span><br>    <span class="hljs-attr">active</span>: <span class="hljs-built_in">boolean</span>;  <span class="hljs-comment">// 是否激活</span><br>    <span class="hljs-attr">collect_topic_count</span>: <span class="hljs-built_in">number</span>;  <span class="hljs-comment">// 收集话题数</span><br>    <span class="hljs-attr">topic_count</span>: <span class="hljs-built_in">number</span>;  <span class="hljs-comment">// 发布话题数</span><br>    <span class="hljs-attr">score</span>: <span class="hljs-built_in">number</span>;   <span class="hljs-comment">// 积分</span><br>    <span class="hljs-attr">is_star</span>: <span class="hljs-built_in">boolean</span>;  <span class="hljs-comment">//</span><br>    <span class="hljs-attr">is_block</span>: <span class="hljs-built_in">boolean</span>; <span class="hljs-comment">// 是否黑名单</span><br>    ...<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意</strong>：如果是<code>schema</code>里面不是定义必填或者有默认值的字段，需要这样写<code>is_admin?: boolean;</code>，<code>?</code>表示该字段可选的。最好在<code>interface</code>里面写上每个字段加上注释，方便查看。</p>
</blockquote>
<h4 id="定义模块"><a href="#定义模块" class="headerlink" title="定义模块"></a>定义模块</h4><p>默认生产的模块文件</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Module</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/common&#x27;</span><br><br><span class="hljs-meta">@Module</span>(&#123;<br>  <span class="hljs-attr">imports</span>: [],<br>  <span class="hljs-attr">providers</span>: [],<br>  <span class="hljs-attr">exports</span>: [],<br>&#125;)<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserModule</span> &#123;&#125;<br></code></pre></td></tr></table></figure>

<p>上面<code>schema</code>和<code>service</code>，都定义好了，接下来我们需要在模块里面注册。</p>
<p>user.module.ts</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Module</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/common&#x27;</span><br><br><span class="hljs-comment">// 引入 nestjs 提供的 mongoose 模块</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">MongooseModule</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/mongoose&#x27;</span><br><br><span class="hljs-comment">// 引入自己写的 schema 和 service 在模块里面注册</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">UserSchema</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./user.schema&#x27;</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">UserService</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./user.service&#x27;</span><br><br><span class="hljs-meta">@Module</span>(&#123;<br>  <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">MongooseModule</span>.<span class="hljs-title function_">forFeature</span>([&#123; <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;User&#x27;</span>, <span class="hljs-attr">schema</span>: <span class="hljs-title class_">UserSchema</span> &#125;])],<br>  <span class="hljs-attr">providers</span>: [<span class="hljs-title class_">UserService</span>],<br>  <span class="hljs-attr">exports</span>: [<span class="hljs-title class_">UserService</span>],<br>&#125;)<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserModule</span> &#123;&#125;<br></code></pre></td></tr></table></figure>

<p><code>forFeature([&#123; name: &#39;User&#39;, schema: UserSchema &#125;])</code>就是<code>MongooseModule</code>为什么提供的<code>mongoose.model(modelName, schema)</code>操作</p>
<blockquote>
<p><strong>注意</strong>：<code>providers</code>是注册服务，如果想要给其他模块使用，需要在<code>exports</code>导出。</p>
</blockquote>
<h4 id="定义索引文件"><a href="#定义索引文件" class="headerlink" title="定义索引文件"></a>定义索引文件</h4><p>index.ts</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">export</span> * <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./user.module&#x27;</span><br><span class="hljs-keyword">export</span> * <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./user.interface&#x27;</span><br><span class="hljs-keyword">export</span> * <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./user.service&#x27;</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意</strong>：不是所有的文件都需要导出的，一些关键的文件，其他模块需要使用的，如果<code>interface</code>、<code>service</code>都是需要导出的。</p>
</blockquote>
<p>其他文件访问</p>
<p>xxx.service.ts</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">UserService</span>, <span class="hljs-title class_">User</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./user&#x27;</span><br></code></pre></td></tr></table></figure>

<p>是不是很方便。</p>
<h3 id="shared-模块和-mongodb-模块"><a href="#shared-模块和-mongodb-模块" class="headerlink" title="shared 模块和 mongodb 模块"></a>shared 模块和 mongodb 模块</h3><h4 id="mongodb-模块"><a href="#mongodb-模块" class="headerlink" title="mongodb 模块"></a>mongodb 模块</h4><p><code>mongodb</code>模块是管理所有<code>mongodb</code>文件夹里模块导入导出</p>
<p>mongodb.module.ts</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Module</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/common&#x27;</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">UserModule</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./user&#x27;</span><br><br><span class="hljs-meta">@Module</span>(&#123;<br>  <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">UserModule</span>],<br>  <span class="hljs-attr">exports</span>: [<span class="hljs-title class_">UserModule</span>],<br>&#125;)<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MongodbModule</span> &#123;&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>建立索引文件<code>index.ts</code>导出<code>mongodb</code>文件夹下所有文件夹</p>
</blockquote>
<h4 id="shared-模块"><a href="#shared-模块" class="headerlink" title="shared 模块"></a>shared 模块</h4><p><code>shared</code>模块是管理所有<code>shared</code>文件夹里模块导入导出</p>
<p>shared.module.ts</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Module</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/common&#x27;</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">MongodbModule</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./mongodb&#x27;</span><br><br><span class="hljs-meta">@Module</span>(&#123;<br>  <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">MongodbModule</span>],<br>  <span class="hljs-attr">exports</span>: [<span class="hljs-title class_">MongodbModule</span>],<br>&#125;)<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SharedModule</span> &#123;&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>建立索引文件<code>index.ts</code>导出<code>shared</code>文件夹下所有文件夹</p>
</blockquote>
<p>到这里我们<code>user</code>数据表模块就基本完成了，接下来就需要使用它们。我们也可以运行<code>npm run start:dev</code>，不会出现任何错误，如果有错，请检查你的文件是否正确。如果找不到问题，可以联系我。</p>
<p><strong>注意</strong>：后面我们搭建数据库就不再如此详细说明，只是一笔带过，大家可以看源码。</p>
<h2 id="注册和使用node-mailer发送邮件"><a href="#注册和使用node-mailer发送邮件" class="headerlink" title="注册和使用node-mailer发送邮件"></a>注册和使用<code>node-mailer</code>发送邮件</h2><p>如果有用户模块功能，登陆注册应该说是必备的入门功能。</p>
<p>先说一下我们登陆注册逻辑：</p>
<ol>
<li>我们主要使用<code>passport、passport-github、passport-local</code>这三个模块，做身份认证。</li>
<li>支持本地注册登陆和<code>github</code>第三方认证登陆（后面会介绍 github 认证登陆怎么玩）</li>
<li>使用<code>session</code>和<code>cookie</code>，30 天内免登陆</li>
<li>退出后清除<code>session</code>和<code>cookie</code></li>
<li>支持电子邮箱找回密码</li>
</ol>
<p>这里注册、登录、登出、找回密码都放在这个模块里面</p>
<h3 id="生成文件-1"><a href="#生成文件-1" class="headerlink" title="生成文件"></a>生成文件</h3><ol>
<li>创建<code>feature</code>模块</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ nest generate module feature<br>OR<br>$ nest g mo feature<br></code></pre></td></tr></table></figure>

<ol>
<li>创建<code>auth</code>模块</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ nest generate module feature/auth<br>OR<br>$ nest g mo feature/auth<br></code></pre></td></tr></table></figure>

<ol>
<li>创建<code>auth</code>服务</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ nest generate service feature/auth<br>OR<br>$ nest g s feature/auth<br></code></pre></td></tr></table></figure>

<ol>
<li>创建<code>auth</code>控制器</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ nest generate controller feature/auth<br>OR<br>$ nest g co feature/auth<br></code></pre></td></tr></table></figure>

<ol>
<li>创建<code>auth</code>的<code>dto</code></li>
</ol>
<p>dto 是字段参数验证的验证类，需要配合各种功能，等下会讲解。</p>
<p>最后完整的<code>auth</code>文件夹是：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">index.ts<br>auth.module.ts<br>auth.service.ts<br>auth.controller.ts<br>dto<br></code></pre></td></tr></table></figure>

<blockquote>
<p>基本所有的<code>feature</code>模块都是这样的结构，后面不在介绍<code>生成文件</code>这项。</p>
</blockquote>
<h3 id="科普知识：async-await"><a href="#科普知识：async-await" class="headerlink" title="科普知识：async/await"></a>科普知识：async/await</h3><p><code>ES7</code>发布<code>async/await</code>，也算是异步的解决又一种方案，</p>
<p>看一个简单的栗子：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">const</span> <span class="hljs-title function_">sleep</span> = time =&gt; &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> &#123;<br>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-title function_">resolve</span>()<br>    &#125;, time)<br>  &#125;)<br>&#125;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">start</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-comment">// 在这里使用起来就像同步代码那样直观</span><br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;start&#x27;</span>)<br>  <span class="hljs-keyword">await</span> <span class="hljs-title function_">sleep</span>(<span class="hljs-number">3000</span>)<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;end&#x27;</span>)<br>&#125;<br><br><span class="hljs-keyword">const</span> startFor = <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">10</span>; i++) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`当前是第<span class="hljs-subst">$&#123;i&#125;</span>次等待..`</span>)<br>    <span class="hljs-keyword">await</span> <span class="hljs-title function_">sleep</span>(<span class="hljs-number">1000</span>)<br>  &#125;<br>&#125;<br><br><span class="hljs-title function_">start</span>()<br><br><span class="hljs-comment">// startFor();</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>控制台先输出<code>start</code>，稍等<code>3</code>秒后，输出了<code>end</code>。</p>
</blockquote>
<p>看栗子也能知道<code>async/await</code>基本使用规则和条件</p>
<ol>
<li><code>async</code> 表示这是一个<code>async</code>函数，<code>await</code>只能用在这个函数里面</li>
<li><code>await</code> 表示在这里等待<code>promise</code>返回结果了，再继续执行。</li>
<li><code>await</code> 等待的虽然是<code>promise</code>对象，但不必写<code>.then(..)</code>，直接可以得到返回值。</li>
<li>捕捉错误可以直接用标准的<code>try catch</code>语法捕捉错误</li>
<li>循环多个<code>await</code> 可以写在 for 循环里，不必担心以往需要<code>闭包</code>才能解决的问题 (注意不能使用<code>forEach</code>,只可以用<code>for/for-of</code>)</li>
</ol>
<blockquote>
<p><strong>注意</strong>：<code>await</code>必须在<code>async</code>函数的上下文中</p>
</blockquote>
<p>在开始之前，前面数据操作有基础服务抽象类，这里控制器和服务也可以抽象出来。是可以抽象出来，但是本项目不决定这么来做，但会做一些抽象的辅助工具。</p>
<h3 id="auth-模块"><a href="#auth-模块" class="headerlink" title="auth 模块"></a>auth 模块</h3><p>auth.module.ts</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Module</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/common&#x27;</span><br><span class="hljs-comment">// 引入共享模块 访问user数据库</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">SharedModule</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;shared&#x27;</span><br><span class="hljs-comment">// 引入控制和服务进行在模块注册</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">AuthService</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./auth.service&#x27;</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">AuthController</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./auth.controller&#x27;</span><br><br><span class="hljs-meta">@Module</span>(&#123;<br>  <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">SharedModule</span>],<br>  <span class="hljs-attr">controllers</span>: [<span class="hljs-title class_">AuthController</span>],<br>  <span class="hljs-attr">providers</span>: [<span class="hljs-title class_">AuthService</span>],<br>&#125;)<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthModule</span> &#123;&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意</strong>： <code>feature</code> 模块尽量不要导出服务，避免循环依赖。</p>
</blockquote>
<h3 id="feature-模块"><a href="#feature-模块" class="headerlink" title="feature 模块"></a>feature 模块</h3><p>feature.module.ts</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Module</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/common&#x27;</span><br><span class="hljs-comment">// 引入Auth模块导入导出</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">AuthModule</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./auth/auth.module&#x27;</span><br><br><span class="hljs-meta">@Module</span>(&#123;<br>  <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">AuthModule</span>],<br>  <span class="hljs-attr">exports</span>: [<span class="hljs-title class_">AuthModule</span>],<br>&#125;)<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FeatureModule</span> &#123;&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意</strong>： <code>feature</code> 模块功能就是导入导出所以的业务模块。</p>
</blockquote>
<h3 id="app-模块"><a href="#app-模块" class="headerlink" title="app 模块"></a>app 模块</h3><p>如果是按我顺序用命令行创建的文件，<code>feature</code> 模块会自动添加到 <code>APP</code> 模块里面，<br>如果不是，需要手动把 <code>feature</code> 模块引入到 <code>APP</code> 模块里面。</p>
<p>app.module.ts</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Module</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/common&#x27;</span>;<br><span class="hljs-comment">// 引入核心模块 只能在AppModule导入，nest 没有 angular 模块检查机制，只能自觉遵守吧。</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">CoreModule</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./core/core.module&#x27;</span>;<br><span class="hljs-comment">// 引入特性模块</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">FeatureModule</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;feature&#x27;</span>;<br><br><span class="hljs-meta">@Module</span>(&#123;<br>  <span class="hljs-attr">imports</span>: [<br>    <span class="hljs-title class_">CoreModule</span>,<br>    <span class="hljs-title class_">FeatureModule</span>，<br>  ],<br>&#125;)<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppModule</span> &#123; &#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意</strong>：<code>APP</code> 模块不需要引入 <code>shared</code> 模块，<code>shared</code> 模式给业务模块引用的，<code>APP</code> 模块只需要引入 <code>CoreModule</code>, <code>feature</code> 模块就可以了。</p>
</blockquote>
<h3 id="auth-控制器"><a href="#auth-控制器" class="headerlink" title="auth 控制器"></a>auth 控制器</h3><p>默认控制器文件</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Controller</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/common&#x27;</span><br><br><span class="hljs-meta">@Controller</span>()<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthController</span> &#123;&#125;<br></code></pre></td></tr></table></figure>

<h4 id="注册"><a href="#注册" class="headerlink" title="注册"></a>注册</h4><p>要想登录，就要先注册，那我们先从注册开始。</p>
<p>auth.controller.ts</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">import</span> &#123;<br>    ...<br>    <span class="hljs-title class_">Get</span>,<br>    <span class="hljs-title class_">Render</span><br> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/common&#x27;</span>;<br><br><span class="hljs-meta">@Controller</span>()<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthController</span> &#123;<br>    <span class="hljs-meta">@Get</span>(<span class="hljs-string">&#x27;/register&#x27;</span>)<br>    <span class="hljs-meta">@Render</span>(<span class="hljs-string">&#x27;auth/register&#x27;</span>)<br>    <span class="hljs-keyword">async</span> <span class="hljs-title function_">registerView</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> &#123; <span class="hljs-attr">pageTitle</span>: <span class="hljs-string">&#x27;注册&#x27;</span> &#125;;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>前面介绍控制器时候已经介绍了<code>Get</code>，那么<code>Render</code>是什么，渲染模板，对应是<code>Express</code>的<code>res.render(&#39;xxxx&#39;);</code>方法。</p>
<p><strong>提示</strong>：</p>
<ol>
<li>关于控制器方法命名方式，因为本项目是服务的渲染的，所有会有模板页面和页面请求。模板页面统一加上<code>View</code>后缀</li>
<li>模板页面请求都是<code>get</code>，返回数据会带一个必须字段<code>pageTitle</code>，当前页面的<code>title</code>标签使用。</li>
<li>页面请求方法命名根据实际情况来。</li>
</ol>
<p>现在就可以运行开发启动命令看看效果，百分之两百的会报错，为什么？因为找不到模板<code>auth/register.ejs</code>文件。</p>
<p>那我们就去<code>views</code>下去创建一个<code>auth/register.ejs</code>，随便写的什么，在运行就可以了，浏览器访问：<code>http://localhost:3000/register</code>。</p>
<p><a target="_blank" rel="noopener" href="https://user-images.githubusercontent.com/6111778/50327748-4d4aef80-052b-11e9-8f33-7012966a5f0b.png"><img src="https://user-images.githubusercontent.com/6111778/50327748-4d4aef80-052b-11e9-8f33-7012966a5f0b.png" srcset="/blog/img/loading.gif" lazyload alt="2"></a></p>
<p>我们需要完善里面的内容了，因为<code>cnode</code><br>屏蔽注册功能，全部走<code>github</code>第三方认证登录，所以看不到<code>https://cnodejs.org/signin</code>这个页面，那么我们可以在<a target="_blank" rel="noopener" href="https://github.com/cnodejs/egg-cnode/blob/master/app/view/sign/signup.html">源码</a>找到这个页面结构，直接拷贝<code>div#content</code>里的内容过来。</p>
<p>一刷新就页面报错了：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;statusCode&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">500</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;message&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Internal server error&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>查看命令行提示：j</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">[Nest] 22132   - 2018-9-4 16:21:11   [ExceptionsHandler] E:\github\nest-cnode\views\auth\register.html:61<br>    59|                         &lt;% &#125; %&gt;<br>    60|                     &lt;/div&gt;<br> &gt;&gt; 61|                 &lt;/div&gt;<br>    62|                 &lt;input <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;hidden&#x27;</span> name=<span class="hljs-string">&#x27;_csrf&#x27;</span> value=<span class="hljs-string">&#x27;&lt;%= csrf %&gt;&#x27;</span> /&gt;<br>    63|<br>    64|                 &lt;div class=<span class="hljs-string">&#x27;form-actions&#x27;</span>&gt;<br><br>csrf is not defined<br></code></pre></td></tr></table></figure>

<p>提示我们<code>csrf</code>这个变量找不到。<code>csrf</code>是什么，<br>跨站请求伪造(CSRF 或 XSRF)是一种恶意利用的网站,未经授权的命令是传播从一个 web 应用程序的用户信任。<br>减轻这种攻击可以使用<code>csurf</code>包。这里有篇文章<a target="_blank" rel="noopener" href="https://cnodejs.org/topic/5533dd6e9138f09b629674fd">浅谈 cnode 社区如何防止 csrf 攻击</a></p>
<p>安装所需的包:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm i --save csurf<br></code></pre></td></tr></table></figure>

<p>在入口文件启动函数里面使用它。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> csurf <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;csurf&#x27;</span>;<br><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">bootstrap</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> app = <span class="hljs-keyword">await</span> <span class="hljs-title class_">NestFactory</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">AppModule</span>, application);<br>  ...<br>  <span class="hljs-comment">// 防止跨站请求伪造</span><br>  app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">csurf</span>(&#123; <span class="hljs-attr">cookie</span>: <span class="hljs-literal">true</span> &#125;));<br>  ...<br>&#125;<br></code></pre></td></tr></table></figure>

<p>直接这么写肯定有问题，刷新页面控制台报错<code>Error: misconfigured csrf</code></p>
<p>下面来说个我经常解决问题方法：</p>
<ol>
<li>首先如果我们用的<code>github</code>的开源依赖包，我们把这个错误复制到它的<code>issues</code>的搜索框里，如果有类似的问题，就进去看看，能不能找到解决方案，如果没有一个问题，你就可以提<code>issues</code>。</li>
</ol>
<p>把你的问题的和环境依赖、最好有示例代码，越详细越好，运气好马上有人给你解决问题。</p>
<ol>
<li>搜索引擎解决问题比如：谷歌、必应、百度。如果有条件首选谷歌，没条件优先必应，其次百度。也是把问题直接复制到输入框，回车就好有一些类似的答案。</li>
<li>就是去一些相关社区提问，和<code>1</code>一样，把问题描述清楚。</li>
</ol>
<p>使用必应搜索，发现结果第一个就是问题，和我们一模一样的。</p>
<p><a target="_blank" rel="noopener" href="https://user-images.githubusercontent.com/6111778/50327760-563bc100-052b-11e9-888d-96abd6977499.png"><img src="https://user-images.githubusercontent.com/6111778/50327760-563bc100-052b-11e9-888d-96abd6977499.png" srcset="/blog/img/loading.gif" lazyload alt="3"></a></p>
<p>点击链接进去的，有人回复一个收到好评最高，说<code>app.use(csurf())</code>要在<code>app.use(cookieParser())</code>和<code>app.use(session(&#123;...&#125;)</code>之后执行。</p>
<p>其实我们的这个问题，在<a target="_blank" rel="noopener" href="https://github.com/expressjs/csurf">csurf</a>说明文档里面已经有写了，使用之前必须依赖<code>cookieParser</code>和<code>session</code>中间件。</p>
<p><code>session</code>中间件可以选择<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/express-session">express-session</a>和<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/cookie-session">cookie-session</a></p>
<p>我们需要安装 2 个中间件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm i --save cookie-parser express-session connect-redis<br></code></pre></td></tr></table></figure>

<p>在入口文件启动函数里面使用它。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> cookieParser <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;cookie-parser&#x27;</span>;<br><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> expressSession <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;express-session&#x27;</span>;<br><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> connectRedis <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;connect-redis&#x27;</span>;<br><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> csurf <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;csurf&#x27;</span>;<br><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">bootstrap</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> app = <span class="hljs-keyword">await</span> <span class="hljs-title class_">NestFactory</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">AppModule</span>, application);<br>  ...<br>  <span class="hljs-keyword">const</span> <span class="hljs-title class_">RedisStore</span> = <span class="hljs-title function_">connectRedis</span>(expressSession);<br>  <span class="hljs-keyword">const</span> secret = config.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;SESSION_SECRET&#x27;</span>);<br>  <span class="hljs-comment">// 注册session中间件</span><br>  app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">expressSession</span>(&#123;<br>    <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;jiayi&#x27;</span>,<br>    secret,  <span class="hljs-comment">// 用来对sessionid 相关的 cookie 进行签名</span><br>    <span class="hljs-attr">store</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisStore</span>(<span class="hljs-title function_">getRedisConfig</span>(config)),  <span class="hljs-comment">// 本地存储session（文本文件，也可以选择其他store，比如redis的）</span><br>    <span class="hljs-attr">saveUninitialized</span>: <span class="hljs-literal">false</span>,  <span class="hljs-comment">// 是否自动保存未初始化的会话，建议false</span><br>    <span class="hljs-attr">resave</span>: <span class="hljs-literal">false</span>,  <span class="hljs-comment">// 是否每次都重新保存会话，建议false</span><br>  &#125;));<br>  <span class="hljs-comment">// 注册cookies中间件</span><br>  app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">cookieParser</span>(secret));<br>  <span class="hljs-comment">// 防止跨站请求伪造</span><br>  app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">csurf</span>(&#123; <span class="hljs-attr">cookie</span>: <span class="hljs-literal">true</span> &#125;));<br>  ...<br>&#125;<br></code></pre></td></tr></table></figure>

<p>里面有注释，这里就不解释了。</p>
<p>现在刷新还是一样报错<code>csrf is not defined</code>。</p>
<p>上面已经 ok，现在是没有这个变量，我们去<code>registerView</code>方法返回值里面加上</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">async</span> <span class="hljs-title function_">registerView</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> &#123; <span class="hljs-attr">pageTitle</span>: <span class="hljs-string">&#x27;注册&#x27;</span>, <span class="hljs-attr">csrf</span>: <span class="hljs-string">&#x27;&#x27;</span> &#125;;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>key 是<code>csrf</code>，value 随便写，返回最后都会被替换的。</p>
<p><a target="_blank" rel="noopener" href="https://user-images.githubusercontent.com/6111778/50327790-71a6cc00-052b-11e9-84c7-0585c605653a.png"><img src="https://user-images.githubusercontent.com/6111778/50327790-71a6cc00-052b-11e9-84c7-0585c605653a.png" srcset="/blog/img/loading.gif" lazyload alt="4"></a></p>
<p>如果每次都要写一个那就比较麻烦了，需要写一个中间件来解决问题。</p>
<p>在入口文件启动函数里面使用它。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">bootstrap</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> app = <span class="hljs-keyword">await</span> <span class="hljs-title class_">NestFactory</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">AppModule</span>, application);<br>  ...<br>  <span class="hljs-comment">// 设置变量 csrf 保存csrfToken值</span><br>  app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">req: <span class="hljs-built_in">any</span>, res, next</span>) =&gt;</span> &#123;<br>    res.<span class="hljs-property">locals</span>.<span class="hljs-property">csrf</span> = req.<span class="hljs-property">csrfToken</span> ? req.<span class="hljs-title function_">csrfToken</span>() : <span class="hljs-string">&#x27;&#x27;</span>;<br>    <span class="hljs-title function_">next</span>();<br>  &#125;);<br>  ...<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在刷新又报了另外一个错误：<code>ForbiddenError: invalid csrf token</code>。验证<code>token</code>失败。</p>
<p>文档里面也有，读取令牌从以下位置,按顺序:</p>
<ul>
<li><code>req.body._csrf</code> - typically generated by the <code>body-parser</code> module.</li>
<li><code>req.query._csrf</code> - a built-in from Express.js to read from the URL query string.</li>
<li><code>req.headers[&#39;csrf-token&#39;]</code> - the CSRF-Token HTTP request header.</li>
<li><code>req.headers[&#39;xsrf-token&#39;]</code> - the XSRF-Token HTTP request header.</li>
<li><code>req.headers[&#39;x-csrf-token&#39;]</code> - the X-CSRF-Token HTTP request header.</li>
<li><code>req.headers[&#39;x-xsrf-token&#39;]</code> - the X-XSRF-Token HTTP request header.</li>
</ul>
<p>前端向后端提交数据，常用有 2 种方式，<code>form</code>和<code>ajax</code>。<code>ajax</code>无刷新，这个比较常用，基本是主流操作了。<code>form</code>是服务端渲染使用比较多，不需要 js 处理直接提交，我们项目大部分都是<code>form</code>直接提交。</p>
<p>一般服务端渲染常用就 2 种请求，<code>get</code>打开一个页面，<code>post</code>直接<code>form</code>提交。</p>
<p><code>post</code>提交都是把数据放在<code>body</code>体里面，<code>Express</code>，解析<code>body</code>需要借助中间件<code>body-parser</code>。</p>
<p><code>nest</code>已经自带<code>body-parser</code>配置。但是我发现好像有 bug，原因不明，给作者提<a target="_blank" rel="noopener" href="https://github.com/nestjs/nest/issues/1052">issues</a></p>
<p>作者回复速度很快，需要调用<code>app.init()</code>初始化才行。</p>
<p>还有一个重要的东西<code>layout.html</code>模板需要加上<code>csrf</code>这个变量。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;&lt;%= csrf %&gt;&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;csrf-token&quot;</span> /&gt;</span><br></code></pre></td></tr></table></figure>

<p>接下来要写表单验证了：</p>
<p>我们在<code>dto</code>文件夹里面创建一个<code>register.dto.ts</code>和<code>index.ts</code>文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ <span class="hljs-built_in">touch</span> src/feature/auth/dto/register.dto.ts<br>$ <span class="hljs-built_in">touch</span> src/feature/auth/dto/index.ts<br>OR<br>编辑器新建文件register.dto.ts<br>编辑器新建文件index.ts<br></code></pre></td></tr></table></figure>

<p><code>register.dto.ts</code>是一个导出的类，typescript 类型，可以是<code>class</code>，可以<code>interface</code>，推荐<code>class</code>，因为它不光可以定义类型，还可以初始化数据。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RegisterDto</span> &#123;<br>  <span class="hljs-keyword">readonly</span> <span class="hljs-attr">loginname</span>: <span class="hljs-built_in">string</span><br>  <span class="hljs-keyword">readonly</span> <span class="hljs-attr">email</span>: <span class="hljs-built_in">string</span><br>  <span class="hljs-keyword">readonly</span> <span class="hljs-attr">pass</span>: <span class="hljs-built_in">string</span><br>  <span class="hljs-keyword">readonly</span> <span class="hljs-attr">re_pass</span>: <span class="hljs-built_in">string</span><br>  <span class="hljs-keyword">readonly</span> <span class="hljs-attr">_csrf</span>: <span class="hljs-built_in">string</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>什么叫<code>dto</code>, 全称数据传输对象（DTO)(Data Transfer Object)，简单来说<code>DTO</code>是面向界面<code>UI</code>，是通过<code>UI</code>的需求来定义的。通过<code>DTO</code>我们实现了控制器与数据验证转化解耦。</p>
<p><code>dto</code>中定义属性就是我们要提交的数据，控制器里面这样获取他们。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-meta">@Post</span>(<span class="hljs-string">&#x27;/register&#x27;</span>)<br><span class="hljs-meta">@Render</span>(<span class="hljs-string">&#x27;auth/register&#x27;</span>)<br><span class="hljs-keyword">async</span> <span class="hljs-title function_">register</span>(<span class="hljs-params"><span class="hljs-meta">@Body</span>() register: RegisterDto</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">authService</span>.<span class="hljs-title function_">register</span>(register);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这样是不是很普通，也没有太大用处。如果真的是这样的，我就不会写出来了。如果我提交数据之前需要验证字段合法性怎么办。<code>nest</code>也为我们想到了，使用官方提供的<code>ValidationPipe</code>，并安装 2 个必须的依赖：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm i --save class-validator class-transformer<br></code></pre></td></tr></table></figure>

<p>因为数据验证是非常通用的，我们需要在入口文件里全局去注册管道。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">bootstrap</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> app = <span class="hljs-keyword">await</span> <span class="hljs-title class_">NestFactory</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">AppModule</span>, application);<br>  ...<br>  <span class="hljs-comment">// 注册并配置全局验证管道</span><br>  app.<span class="hljs-title function_">useGlobalPipes</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ValidationPipe</span>(&#123;<br>    <span class="hljs-attr">transform</span>: <span class="hljs-literal">true</span>,<br>    <span class="hljs-attr">whitelist</span>: <span class="hljs-literal">true</span>,<br>    <span class="hljs-attr">forbidNonWhitelisted</span>: <span class="hljs-literal">true</span>,<br>    <span class="hljs-attr">skipMissingProperties</span>: <span class="hljs-literal">false</span>,<br>    <span class="hljs-attr">forbidUnknownValues</span>: <span class="hljs-literal">true</span>,<br>  &#125;));<br>  ...<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>配置信息官网都有介绍，说一个重点，<code>transform</code>是转换数据，配合<code>class-transformer</code>使用。</p>
</blockquote>
<p>开始写验证规则，对于这些装饰器使用方法，可以看文档也可以看<code>.d.ts</code>文件。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs ts">...<br><span class="hljs-meta">@IsNotEmpty</span>(&#123;<br>        <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;用户名不能为空&#x27;</span>,<br>    &#125;)<br>    <span class="hljs-meta">@Matches</span>(<span class="hljs-regexp">/^[a-zA-Z0-9\-_]&#123;5, 20&#125;$/i</span>, &#123;<br>        <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;用户名不合法&#x27;</span>,<br>    &#125;)<br>    <span class="hljs-meta">@Transform</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> value.<span class="hljs-title function_">toLowerCase</span>(), &#123; <span class="hljs-attr">toClassOnly</span>: <span class="hljs-literal">true</span> &#125;)<br>    <span class="hljs-keyword">readonly</span> <span class="hljs-attr">loginname</span>: <span class="hljs-built_in">string</span>;<br>    <span class="hljs-meta">@IsNotEmpty</span>(&#123;<br>        <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;邮箱不能为空&#x27;</span>,<br>    &#125;)<br>    <span class="hljs-meta">@IsEmail</span>(&#123;&#125;, &#123;<br>        <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;邮箱不合法&#x27;</span>,<br>    &#125;)<br>    <span class="hljs-meta">@Transform</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> value.<span class="hljs-title function_">toLowerCase</span>(), &#123; <span class="hljs-attr">toClassOnly</span>: <span class="hljs-literal">true</span> &#125;)<br>    <span class="hljs-keyword">readonly</span> <span class="hljs-attr">email</span>: <span class="hljs-built_in">string</span>;<br>    <span class="hljs-meta">@IsNotEmpty</span>(&#123;<br>        <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;密码不能为空&#x27;</span>,<br>    &#125;)<br>    <span class="hljs-meta">@IsByteLength</span>(<span class="hljs-number">6</span>, <span class="hljs-number">18</span>, &#123;<br>        <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;密码长度不是6-18位&#x27;</span>,<br>    &#125;)<br>    <span class="hljs-keyword">readonly</span> <span class="hljs-attr">pass</span>: <span class="hljs-built_in">string</span>;<br>    <span class="hljs-meta">@IsNotEmpty</span>(&#123;<br>        <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;确认密码不能为空&#x27;</span>,<br>    &#125;)<br>    <span class="hljs-keyword">readonly</span> <span class="hljs-attr">re_pass</span>: <span class="hljs-built_in">string</span>;<br>    <span class="hljs-meta">@IsOptional</span>()<br>    <span class="hljs-keyword">readonly</span> _csrf?: <span class="hljs-built_in">string</span>;<br>...<br></code></pre></td></tr></table></figure>

<ul>
<li><code>IsNotEmpty</code>不能为空</li>
<li><code>Matches</code>使用正则表达式</li>
<li><code>Transform</code>转化数据，这里把英文转成小写。</li>
</ul>
<p>发现一个问题，默认的提供的<code>NotEquals、Equals</code>只能验证一个写死的值，那么我验证确认密码怎么办，这是动态的。我想到一个简单粗暴的方式：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-meta">@Transform</span>(<span class="hljs-function">(<span class="hljs-params">value, obj</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (obj.<span class="hljs-property">pass</span> === value) &#123;<br>        <span class="hljs-keyword">return</span> value;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;PASSWORD_INCONSISTENCY&#x27;</span>;<br>&#125;, &#123; <span class="hljs-attr">toClassOnly</span>: <span class="hljs-literal">true</span> &#125;)<br><span class="hljs-meta">@NotEquals</span>(<span class="hljs-string">&#x27;PASSWORD_INCONSISTENCY&#x27;</span>, &#123;<br>    <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;两次密码输入不一致。&#x27;</span>,<br>&#125;)<br></code></pre></td></tr></table></figure>

<p>先用转化装饰器，去判断，<code>obj</code>拿到就当前实例类，然后去取它对应属性和当前的值对比，如果是相等就直接返回，如果不是就返回一个标识，再用<code>NotEquals</code>去判断。</p>
<p>这样写不是很友好，我们需要自定义一个装饰器来完成这个功能。</p>
<p>在 core 新建<code>decorators</code>文件夹下建<code>validator.decorators.ts</code>文件</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">import</span> &#123; registerDecorator, <span class="hljs-title class_">ValidationOptions</span>, <span class="hljs-title class_">ValidationArguments</span>, <span class="hljs-title class_">Validator</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;class-validator&#x27;</span><br><span class="hljs-keyword">import</span> &#123; get &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;lodash&#x27;</span><br><br><span class="hljs-keyword">const</span> validator = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Validator</span>()<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">IsEqualsThan</span>(<span class="hljs-params">property: <span class="hljs-built_in">string</span>[] | <span class="hljs-built_in">string</span>, validationOptions?: ValidationOptions</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params"><span class="hljs-built_in">object</span>: <span class="hljs-built_in">object</span>, propertyName: <span class="hljs-built_in">string</span></span>) =&gt;</span> &#123;<br>    <span class="hljs-title function_">registerDecorator</span>(&#123;<br>      <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;IsEqualsThan&#x27;</span>,<br>      <span class="hljs-attr">target</span>: <span class="hljs-built_in">object</span>.<span class="hljs-property">constructor</span>,<br>      propertyName,<br>      <span class="hljs-attr">constraints</span>: [property],<br>      <span class="hljs-attr">options</span>: validationOptions,<br>      <span class="hljs-attr">validator</span>: &#123;<br>        <span class="hljs-title function_">validate</span>(<span class="hljs-attr">value</span>: <span class="hljs-built_in">any</span>, <span class="hljs-attr">args</span>: <span class="hljs-title class_">ValidationArguments</span>): <span class="hljs-built_in">boolean</span> &#123;<br>          <span class="hljs-comment">// 拿到要比较的属性名或者路径 参考`lodash#get`方法</span><br>          <span class="hljs-keyword">const</span> [comparativePropertyName] = args.<span class="hljs-property">constraints</span><br>          <span class="hljs-comment">// 拿到要比较的属性值</span><br>          <span class="hljs-keyword">const</span> comparativeValue = <span class="hljs-title function_">get</span>(args.<span class="hljs-property">object</span>, comparativePropertyName)<br>          <span class="hljs-comment">// 返回false 验证失败</span><br>          <span class="hljs-keyword">return</span> validator.<span class="hljs-title function_">equals</span>(value, comparativeValue)<br>        &#125;,<br>      &#125;,<br>    &#125;)<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>官方文字里面有栗子：直接拷贝过来就行了，改改就好。我们需要改的就是<code>name</code>和<code>validate</code>函数里面的内容，</p>
<p><code>validate</code>函数返回 true 验证成功，false 验证失败，返回错误消息。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs ts">...<br><span class="hljs-meta">@IsNotEmpty</span>(&#123;<br>    <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;确认密码不能为空&#x27;</span>,<br>&#125;)<br><span class="hljs-meta">@IsEqualsThan</span>(<span class="hljs-string">&#x27;pass&#x27;</span>, &#123;<br>    <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;两次密码输入不一致。&#x27;</span>,<br>&#125;)<br><span class="hljs-keyword">readonly</span> <span class="hljs-attr">re_pass</span>: <span class="hljs-built_in">string</span>;<br>...<br></code></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意</strong>：<code>IsEqualsThan</code>第一个参数参考[lodash#get(<a target="_blank" rel="noopener" href="https://lodash.com/docs/4.17.10#get">https://lodash.com/docs/4.17.10#get</a>)方法</p>
</blockquote>
<p>验证规则搞定了，现在又有 2 个新问题了，</p>
<ol>
<li>默认返回全部错误格式是数组 json，我们需要格式化自定义错误。</li>
<li>我们需要把错误信息显示到当前页面，并且有些字段还需要显示在里面，有些字段不需要（比如密码），需要<code>Render</code>方法，可以实现数据显示，但是拿不到当前错误控制器的模板地址。这个是比较致命的问题，其他问题都好解决。</li>
</ol>
<p>解决这个问题，我纠结了很久，想到了 2 个方法来解决问题。</p>
<h3 id="自定义装饰器-配合ValidationPipe-HttpExceptionFilter实现"><a href="#自定义装饰器-配合ValidationPipe-HttpExceptionFilter实现" class="headerlink" title="自定义装饰器+配合ValidationPipe+HttpExceptionFilter实现"></a>自定义装饰器+配合<code>ValidationPipe</code>+<code>HttpExceptionFilter</code>实现</h3><p>借助<code>class-validator</code>配置参数的<code>context</code>字段。</p>
<p>我们可以在上面写 2 个字段，一个是<code>render</code>，一个是<code>locals</code>。</p>
<p>在实现<code>render</code>功能之前，我们需要借助<code>typescript</code>的一个功能<code>enum</code>枚举。</p>
<p><code>Nest</code>里面<code>HttpStatus</code>状态码就是<code>enum</code>。</p>
<p>我们把所有的视图模板都存在<code>enum</code>里面，枚举好处就是映射，类似于<code>key-value</code>对象。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-comment">// js 模拟 enum 写法</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">Enum</span> = &#123;<br>  <span class="hljs-attr">a</span>: <span class="hljs-string">&#x27;a&#x27;</span>,<br>  <span class="hljs-attr">b</span>: <span class="hljs-string">&#x27;b&#x27;</span>,<br>&#125;<br><br><span class="hljs-comment">// 取值</span><br><span class="hljs-title class_">Enum</span>[<span class="hljs-title class_">Enum</span>.<span class="hljs-property">a</span>]<br><span class="hljs-comment">// &#x27;a&#x27;</span><br><br><span class="hljs-comment">// 字符串赋值</span><br><span class="hljs-keyword">enum</span> <span class="hljs-title class_">Enum</span> &#123;<br>  a = <span class="hljs-string">&#x27;a&#x27;</span>,<br>  b = <span class="hljs-string">&#x27;b&#x27;</span>,<br>&#125;<br><br><span class="hljs-comment">// 取值</span><br><span class="hljs-title class_">Enum</span>.<span class="hljs-property">a</span><br><span class="hljs-comment">// &#x27;a&#x27;</span><br><br><span class="hljs-comment">// 索引赋值</span><br><span class="hljs-keyword">enum</span> <span class="hljs-title class_">Enum</span> &#123;<br>  a,<br>  b,<br>&#125;<br><br><span class="hljs-comment">// 取值</span><br><span class="hljs-title class_">Enum</span>.<span class="hljs-property">a</span><br><span class="hljs-comment">// 0</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p><code>typescript</code>转成<code>javascript</code>，枚举取值<code>Enum[Enum.a]</code>就是这样的。</p>
</blockquote>
<p>创建视图模板路径枚举</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ts">$ touch src/core/enums/views-path.<span class="hljs-property">ts</span><br><span class="hljs-variable constant_">OR</span><br>编辑器新建文件views-path.<span class="hljs-property">ts</span><br></code></pre></td></tr></table></figure>

<p>在里面写上：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ViewsPath</span> &#123;<br>  <span class="hljs-title class_">Register</span> = <span class="hljs-string">&#x27;auth/register&#x27;</span>,<br>&#125;<br></code></pre></td></tr></table></figure>

<p>auth.controller.ts 换上枚举：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs ts">...<br><span class="hljs-meta">@Post</span>(<span class="hljs-string">&#x27;/register&#x27;</span>)<br><span class="hljs-meta">@Render</span>(<span class="hljs-title class_">ViewsPath</span>.<span class="hljs-property">Register</span>)<br><span class="hljs-keyword">async</span> <span class="hljs-title function_">register</span>(<span class="hljs-params"><span class="hljs-meta">@Body</span>() register: RegisterDto, <span class="hljs-meta">@Res</span>() res</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">authService</span>.<span class="hljs-title function_">register</span>(register);<br>&#125;<br>...<br></code></pre></td></tr></table></figure>

<p>解决问题之前，我们先看，<code>ValidationPipe</code>源码，验证失败之后干了些什么：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs ts">...<br><span class="hljs-keyword">const</span> errors = <span class="hljs-keyword">await</span> classValidator.<span class="hljs-title function_">validate</span>(entity, <span class="hljs-variable language_">this</span>.<span class="hljs-property">validatorOptions</span>);<br><span class="hljs-keyword">if</span> (errors.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadRequestException</span>(<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isDetailedOutputDisabled</span> ? <span class="hljs-literal">undefined</span> : errors,<br>    );<br>&#125;<br>...<br></code></pre></td></tr></table></figure>

<p>返回是一个<code>ValidationError[]</code>，那<code>ValidationError</code>里面有什么：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ValidationError</span> &#123;<br>  target?: <span class="hljs-title class_">Object</span> <span class="hljs-comment">// 目标对象，就是我们定义验证规则那个对象。这里是`RegisterDto`</span><br>  <span class="hljs-attr">property</span>: <span class="hljs-built_in">string</span> <span class="hljs-comment">// 当前字段</span><br>  value?: <span class="hljs-built_in">any</span> <span class="hljs-comment">// 当前的值</span><br>  <span class="hljs-attr">constraints</span>: &#123;<br>    <span class="hljs-comment">// 验证规则错误提示，我们定义的装饰 @IsNotEmpty,显示的key是 isNotEmpty，value是定义配置里的`message`，定义多少显示多少。如果想一次只显示一个错误怎么办，后面讲怎么处理</span><br>    [<span class="hljs-attr">type</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">string</span><br>  &#125;<br>  <span class="hljs-attr">children</span>: <span class="hljs-title class_">ValidationError</span>[] <span class="hljs-comment">// 嵌套</span><br>  contexts?: &#123;<br>    <span class="hljs-comment">// 装饰器里面配置定义的`context`内容，key是 isNotEmpty ，value是 context内容</span><br>    [<span class="hljs-attr">type</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">any</span><br>  &#125;<br>  <span class="hljs-title function_">toString</span>(shouldDecorate?: <span class="hljs-built_in">boolean</span>, hasParent?: <span class="hljs-built_in">boolean</span>, parentPath?: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">string</span> <span class="hljs-comment">// 这玩意就不解释了。</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>最开始我想到是使用<code>context</code>来配置 3 个字段：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-comment">// context定义内容</span><br><span class="hljs-keyword">interface</span> context &#123;<br>  <span class="hljs-attr">render</span>: <span class="hljs-built_in">string</span> <span class="hljs-comment">// 视图模板路径</span><br>  <span class="hljs-attr">locals</span>: <span class="hljs-built_in">boolean</span> <span class="hljs-comment">// 字段是否显示</span><br>  <span class="hljs-attr">priority</span>: <span class="hljs-built_in">number</span> <span class="hljs-comment">// 验证规则显示优先级</span><br>&#125;<br><br><span class="hljs-comment">// Render需要参数</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Render</span> &#123;<br>  <span class="hljs-attr">view</span>: <span class="hljs-built_in">string</span> <span class="hljs-comment">// 视图模板路径</span><br>  <span class="hljs-attr">locals</span>: &#123;<br>    <span class="hljs-comment">// 模板显示的变量</span><br>    <span class="hljs-attr">error</span>: <span class="hljs-built_in">string</span> <span class="hljs-comment">// 必须有的错误消息</span><br>    [<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">any</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>折腾一遍，功能实现了，就是太麻烦了。每个规则验证装饰器里面都要写<code>context</code>一坨。</p>
<p>能不能简便一点了。如果我在这个类里面只定义一次是不是好点。</p>
<p>就想到了在<code>RegisterDto</code>里写个私有属性，把相关的字段存进去，改进了<code>context</code>配置：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ValidatorFilterContext</span> &#123;<br>  <span class="hljs-attr">render</span>: <span class="hljs-built_in">string</span><br>  <span class="hljs-attr">locals</span>: &#123; [<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">boolean</span> &#125;<br>  <span class="hljs-attr">priority</span>: &#123; [<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">string</span>[] &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>就变成这样的：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs ts">...<br><br><span class="hljs-attr">__validator_filter__</span>: &#123;<br>    <span class="hljs-attr">render</span>: <span class="hljs-title class_">ViewsPath</span>.<span class="hljs-property">Register</span>,<br>    <span class="hljs-attr">locals</span>: &#123;<br>        <span class="hljs-attr">loginname</span>: <span class="hljs-literal">true</span>,<br>        <span class="hljs-attr">pass</span>: <span class="hljs-literal">false</span>,<br>        <span class="hljs-attr">re_pass</span>: <span class="hljs-literal">false</span>,<br>        <span class="hljs-attr">email</span>: <span class="hljs-literal">true</span>,<br>    &#125;,<br>    <span class="hljs-attr">priority</span>: &#123;<br>        <span class="hljs-attr">loginname</span>: [<span class="hljs-string">&#x27;IsNotEmpty&#x27;</span>, <span class="hljs-string">&#x27;Matches&#x27;</span>],<br>        <span class="hljs-attr">pass</span>: [<span class="hljs-string">&#x27;IsNotEmpty&#x27;</span>, <span class="hljs-string">&#x27;IsByteLength&#x27;</span>],<br>        <span class="hljs-attr">re_pass</span>: [<span class="hljs-string">&#x27;IsNotEmpty&#x27;</span>, <span class="hljs-string">&#x27;IsEqualsThan&#x27;</span>],<br>        <span class="hljs-attr">email</span>: [<span class="hljs-string">&#x27;IsNotEmpty&#x27;</span>, <span class="hljs-string">&#x27;IsEmail&#x27;</span>],<br>    &#125;,<br>&#125;<br>...<br></code></pre></td></tr></table></figure>

<p>这样就比每个规则验证装饰器写<code>context</code>配置好了很多，但是这样又有一个问题，会在<code>target</code>里面多一个<code>__validattsor_filter__</code>，有点多余了。</p>
<p>需要改进一下，我就想到类装饰器。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">VALIDATOR_FILTER</span> = <span class="hljs-string">&#x27;__validator_filter__&#x27;</span><br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ValidatorFilter</span>(<span class="hljs-params">context: ValidatorFilterContext</span>): <span class="hljs-title class_">ClassDecorator</span> &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">target: <span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">defineMetadata</span>(<span class="hljs-variable constant_">VALIDATOR_FILTER</span>, context, target)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>类装饰器前面已经说过了，它是装饰器里面最后执行的，用来装饰类。这里有个比较特殊的<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Reflect">Reflect</a>。</p>
<p><code>Reflect</code>翻译叫反射，应该说叫映射靠谱点。为什么了，它基本就是类似此功能。</p>
<p><code>defineMetadata</code>定义元数据，有 3 个参数：第一个是标识 key，第二个是存储的数据（获取就是它），第三个就是一个对象。</p>
<p>翻译过来就是在 a 对象里面定一个标识 b 的数据为 c。有定义就有获取</p>
<p><code>getMetadata</code>获取元数据，有 2 个参数：第一个是标识 key，第三个就是一个对象。</p>
<p>翻译过来就是在 a 对象里去查一个 b 标识，如果有就返回原数据，如果没有就是 Undefined。或者是 b 标识里面去查找 a 对象。理解差不多。目的是 2 个都匹配就返回数据。</p>
<p>这玩意简单理解<code>Reflect</code>是一个全局对象，<code>defineMetadata</code>定一个特定标识的数据，<code>getMetadata</code>根据特定标识获取数据。这里<code>Reflect</code>用的比较简单就不深入了，<code>Reflect</code>是<code>es6</code>新特性一部分。</p>
<p>在<code>Nest</code>的装饰器大量使用<code>Reflect</code>。在<code>nodejs</code>使用，需要借助<code>reflect-metadata</code>，引入方式<code>import &#39;reflect-metadata&#39;;</code>。</p>
<p>处理完了，dot 问题，那么我们接下来要处理异常捕获过滤器问题了。</p>
<p>前面也说，<code>Nest</code>执行顺序：<code>客户端请求 ---&gt; 中间件 ---&gt; 守卫 ---&gt; 拦截器之前 ---&gt; 管道 ---&gt; 控制器处理并响应 ---&gt; 拦截器之后 ---&gt; 过滤器</code>。</p>
<p>因为<code>ValidationPipe</code>源码里，只要验证错误就直接抛异常<code>new BadRequestException()</code>，然后就直接跳过控制器处理并响应，走拦截器之后和过滤器了。</p>
<p>那么我们需要在过滤器来处理这些问题，这是为什么要这么麻烦原因。</p>
<p><code>Nest</code>已经提供一个自定义<code>HttpExceptionFilter</code>的栗子，我们需要改良一下这个栗子。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-meta">@Catch</span>(<span class="hljs-title class_">HttpException</span>)<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HttpExceptionFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ExceptionFilter</span> &#123;<br>  <span class="hljs-keyword">catch</span>(<span class="hljs-attr">exception</span>: <span class="hljs-title class_">HttpException</span>, <span class="hljs-attr">host</span>: <span class="hljs-title class_">ArgumentsHost</span>) &#123;<br>    <span class="hljs-keyword">const</span> ctx = host.<span class="hljs-title function_">switchToHttp</span>()<br>    <span class="hljs-keyword">const</span> <span class="hljs-attr">response</span>: <span class="hljs-title class_">Response</span> = ctx.<span class="hljs-title function_">getResponse</span>()<br>    <span class="hljs-keyword">const</span> <span class="hljs-attr">request</span>: <span class="hljs-title class_">Request</span> = ctx.<span class="hljs-title function_">getRequest</span>()<br>    <span class="hljs-keyword">const</span> status = exception.<span class="hljs-title function_">getStatus</span>()<br>    <span class="hljs-comment">// 如果错误码 400</span><br>    <span class="hljs-keyword">if</span> (status === <span class="hljs-title class_">HttpStatus</span>.<span class="hljs-property">BAD_REQUEST</span>) &#123;<br>      <span class="hljs-keyword">const</span> render = <span class="hljs-title function_">validationErrorMessage</span>(exception.<span class="hljs-property">message</span>.<span class="hljs-property">message</span>)<br>      <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">render</span>(render.<span class="hljs-property">view</span>, render.<span class="hljs-property">locals</span>)<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>render</code>接受 3 个参数，平常只用前个，第一个是模板路径或者模板，第二个提供给模板显示的数据。</p>
<p>这里核心地方在<code>validationErrorMessage</code>里：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">validationErrorMessage</span>(<span class="hljs-params">messages: ValidationError[]</span>): <span class="hljs-title class_">Render</span> &#123;<br>  <span class="hljs-keyword">const</span> <span class="hljs-attr">message</span>: <span class="hljs-title class_">ValidationError</span> = messages[<span class="hljs-number">0</span>]<br>  <span class="hljs-keyword">const</span> <span class="hljs-attr">metadata</span>: <span class="hljs-title class_">ValidatorFilterContext</span> = <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">getMetadata</span>(<span class="hljs-variable constant_">VALIDATOR_FILTER</span>, message.<span class="hljs-property">target</span>.<span class="hljs-property">constructor</span>)<br>  <span class="hljs-keyword">if</span> (!metadata) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;context is not undefined, use @ValidatorFilter(context)&#x27;</span>)<br>  &#125;<br>  <span class="hljs-comment">// 处理错误消息显示</span><br>  <span class="hljs-keyword">const</span> priorities = metadata.<span class="hljs-property">priority</span>[message.<span class="hljs-property">property</span>] || []<br>  <span class="hljs-keyword">let</span> error = <span class="hljs-string">&#x27;&#x27;</span><br>  <span class="hljs-keyword">const</span> notFound = priorities.<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> &#123;<br>    key = key.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\b(\w)(\w*)/g</span>, <span class="hljs-function">(<span class="hljs-params">$0, $1, $2</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">return</span> $1.<span class="hljs-title function_">toLowerCase</span>() + $2<br>    &#125;)<br>    <span class="hljs-keyword">if</span> (!!message.<span class="hljs-property">constraints</span>[key]) &#123;<br>      error = message.<span class="hljs-property">constraints</span>[key]<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>    &#125;<br>  &#125;)<br>  <span class="hljs-comment">// 没有找到对应错误消息，取第一个</span><br>  <span class="hljs-keyword">if</span> (!notFound) &#123;<br>    error = message.<span class="hljs-property">constraints</span>[<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(message.<span class="hljs-property">constraints</span>)[<span class="hljs-number">0</span>]]<br>  &#125;<br>  <span class="hljs-comment">// 处理错误以后显示数据</span><br>  <span class="hljs-keyword">const</span> locals = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(metadata.<span class="hljs-property">locals</span>).<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">obj, key</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (metadata.<span class="hljs-property">locals</span>[key]) &#123;<br>      obj[key] = message.<span class="hljs-property">target</span>[key]<br>    &#125;<br>    <span class="hljs-keyword">return</span> obj<br>  &#125;, &#123;&#125;)<br><br>  <span class="hljs-keyword">return</span> &#123;<br>    <span class="hljs-attr">view</span>: metadata.<span class="hljs-property">render</span>,<br>    <span class="hljs-attr">locals</span>: &#123;<br>      error,<br>      ...locals,<br>    &#125;,<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>我们拿到的<code>messages</code>是一个数组，我们每次只显示一个错误消息，总是取第一个即可</li>
<li><code>metadata</code>是我们根据标识获取的元数据，如果找不到，就抛出异常。<strong>注意</strong>：<code>message.target</code>是一个<code>&#123;&#125;</code>，我们需要获取它的<code>constructor</code>才行。</li>
<li><code>priorities</code>获取当前错误字段显示错误提取的优先级列表</li>
<li><code>priority</code>里面没有配置获取配置<code>[]</code>, 就直接返回验证规则第一个。<strong>提示</strong>：这也是<code>&#123;&#125;</code>坑，默认按字母顺序排列属性的位置。</li>
<li><code>locals</code>直接去判断配置的<code>locals</code>，哪些<code>key</code>可以显示哪些<code>key</code>不能显示。</li>
<li>最后数据拼装在一起返回，供<code>render</code>使用。</li>
</ul>
<h3 id="自定义装饰器-自定义ViewValidationPipe实现"><a href="#自定义装饰器-自定义ViewValidationPipe实现" class="headerlink" title="自定义装饰器+自定义ViewValidationPipe实现"></a>自定义装饰器+自定义<code>ViewValidationPipe</code>实现</h3><p>装饰器部分就不用说了，和上面一样，虽然不需要但是后面有用。</p>
<p><code>ViewValidationPipe</code>实现：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Injectable</span>, <span class="hljs-title class_">Optional</span>, <span class="hljs-title class_">ArgumentMetadata</span>, <span class="hljs-title class_">PipeTransform</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/common&#x27;</span><br><br><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> classTransformer <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;class-transformer&#x27;</span><br><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> classValidator <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;class-validator&#x27;</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">ValidatorOptions</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/common/interfaces/external/validator-options.interface&#x27;</span><br><br><span class="hljs-keyword">import</span> &#123; isNil &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;lodash&#x27;</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">ValidationError</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;class-validator&#x27;</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-variable constant_">VALIDATOR_FILTER</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../constants/validator-filter.constants&#x27;</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">ValidatorFilterContext</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../decorators&#x27;</span><br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ValidationPipeOptions</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ValidatorOptions</span> &#123;<br>  transform?: <span class="hljs-built_in">boolean</span><br>  disableErrorMessages?: <span class="hljs-built_in">boolean</span><br>&#125;<br><br><span class="hljs-meta">@Injectable</span>()<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewValidationPipe</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">PipeTransform</span>&lt;<span class="hljs-built_in">any</span>&gt; &#123;<br>  <span class="hljs-keyword">protected</span> <span class="hljs-attr">isTransformEnabled</span>: <span class="hljs-built_in">boolean</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-attr">isDetailedOutputDisabled</span>: <span class="hljs-built_in">boolean</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-attr">validatorOptions</span>: <span class="hljs-title class_">ValidatorOptions</span><br><br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-meta">@Optional</span>() options?: ValidationPipeOptions</span>) &#123;<br>    options = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<br>      &#123;<br>        <span class="hljs-attr">transform</span>: <span class="hljs-literal">true</span>,<br>        <span class="hljs-attr">whitelist</span>: <span class="hljs-literal">true</span>,<br>        <span class="hljs-attr">forbidNonWhitelisted</span>: <span class="hljs-literal">true</span>,<br>        <span class="hljs-attr">skipMissingProperties</span>: <span class="hljs-literal">false</span>,<br>        <span class="hljs-attr">forbidUnknownValues</span>: <span class="hljs-literal">true</span>,<br>      &#125;,<br>      options || &#123;&#125;<br>    )<br>    <span class="hljs-keyword">const</span> &#123; transform, disableErrorMessages, ...validatorOptions &#125; = options<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isTransformEnabled</span> = !!transform<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">validatorOptions</span> = validatorOptions<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isDetailedOutputDisabled</span> = disableErrorMessages<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">transform</span>(<span class="hljs-params">value, metadata: ArgumentMetadata</span>) &#123;<br>    <span class="hljs-keyword">const</span> &#123; metatype &#125; = metadata<br>    <span class="hljs-keyword">if</span> (!metatype || !<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">toValidate</span>(metadata)) &#123;<br>      <span class="hljs-keyword">return</span> value<br>    &#125;<br>    <span class="hljs-keyword">const</span> entity = classTransformer.<span class="hljs-title function_">plainToClass</span>(metatype, <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">toEmptyIfNil</span>(value))<br>    <span class="hljs-keyword">const</span> errors = <span class="hljs-keyword">await</span> classValidator.<span class="hljs-title function_">validate</span>(entity, <span class="hljs-variable language_">this</span>.<span class="hljs-property">validatorOptions</span>)<br>    <span class="hljs-comment">// 重点实现 start</span><br>    <span class="hljs-keyword">if</span> (errors.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-title function_">validationErrorMessage</span>(errors).<span class="hljs-property">locals</span><br>    &#125;<br>    <span class="hljs-comment">// 重点实现 end</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">isTransformEnabled</span><br>      ? entity<br>      : <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">validatorOptions</span>).<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span><br>      ? classTransformer.<span class="hljs-title function_">classToPlain</span>(entity)<br>      : value<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">toValidate</span>(<span class="hljs-attr">metadata</span>: <span class="hljs-title class_">ArgumentMetadata</span>): <span class="hljs-built_in">boolean</span> &#123;<br>    <span class="hljs-keyword">const</span> &#123; metatype, <span class="hljs-keyword">type</span> &#125; = metadata<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">type</span> === <span class="hljs-string">&#x27;custom&#x27;</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>    &#125;<br>    <span class="hljs-keyword">const</span> types = [<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Boolean</span>, <span class="hljs-title class_">Number</span>, <span class="hljs-title class_">Array</span>, <span class="hljs-title class_">Object</span>]<br>    <span class="hljs-keyword">return</span> !types.<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> metatype === t) &amp;&amp; !<span class="hljs-title function_">isNil</span>(metatype)<br>  &#125;<br><br>  toEmptyIfNil&lt;T = <span class="hljs-built_in">any</span>, R = <span class="hljs-built_in">any</span>&gt;(<span class="hljs-attr">value</span>: T): R | &#123;&#125; &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_">isNil</span>(value) ? &#123;&#125; : value<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>我们这里把<code>validationErrorMessage</code>函数直接拿过来了。</p>
<p>控制器就需要这么写：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-meta">@Post</span>(<span class="hljs-string">&#x27;/register&#x27;</span>)<br><span class="hljs-meta">@Render</span>(<span class="hljs-title class_">ViewsPath</span>.<span class="hljs-property">Register</span>)<br><span class="hljs-keyword">async</span> <span class="hljs-title function_">register</span>(<span class="hljs-params"><span class="hljs-meta">@Body</span>(<span class="hljs-keyword">new</span> ViewValidationPipe(&#123;</span><br><span class="hljs-params">    transform: <span class="hljs-literal">true</span>,</span><br><span class="hljs-params">    whitelist: <span class="hljs-literal">true</span>,</span><br><span class="hljs-params">    forbidNonWhitelisted: <span class="hljs-literal">true</span>,</span><br><span class="hljs-params">    skipMissingProperties: <span class="hljs-literal">false</span>,</span><br><span class="hljs-params">    forbidUnknownValues: <span class="hljs-literal">true</span>,</span><br><span class="hljs-params">&#125;)) register: RegisterDto</span>) &#123;<br>    <span class="hljs-keyword">if</span> ((register <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>).<span class="hljs-property">view</span>) &#123;<br>        <span class="hljs-keyword">return</span> register.<span class="hljs-property">locals</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">authService</span>.<span class="hljs-title function_">register</span>(register);<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>拿到是<code>pipe</code>转换后的结果</li>
<li>如果有<code>view</code>表示出错了，就直接返回<code>locals</code>，如果没有就接着处理服务逻辑。</li>
</ul>
<p><strong>注意</strong>：<code>(register as any).view</code>这个<code>view</code>是不靠谱的，需要返回一个特殊标识，不然页面出现一个<code>view</code>字段，就挂了。</p>
<p>这里我们使用第一种，接着实现服务逻辑。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs ts">...<br><span class="hljs-keyword">async</span> <span class="hljs-title function_">register</span>(<span class="hljs-params">register: RegisterDto</span>) &#123;<br>    <span class="hljs-keyword">const</span> &#123; loginname, email &#125; = register;<br>    <span class="hljs-comment">// 检查用户是否存在，查询登录名和邮箱</span><br>    <span class="hljs-keyword">const</span> exist = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">userService</span>.<span class="hljs-title function_">count</span>(&#123;<br>        <span class="hljs-attr">$or</span>: [<br>            &#123; loginname &#125;,<br>            &#123; email &#125;,<br>        ],<br>    &#125;);<br>    <span class="hljs-comment">// 返回1存在，0不存在</span><br>    <span class="hljs-keyword">if</span> (exist) &#123;<br>        <span class="hljs-keyword">return</span> &#123;<br>            <span class="hljs-attr">error</span>: <span class="hljs-string">&#x27;用户名或邮箱已被使用。&#x27;</span>,<br>            loginname,<br>            email,<br>        &#125;;<br>    &#125;<br>    <span class="hljs-comment">// hash加密密码，不能明文存储到数据库</span><br>    <span class="hljs-keyword">const</span> passhash = <span class="hljs-title function_">hashSync</span>(register.<span class="hljs-property">pass</span>, <span class="hljs-number">10</span>);<br>    <span class="hljs-comment">// 错误捕获 async/await 科普已经说明</span><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// 保存用户到数据库</span><br>        <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">userService</span>.<span class="hljs-title function_">create</span>(&#123; loginname, email, <span class="hljs-attr">pass</span>: passhash &#125;);<br>        <span class="hljs-comment">// 预留发送激活邮箱实现</span><br><br>        <span class="hljs-comment">// 返回注册成功信息</span><br>        <span class="hljs-keyword">return</span> &#123;<br>            <span class="hljs-attr">success</span>: <span class="hljs-string">`欢迎加入 <span class="hljs-subst">$&#123;Config.name&#125;</span>！我们已给您的注册邮箱发送了一封邮件，请点击里面的链接来激活您的帐号。`</span>,<br>        &#125;;<br>    &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InternalServerErrorException</span>(error);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>里面注释也说明的我们要操作的步骤，注册逻辑还是比较简单：</p>
<ul>
<li>验证参数是否合法</li>
<li>查询用户是否注册</li>
<li>加密密码</li>
<li>保存到数据库</li>
<li>发送激活邮箱</li>
<li>返回注册成功信息</li>
</ul>
<p>做登录之前完成邮箱激活的功能。</p>
<h3 id="邮箱模块"><a href="#邮箱模块" class="headerlink" title="邮箱模块"></a>邮箱模块</h3><p>前面基础已经介绍过<code>nest</code>模块，这里邮箱模块是一个通用的功能模块，我们需要抽离出来写成可配置的动态模块。<code>nest</code>目前没有提供发邮箱的功能模块，我们只能自己动手写了，<code>nodejs</code>发送邮件最出名使用<a target="_blank" rel="noopener" href="https://nodemailer.com/about/">node-mailer</a>。我们这里也把<code>node-mailer</code>封装一下。</p>
<p>对于一个没有写过动态模块的我，是一脸懵逼，还好作者写很多包装的功能模块：</p>
<ul>
<li>graphql</li>
<li>typeorm</li>
<li>terminus</li>
<li>passport</li>
<li>elasticsearch</li>
<li>mongoose</li>
<li>jwt</li>
<li>cqrs</li>
</ul>
<p>既然不会写我们可以 copy 一个来仿写，实现我们要功能就 ok 了，卷起袖子就是干。</p>
<p>通过观察上面几个模块他们文件结构都是这样的：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs ts">index.<span class="hljs-property">ts</span> <span class="hljs-comment">// 导出快捷文件</span><br>mailer - options.<span class="hljs-property">interface</span>.<span class="hljs-property">ts</span> <span class="hljs-comment">// 定义配置接口</span><br>mailer.<span class="hljs-property">constants</span>.<span class="hljs-property">ts</span> <span class="hljs-comment">// 定义常量</span><br>mailer.<span class="hljs-property">providers</span>.<span class="hljs-property">ts</span> <span class="hljs-comment">// 定义供应商</span><br>mailer.<span class="hljs-property">module</span>.<span class="hljs-property">ts</span> <span class="hljs-comment">// 定义导出模块</span><br>mailer.<span class="hljs-property">decorators</span>.<span class="hljs-property">ts</span> <span class="hljs-comment">// 定义装饰器</span><br></code></pre></td></tr></table></figure>

<p>我们也来新建一个这样的结构，<code>core/mailer</code>建文件就不说了。</p>
<p>这一个模块，就需要先从模块开始：</p>
<ul>
<li>动态可配置模块，而且还是全局模块，只需要导入一次即可。</li>
<li>同步配置可以是直接填写，异步配置可以是依赖其他模块</li>
</ul>
<p>这是我们要实现的 2 个重要功能，作者写的模块基本是这个套路，有些东西我们不会写，可以先模仿。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">DynamicModule</span>, <span class="hljs-title class_">Module</span>, <span class="hljs-title class_">Provider</span>, <span class="hljs-title class_">Global</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/common&#x27;</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">MailerModuleAsyncOptions</span>, <span class="hljs-title class_">MailerOptionsFactory</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./mailer-options.interface&#x27;</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">MailerService</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./mailer.service&#x27;</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-variable constant_">MAILER_MODULE_OPTIONS</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./mailer.constants&#x27;</span><br><span class="hljs-keyword">import</span> &#123; createMailerClient &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./mailer.provider&#x27;</span><br><br><span class="hljs-meta">@Module</span>(&#123;&#125;)<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MailerModule</span> &#123;<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 同步引导邮箱模块</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> options 邮箱模块的选项</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">static</span> forRoot&lt;T&gt;(<span class="hljs-attr">options</span>: T): <span class="hljs-title class_">DynamicModule</span> &#123;<br>    <span class="hljs-keyword">return</span> &#123;<br>      <span class="hljs-attr">module</span>: <span class="hljs-title class_">MailerModule</span>,<br>      <span class="hljs-attr">providers</span>: [&#123; <span class="hljs-attr">provide</span>: <span class="hljs-variable constant_">MAILER_MODULE_OPTIONS</span>, <span class="hljs-attr">useValue</span>: options &#125;, createMailerClient&lt;T&gt;(), <span class="hljs-title class_">MailerService</span>],<br>      <span class="hljs-attr">exports</span>: [<span class="hljs-title class_">MailerService</span>],<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 异步引导邮箱模块</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> options 邮箱模块的选项</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">static</span> forRootAsync&lt;T&gt;(<span class="hljs-attr">options</span>: <span class="hljs-title class_">MailerModuleAsyncOptions</span>&lt;T&gt;): <span class="hljs-title class_">DynamicModule</span> &#123;<br>    <span class="hljs-keyword">return</span> &#123;<br>      <span class="hljs-attr">module</span>: <span class="hljs-title class_">MailerModule</span>,<br>      <span class="hljs-attr">imports</span>: options.<span class="hljs-property">imports</span> || [],<br>      <span class="hljs-attr">providers</span>: [...<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createAsyncProviders</span>(options), createMailerClient&lt;T&gt;(), <span class="hljs-title class_">MailerService</span>],<br>      <span class="hljs-attr">exports</span>: [<span class="hljs-title class_">MailerService</span>],<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><code>forRoot</code>配置同步模块</li>
<li><code>forRootAsync</code>配置异步模块</li>
</ul>
<p>我们先说和<code>node-mailer</code>相关的，<code>node-mailer</code>主要分 2 块：</p>
<ul>
<li>创建<code>node-mailer</code>实例，<code>node-mailer</code>新版解决很多问题，自动去识别不同邮件配置，这对我们来说是一个非常好的消息，不用去做各种适配配置了，只需要按官网的相关配置即可。</li>
<li>使用<code>node-mailer</code>实例，<code>set</code>设置配置和<code>use</code>注册插件，<code>sendMail</code>发送邮件</li>
</ul>
<p>创建在<code>createMailerClient</code>方法里面完成</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">import</span> &#123; <span class="hljs-variable constant_">MAILER_MODULE_OPTIONS</span>, <span class="hljs-variable constant_">MAILER_TOKEN</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./mailer.constants&#x27;</span><br><span class="hljs-keyword">import</span> &#123; createTransport &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;nodemailer&#x27;</span><br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> createMailerClient = &lt;T&gt;<span class="hljs-function">() =&gt;</span> (&#123;<br>  <span class="hljs-attr">provide</span>: <span class="hljs-variable constant_">MAILER_TOKEN</span>,<br>  <span class="hljs-attr">useFactory</span>: <span class="hljs-function">(<span class="hljs-params">options: T</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_">createTransport</span>(options)<br>  &#125;,<br>  <span class="hljs-attr">inject</span>: [<span class="hljs-variable constant_">MAILER_MODULE_OPTIONS</span>],<br>&#125;)<br></code></pre></td></tr></table></figure>

<p>这个方法是一个工厂方法，在介绍这个方法之前，先要回顾一下，<code>nest</code>依赖注入自定义服务：</p>
<ul>
<li>Use value</li>
</ul>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">const</span> connectionProvider = &#123;<br>  <span class="hljs-attr">provide</span>: <span class="hljs-string">&#x27;Connection&#x27;</span>,<br>  <span class="hljs-attr">useValue</span>: connection,<br>&#125;<br></code></pre></td></tr></table></figure>

<p>值服务：这个一般作为配置，定义全局常量使用，单纯<code>key-value</code>形式</p>
<ul>
<li>Use class</li>
</ul>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">const</span> configServiceProvider = &#123;<br>  <span class="hljs-attr">provide</span>: <span class="hljs-title class_">ConfigService</span>,<br>  <span class="hljs-attr">useClass</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">&#x27;development&#x27;</span> ? <span class="hljs-title class_">DevelopmentConfigService</span> : <span class="hljs-title class_">ProductionConfigService</span>,<br>&#125;<br></code></pre></td></tr></table></figure>

<p>类服务：这个比较常用，默认就是类服务，如果<code>provide</code>和<code>useClass</code>一样，直接注册在<code>providers</code>数组里即可。我们只关心<code>provide</code>注入是谁，不关心<code>useClass</code>依赖谁。</p>
<ul>
<li>Use factory</li>
</ul>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">const</span> connectionFactory = &#123;<br>  <span class="hljs-attr">provide</span>: <span class="hljs-string">&#x27;Connection&#x27;</span>,<br>  <span class="hljs-attr">useFactory</span>: <span class="hljs-function">(<span class="hljs-params">optionsProvider: OptionsProvider</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> options = optionsProvider.<span class="hljs-title function_">get</span>()<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DatabaseConnection</span>(options)<br>  &#125;,<br>  <span class="hljs-attr">inject</span>: [<span class="hljs-title class_">OptionsProvider</span>],<br>&#125;<br></code></pre></td></tr></table></figure>

<p>工厂服务：这个比较高级，一般需要依赖其他服务，来创建当前服务的时候，操作使用。定制服务经常用到。</p>
<p>我们在回过头来说上面这个<code>createMailerClient</code>方法</p>
<p>本来我们可以直接写出一个<code>Use factory</code>例子一样的，考虑它需要<code>forRoot</code>和<code>forRootAsync</code>都需要使用，我们写成一个函数，使用时候直接调用即可，也可以写成一个对象形式。</p>
<p><code>provide</code>引入我们定义的常量，至于这个常量是什么，我们不需要关心，如果它变化这个注入者也发生变化，这里不需要改任何代码。也算是配置和程序分离，一种比较好编程方式。</p>
<p><code>inject</code>依赖其他服务，这里依赖是一个<code>useValue</code>服务，我们把邮箱配置传递给<code>MAILER_MODULE_OPTIONS</code>，然后把它放到<code>inject</code>，这样我们在<code>useFactory</code>方法里面就可以取到依赖列表。</p>
<p><strong>注意</strong>：<code>inject</code>是一个数组，<code>useFactory</code>参数和<code>inject</code>一一对应，简单理解，<code>useFactory</code>是形参，<code>inject</code>数组是实参。</p>
<p>在<code>useFactory</code>里面，我们可以根据参数做相关的操作，这里我们直接获取这个服务即可，然后使用<code>nodemailer</code>提供的邮件创建方法<code>createTransport</code>即可。</p>
<p>依赖注入和服务重点，我不关心依赖者怎么处理，我只关心注入者给我提供什么。</p>
<p>我们在来说上面这个<code>MAILER_MODULE_OPTIONS</code>值服务</p>
<p><code>MAILER_MODULE_OPTIONS</code>在<code>forRoot</code>里是一个值服务<code>&#123; provide: MAILER_MODULE_OPTIONS, useValue: options &#125;</code>，保存传递的参数。<br><code>MAILER_MODULE_OPTIONS</code>在<code>forRootAsync</code>里是一个特殊处理<code>...this.createAsyncProviders(options)</code>，后面会讲解这个函数。</p>
<p><strong>注意</strong>：因为<code>createMailerClient</code>依赖它，所以一定要在<code>createMailerClient</code>方法完成注册。</p>
<p>说完通用的创建服务，来说<code>forRootAsync</code>里的<code>createAsyncProviders</code>方法：</p>
<p><code>createAsyncProviders</code>主要完成的工作是把邮箱配置和邮箱动态模块配置剥离开来，然后根据给定要求分别去处理。</p>
<p><code>createAsyncProviders</code>方法</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据给定的模块选项返回异步提供程序</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> options 邮箱模块的选项</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> createAsyncProviders&lt;T&gt;(<br>    <span class="hljs-attr">options</span>: <span class="hljs-title class_">MailerModuleAsyncOptions</span>&lt;T&gt;,<br>): <span class="hljs-title class_">Provider</span>[] &#123;<br>    <span class="hljs-keyword">if</span> (options.<span class="hljs-property">useFactory</span>) &#123;<br>        <span class="hljs-keyword">return</span> [<span class="hljs-variable language_">this</span>.<span class="hljs-property">createAsyncOptionsProvider</span>&lt;T&gt;(options)];<br>    &#125;<br>    <span class="hljs-keyword">return</span> [<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createAsyncOptionsProvider</span>(options),<br>        &#123;<br>            <span class="hljs-attr">provide</span>: options.<span class="hljs-property">useClass</span>,<br>            <span class="hljs-attr">useClass</span>: options.<span class="hljs-property">useClass</span>,<br>        &#125;,<br>    ];<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据给定的模块选项返回异步邮箱选项提供程序</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> options 邮箱模块的选项</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> createAsyncOptionsProvider&lt;T&gt;(<br>    <span class="hljs-attr">options</span>: <span class="hljs-title class_">MailerModuleAsyncOptions</span>&lt;T&gt;,<br>): <span class="hljs-title class_">Provider</span> &#123;<br>    <span class="hljs-keyword">if</span> (options.<span class="hljs-property">useFactory</span>) &#123;<br>        <span class="hljs-keyword">return</span> &#123;<br>            <span class="hljs-attr">provide</span>: <span class="hljs-variable constant_">MAILER_MODULE_OPTIONS</span>,<br>            <span class="hljs-attr">useFactory</span>: options.<span class="hljs-property">useFactory</span>,<br>            <span class="hljs-attr">inject</span>: options.<span class="hljs-property">inject</span> || [],<br>        &#125;;<br>    &#125;<br>    <span class="hljs-keyword">return</span> &#123;<br>        <span class="hljs-attr">provide</span>: <span class="hljs-variable constant_">MAILER_MODULE_OPTIONS</span>,<br>        <span class="hljs-attr">useFactory</span>: <span class="hljs-keyword">async</span> (<span class="hljs-attr">optionsFactory</span>: <span class="hljs-title class_">MailerOptionsFactory</span>&lt;T&gt;) =&gt; <span class="hljs-keyword">await</span> optionsFactory.<span class="hljs-title function_">createMailerOptions</span>(),<br>        <span class="hljs-attr">inject</span>: [options.<span class="hljs-property">useClass</span>],<br>    &#125;;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>解释这个函数之前，先看配置参数有接口：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">MailerModuleAsyncOptions</span>&lt;T&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Pick</span>&lt;<span class="hljs-title class_">ModuleMetadata</span>, &#x27;imports&#x27;&gt; &#123;<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 模块的名称</span><br><span class="hljs-comment">   */</span><br>  name?: <span class="hljs-built_in">string</span><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 应该用于提供MailerOptions的类</span><br><span class="hljs-comment">   */</span><br>  useClass?: <span class="hljs-title class_">Type</span>&lt;T&gt;<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 工厂应该用来提供MailerOptions</span><br><span class="hljs-comment">   */</span><br>  useFactory?: <span class="hljs-function">(<span class="hljs-params">...args: <span class="hljs-built_in">any</span>[]</span>) =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;T&gt; | T<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 应该注入的提供者</span><br><span class="hljs-comment">   */</span><br>  inject?: <span class="hljs-built_in">any</span>[]<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里面支持 2 种写法，一种是自定义类，然后使用<code>useClass</code>, 一种是自定义工厂，然后使用<code>useFactory</code>。</p>
<p>使用在<code>MailerService</code>服务里面完成并且把它导出给其他模块使用</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Inject</span>, <span class="hljs-title class_">Injectable</span>, <span class="hljs-title class_">Logger</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/common&#x27;</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-variable constant_">MAILER_TOKEN</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./mailer.constants&#x27;</span><br><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-title class_">Mail</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;nodemailer/lib/mailer&#x27;</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Options</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">MailMessageOptions</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;nodemailer/lib/mailer&#x27;</span><br><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-keyword">from</span>, <span class="hljs-title class_">Observable</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;rxjs&#x27;</span><br><span class="hljs-keyword">import</span> &#123; tap, retryWhen, scan, delay &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;rxjs/operators&#x27;</span><br><br><span class="hljs-keyword">const</span> logger = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Logger</span>(<span class="hljs-string">&#x27;MailerModule&#x27;</span>)<br><br><span class="hljs-meta">@Injectable</span>()<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MailerService</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-meta">@Inject</span>(MAILER_TOKEN) <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> mailer: Mail</span>) &#123;&#125;<br>  <span class="hljs-comment">// 注册插件</span><br>  <span class="hljs-title function_">use</span>(<span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">pluginFunc</span>: <span class="hljs-function">(<span class="hljs-params">...args</span>) =&gt;</span> <span class="hljs-built_in">any</span>): <span class="hljs-title class_">ThisType</span>&lt;<span class="hljs-title class_">MailerService</span>&gt; &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">mailer</span>.<span class="hljs-title function_">use</span>(name, pluginFunc)<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span><br>  &#125;<br><br>  <span class="hljs-comment">// 设置配置</span><br>  <span class="hljs-title function_">set</span>(<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">handler</span>: <span class="hljs-function">(<span class="hljs-params">...args</span>) =&gt;</span> <span class="hljs-built_in">any</span>): <span class="hljs-title class_">ThisType</span>&lt;<span class="hljs-title class_">MailerService</span>&gt; &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">mailer</span>.<span class="hljs-title function_">set</span>(key, handler)<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span><br>  &#125;<br><br>  <span class="hljs-comment">// 发送邮件配置</span><br>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">send</span>(<span class="hljs-attr">mailMessage</span>: <span class="hljs-title class_">MailMessageOptions</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">any</span>&gt; &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-title function_">from</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mailer</span>.<span class="hljs-title function_">sendMail</span>(mailMessage))<br>      .<span class="hljs-title function_">pipe</span>(<br>        <span class="hljs-title function_">handleRetry</span>(),<br>        <span class="hljs-title function_">tap</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>          logger.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;send mail success&#x27;</span>)<br>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">mailer</span>.<span class="hljs-title function_">close</span>()<br>        &#125;)<br>      )<br>      .<span class="hljs-title function_">toPromise</span>()<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleRetry</span>(<span class="hljs-params">retryAttempts = <span class="hljs-number">5</span>, retryDelay = <span class="hljs-number">3000</span></span>): &lt;T&gt;<span class="hljs-function">(<span class="hljs-params">source: Observable&lt;T&gt;</span>) =&gt;</span> <span class="hljs-title class_">Observable</span>&lt;T&gt; &#123;<br>  <span class="hljs-keyword">return</span> &lt;T&gt;<span class="hljs-function">(<span class="hljs-params">source: Observable&lt;T&gt;</span>) =&gt;</span><br>    source.<span class="hljs-title function_">pipe</span>(<br>      <span class="hljs-title function_">retryWhen</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span><br>        e.<span class="hljs-title function_">pipe</span>(<br>          <span class="hljs-title function_">scan</span>(<span class="hljs-function">(<span class="hljs-params">errorCount, error</span>) =&gt;</span> &#123;<br>            logger.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Unable to connect to the database. Retrying (<span class="hljs-subst">$&#123;errorCount + <span class="hljs-number">1</span>&#125;</span>)...`</span>)<br>            <span class="hljs-keyword">if</span> (errorCount + <span class="hljs-number">1</span> &gt;= retryAttempts) &#123;<br>              logger.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;send mail finally error&#x27;</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(error))<br>              <span class="hljs-keyword">throw</span> error<br>            &#125;<br>            <span class="hljs-keyword">return</span> errorCount + <span class="hljs-number">1</span><br>          &#125;, <span class="hljs-number">0</span>),<br>          <span class="hljs-title function_">delay</span>(retryDelay)<br>        )<br>      )<br>    )<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>@Inject</code>是一个注入器，接受一个<code>provide</code>标识、令牌，这里我们拿到了<code>node-mailer</code>实例</p>
<p><code>send</code>方法使用<code>rxjs</code>写法，<code>this.mailer.sendMail(mailMessage)</code>返回是一个<code>Promise</code>，<code>Promise</code>有一些缺陷，<code>rxjs</code>可以去弥补一下这些缺陷。</p>
<p>比如这里使用是 rxjs 作用就是，<code>handleRetry()</code>去判断发送有没有错误，如果有错误，就去重试，默认重试 5 次，如果还错误就直接抛出异常。<code>tap()</code>类似一个<code>console</code>，不会去改变数据流。<br>有 2 个参数，第一个是无错误的处理函数，第二个是有错误的处理函数。如果发送成功我们需要关闭连接。<code>toPromise</code>就更简单了，看名字也知道，把<code>rxjs</code>转成<code>Promise</code>。</p>
<p>介绍完这个这个模块，那么接下来要说一下怎么使用它们：</p>
<p>模块注册：我们需要在核心模块里面<code>imports</code>，因为邮件需要一些配置信息，比如邮件地址，端口号，发送邮件的用户和授权码，如果不知道邮箱配置可<a target="_blank" rel="noopener" href="https://nodemailer.com/about/">参考 nodemailer 官网</a>。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-title class_">MailerModule</span>.<span class="hljs-property">forRootAsync</span>&lt;<span class="hljs-title class_">SMTPTransportOptions</span>&gt;(&#123;<br>    <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">ConfigModule</span>],<br>    <span class="hljs-attr">useFactory</span>: <span class="hljs-keyword">async</span> (<span class="hljs-attr">configService</span>: <span class="hljs-title class_">ConfigService</span>) =&gt; &#123;<br>        <span class="hljs-keyword">const</span> mailer = configService.<span class="hljs-title function_">getKeys</span>([<span class="hljs-string">&#x27;MAIL_HOST&#x27;</span>, <span class="hljs-string">&#x27;MAIL_PORT&#x27;</span>, <span class="hljs-string">&#x27;MAIL_USER&#x27;</span>, <span class="hljs-string">&#x27;MAIL_PASS&#x27;</span>]);<br>        <span class="hljs-keyword">return</span> &#123;<br>            <span class="hljs-attr">host</span>: mailer.<span class="hljs-property">MAIL_HOST</span>,     <span class="hljs-comment">// 邮箱smtp地址</span><br>            <span class="hljs-attr">port</span>: mailer.<span class="hljs-property">MAIL_PORT</span> * <span class="hljs-number">1</span>, <span class="hljs-comment">// 端口号</span><br>            <span class="hljs-attr">secure</span>: <span class="hljs-literal">true</span>,<br>            <span class="hljs-attr">secureConnection</span>: <span class="hljs-literal">true</span>,<br>            <span class="hljs-attr">auth</span>: &#123;<br>                <span class="hljs-attr">user</span>: mailer.<span class="hljs-property">MAIL_USER</span>,  <span class="hljs-comment">// 邮箱账号</span><br>                <span class="hljs-attr">pass</span>: mailer.<span class="hljs-property">MAIL_PASS</span>,  <span class="hljs-comment">// 授权码</span><br>            &#125;,<br>            <span class="hljs-attr">ignoreTLS</span>: <span class="hljs-literal">true</span>,<br>        &#125;;<br>    &#125;,<br>    <span class="hljs-attr">inject</span>: [<span class="hljs-title class_">ConfigService</span>],<br>&#125;),<br></code></pre></td></tr></table></figure>

<p>先使用注入依赖<code>ConfigService</code>，拿到配置服务，根据配置服务获取对应的配置。进行邮箱配置即可。</p>
<p>在页面怎么使用它们，因为本项目比较简单，只有 2 个地方需要使用邮箱，注册成功和找回密码时候，单独写一个<code>mail.services</code>服务去处理它们，并且模板里面内容除了用户名，token 等特定的数据是动态的，其他都是写死的。</p>
<p>mail.services</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 激活邮件</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> to 激活人邮箱</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> token token</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> username 名字</span><br><span class="hljs-comment"> */</span><br><span class="hljs-title function_">sendActiveMail</span>(<span class="hljs-params">to: <span class="hljs-built_in">string</span>, token: <span class="hljs-built_in">string</span>, username: <span class="hljs-built_in">string</span></span>)&#123;<br>    <span class="hljs-keyword">const</span> name = <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>;<br>    <span class="hljs-keyword">const</span> subject = <span class="hljs-string">`<span class="hljs-subst">$&#123;name&#125;</span>社区帐号激活`</span>;<br>    <span class="hljs-keyword">const</span> html = <span class="hljs-string">`&lt;p&gt;您好：<span class="hljs-subst">$&#123;username&#125;</span>&lt;/p&gt;</span><br><span class="hljs-string">        &lt;p&gt;我们收到您在<span class="hljs-subst">$&#123;name&#125;</span>社区的注册信息，请点击下面的链接来激活帐户：&lt;/p&gt;</span><br><span class="hljs-string">        &lt;a href=&quot;<span class="hljs-subst">$&#123;<span class="hljs-variable language_">this</span>.host&#125;</span>/active_account?key=<span class="hljs-subst">$&#123;token&#125;</span>&amp;name=<span class="hljs-subst">$&#123;username&#125;</span>&quot;&gt;激活链接&lt;/a&gt;</span><br><span class="hljs-string">        &lt;p&gt;若您没有在<span class="hljs-subst">$&#123;name&#125;</span>社区填写过注册信息，说明有人滥用了您的电子邮箱，请删除此邮件，我们对给您造成的打扰感到抱歉。&lt;/p&gt;</span><br><span class="hljs-string">        &lt;p&gt;<span class="hljs-subst">$&#123;name&#125;</span>社区 谨上。&lt;/p&gt;`</span>;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">mailer</span>.<span class="hljs-title function_">send</span>(&#123;<br>        <span class="hljs-attr">from</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">from</span>,<br>        to,<br>        subject,<br>        html,<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里是实现激活邮件方法，前面写的<code>mailer</code>模块，服务里面提供的<code>send</code>方法，接受四个最基本的参数。</p>
<ul>
<li><code>this.name</code>是配置里面获取的<code>name</code></li>
<li><code>this.from</code>是配置里面获取的数据，拼接而成，具体看源码</li>
<li><code>this.host</code>是配置里面获取的数据，拼接而成，具体看源码</li>
<li><code>from</code>邮件发起者，<code>to</code>邮件接收者，<code>subject</code>显示在邮件列表的标题，<code>html</code>邮件内容。</li>
</ul>
<p>我们在注册成功时候直接去调用它就好了。</p>
<p><strong>注意</strong>：我在本地测试，使用 163 邮箱作为发送者，用 qq 注册，就会被拦截，出现在垃圾邮箱里面。</p>
<h3 id="验证注册邮箱"><a href="#验证注册邮箱" class="headerlink" title="验证注册邮箱"></a>验证注册邮箱</h3><p>我们实现了发现邮箱的功能，接下来就来尝试验证走注册的功能及验证邮箱验证完成注册。</p>
<p>因为我只要一个发送邮箱的账号，和一个测试邮箱的的账号，我需要去数据库把我之前注册的账号删除了，从新完成注册。</p>
<p>填写信息，点击注册，就会发送一封邮件，是这个样子的：</p>
<p><a target="_blank" rel="noopener" href="https://user-images.githubusercontent.com/6111778/56122270-a04a2600-5fa4-11e9-9df1-82a32a593217.png"><img src="https://user-images.githubusercontent.com/6111778/56122270-a04a2600-5fa4-11e9-9df1-82a32a593217.png" srcset="/blog/img/loading.gif" lazyload alt="I1A1)WG%(TW 532FZ)(AME9"></a></p>
<p>点击<code>激活链接</code>链接跳回来激活账号：</p>
<p><a target="_blank" rel="noopener" href="https://user-images.githubusercontent.com/6111778/56122344-ce2f6a80-5fa4-11e9-84f9-93747d625a86.png">![2BAJ14WL_L}K{Z GZE{Q7`2](https://user-images.githubusercontent.com/6111778/56122344-ce2f6a80-5fa4-11e9-84f9-93747d625a86.png)</a></p>
<p>接下来我们就来实现<code>active_account</code>路由的逻辑</p>
<p>创建一个<code>account.dto</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-meta">@ValidatorFilter</span>(&#123;<br>  <span class="hljs-attr">render</span>: <span class="hljs-title class_">ViewsPath</span>.<span class="hljs-property">Notify</span>,<br>  <span class="hljs-attr">locals</span>: &#123;<br>    <span class="hljs-attr">name</span>: <span class="hljs-literal">true</span>,<br>    <span class="hljs-attr">key</span>: <span class="hljs-literal">true</span>,<br>  &#125;,<br>  <span class="hljs-attr">priority</span>: &#123;<br>    <span class="hljs-attr">name</span>: [<span class="hljs-string">&#x27;IsNotEmpty&#x27;</span>],<br>    <span class="hljs-attr">key</span>: [<span class="hljs-string">&#x27;IsNotEmpty&#x27;</span>],<br>  &#125;,<br>&#125;)<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AccountDto</span> &#123;<br>  <span class="hljs-meta">@IsNotEmpty</span>(&#123;<br>    <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;name不能为空&#x27;</span>,<br>  &#125;)<br>  <span class="hljs-meta">@Transform</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> value.<span class="hljs-title function_">toLowerCase</span>(), &#123; <span class="hljs-attr">toClassOnly</span>: <span class="hljs-literal">true</span> &#125;)<br>  <span class="hljs-keyword">readonly</span> <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span><br>  <span class="hljs-meta">@IsNotEmpty</span>(&#123;<br>    <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;key不能为空&#x27;</span>,<br>  &#125;)<br>  <span class="hljs-keyword">readonly</span> <span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>这个很简单理解：需要 2 个参数，一个 name，一个 key，name 是用户名，key 是注册时候我们创建的标识，邮箱，密码，自定义盐混合一起加密。</p>
<p>通用消息模板：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs ts">&lt;% <span class="hljs-title function_">layout</span>(<span class="hljs-string">&#x27;layout&#x27;</span>) -%&gt;<br><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">article</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;content&quot;</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;panel&#x27;</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;header&#x27;</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;breadcrumb&#x27;</span>&gt;</span></span><br><span class="language-xml">                <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&#x27;/&#x27;</span>&gt;</span>主页<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;divider&#x27;</span>&gt;</span>/<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span><br><span class="language-xml">                <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;active&#x27;</span>&gt;</span>通知<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;inner&#x27;</span>&gt;</span></span><br><span class="language-xml">            &lt;% if (typeof error !== &#x27;undefined&#x27; &amp;&amp; error) &#123; %&gt;</span><br><span class="language-xml">                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;alert alert-error&quot;</span>&gt;</span></span><br><span class="language-xml">                    <span class="hljs-tag">&lt;<span class="hljs-name">strong</span>&gt;</span>&lt;%= error %&gt;<span class="hljs-tag">&lt;/<span class="hljs-name">strong</span>&gt;</span></span><br><span class="language-xml">                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">            &lt;% &#125; %&gt;</span><br><span class="language-xml">                &lt;% if (typeof success !== &#x27;undefined&#x27; &amp;&amp; success) &#123; %&gt;</span><br><span class="language-xml">                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;alert alert-success&quot;</span>&gt;</span></span><br><span class="language-xml">                        <span class="hljs-tag">&lt;<span class="hljs-name">strong</span>&gt;</span>&lt;%= success %&gt;<span class="hljs-tag">&lt;/<span class="hljs-name">strong</span>&gt;</span></span><br><span class="language-xml">                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">                &lt;% &#125; %&gt;</span><br><span class="language-xml">                <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;&lt;%- typeof referer !== &#x27;undefined&#x27; ? referer : &#x27;/&#x27; %&gt;&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;span-common&quot;</span>&gt;</span>返回<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">article</span>&gt;</span></span><br></code></pre></td></tr></table></figure>

<p>这模板直接拿<code>cnode</code>的页面。</p>
<p>接下来就是控制器：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-meta">@Controller</span>()<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthController</span> &#123;<br>    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span><br><span class="hljs-params">        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> authService: AuthService,</span><br><span class="hljs-params">    </span>) &#123;&#125;<br>    ....<br>    <span class="hljs-comment">/** 激活账号 */</span><br>    <span class="hljs-meta">@Get</span>(<span class="hljs-string">&#x27;/active_account&#x27;</span>)<br>    <span class="hljs-meta">@Render</span>(<span class="hljs-title class_">ViewsPath</span>.<span class="hljs-property">Notify</span>)<br>    <span class="hljs-keyword">async</span> <span class="hljs-title function_">activeAccount</span>(<span class="hljs-params"><span class="hljs-meta">@Query</span>() account: AccountDto</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">authService</span>.<span class="hljs-title function_">activeAccount</span>(account);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>我们需要获取<code>url</code>的<code>?</code>后面的参数，需要用到<code>@Query()</code>装饰器，配合参数验证，最后拿到数据参数，丢给对应的服务去处理业务逻辑。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/Injectable">@Injectable</a>()<br>export class AuthService {<br>private readonly logger = new Logger(AuthService.name, true);<br>constructor(<br>private readonly userService: UserService,<br>private readonly config: ConfigService,<br>private readonly mailService: MailService,<br>) { }<br>…</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-comment">/** 激活账户 */</span><br><span class="hljs-keyword">async</span> <span class="hljs-title function_">activeAccount</span>(<span class="hljs-params">&#123; name, key &#125;: AccountDto</span>) &#123;<br>    <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">userService</span>.<span class="hljs-title function_">findOne</span>(&#123;<br>        <span class="hljs-attr">loginname</span>: name,<br>    &#125;);<br>    <span class="hljs-comment">// 检查用户是否存在</span><br>    <span class="hljs-keyword">if</span> (!user) &#123;<br>        <span class="hljs-keyword">return</span> &#123; <span class="hljs-attr">error</span>: <span class="hljs-string">&#x27;用户不存在&#x27;</span> &#125;;<br>    &#125;<br>    <span class="hljs-comment">// 对比key是否正确</span><br>    <span class="hljs-keyword">if</span> (!user || utility.<span class="hljs-title function_">md5</span>(user.<span class="hljs-property">email</span> + user.<span class="hljs-property">pass</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;SESSION_SECRET&#x27;</span>)) !== key) &#123;<br>        <span class="hljs-keyword">return</span> &#123; <span class="hljs-attr">error</span>: <span class="hljs-string">&#x27;信息有误，帐号无法被激活。&#x27;</span> &#125;;<br>    &#125;<br>    <span class="hljs-comment">// 检查用户是否激活过</span><br>    <span class="hljs-keyword">if</span> (user.<span class="hljs-property">active</span>) &#123;<br>        <span class="hljs-keyword">return</span> &#123; <span class="hljs-attr">error</span>: <span class="hljs-string">&#x27;帐号已经是激活状态。&#x27;</span>, <span class="hljs-attr">referer</span>: <span class="hljs-string">&#x27;/login&#x27;</span> &#125;;<br>    &#125;<br><br>    <span class="hljs-comment">// 如果没有激活，就激活操作</span><br>    user.<span class="hljs-property">active</span> = <span class="hljs-literal">true</span>;<br>    <span class="hljs-keyword">await</span> user.<span class="hljs-title function_">save</span>();<br>    <span class="hljs-keyword">return</span> &#123; <span class="hljs-attr">success</span>: <span class="hljs-string">&#x27;帐号已被激活，请登录&#x27;</span>, <span class="hljs-attr">referer</span>: <span class="hljs-string">&#x27;/login&#x27;</span> &#125;;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>}</p>
<p>注释已经写的很清晰的，就不在叙述的问题。接下来讲我们这篇文章的最后一个问题登录，在讲到登录之前需要简单科普一下怎么才算登录，它的凭证是什么？</p>
<h2 id="登录"><a href="#登录" class="headerlink" title="登录"></a>登录</h2><h3 id="登录凭证"><a href="#登录凭证" class="headerlink" title="登录凭证"></a>登录凭证</h3><p>目前来说比较常用有 2 种一种是<code>session+cookie</code>，一种是<code>JSON Web Tokens</code>。</p>
<h4 id="session-cookie"><a href="#session-cookie" class="headerlink" title="session+cookie"></a>session+cookie</h4><p>session+cookie 是比较常见前后端一起那种。它是流程大概是这样的：</p>
<ol>
<li>前端发起 http 请求时有携带 cookie</li>
<li>后端拿到此 cookie 对比服务器 session，有登陆则放过此请求，无登录，redirect 到登录页面</li>
<li>前端登录，后端比对用户名密码，成功则生成唯一标识符，放在 session，并且存入浏览器 cookie</li>
<li>用户可以拿到自己的 cookie，就可以发起任何的客户端 http 请求</li>
</ol>
<p>注意：以上操作都是合法操作，如果个人过失暴露 cookie 给其他人，属于用户个人的行为，比如你在网吧里登录 QQ，服务端没有办法不允许这样操作。而客户端的人应有安全意识，在公共场所及时清空 cookie，或者停止使用一切 [不随 session 关闭而 cookie 失效] 的应用。</p>
<h4 id="JSON-Web-Tokens"><a href="#JSON-Web-Tokens" class="headerlink" title="JSON Web Tokens"></a>JSON Web Tokens</h4><p>JSON Web Tokens 是比较常见前后分离那种。它是流程大概是这样的：</p>
<ol>
<li>登录时候,客户端通过用户名与密码请求登录</li>
<li>服务端收到请求区验证用户名与密码</li>
<li>验证通过,服务端会签发一个 Token,再把这个 Token 发给客户端.</li>
<li>客户端收到 Token,存储到本地,如 Cookie,SessionStorage,LocalStorage.</li>
<li>客户端每次像服务器请求 API 接口时候,都要带上 Token.</li>
<li>服务端收到请求,验证 Token,如果通过就返回数据,否则提示报错信息.</li>
</ol>
<p>注意：前端是无设防的，不可以信任； 全部的校验都由后端完成</p>
<p>我们这里是前后端一体的，当然选择<code>session+cookie</code>。这里有篇文章介绍还行，<a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/node-lessons/cookie-session.html">传送门</a>。</p>
<p>我们这里登录需要实现 2 个，一个是本地登录，一个是第三方 github 登录。</p>
<h3 id="本地登录"><a href="#本地登录" class="headerlink" title="本地登录"></a>本地登录</h3><p><code>nestjs</code>已经帮我们封装好了<code>@nestjs/passport</code>，我们前面已经说了需要下载相关包。本地登录使用<code>passport-local</code>完成。</p>
<p>新写个模板，需要去定义一个枚举 ViewsPath 登录地址</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-meta">@Controller</span>()<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthController</span> &#123;<br>    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span><br><span class="hljs-params">        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> authService: AuthService,</span><br><span class="hljs-params">    </span>) &#123;&#125;<br>    ....<br>        <span class="hljs-comment">/** 登录模板 */</span><br>    <span class="hljs-meta">@Get</span>(<span class="hljs-string">&#x27;/login&#x27;</span>)<br>    <span class="hljs-meta">@Render</span>(<span class="hljs-title class_">ViewsPath</span>.<span class="hljs-property">Login</span>)<br>    <span class="hljs-keyword">async</span> <span class="hljs-title function_">loginView</span>(<span class="hljs-params"><span class="hljs-meta">@Req</span>() req: TRequest</span>) &#123;<br>        <span class="hljs-keyword">const</span> <span class="hljs-attr">error</span>: <span class="hljs-built_in">string</span> = req.<span class="hljs-title function_">flash</span>(<span class="hljs-string">&#x27;loginError&#x27;</span>)[<span class="hljs-number">0</span>];<br>        <span class="hljs-keyword">return</span> &#123; <span class="hljs-attr">pageTitle</span>: <span class="hljs-string">&#x27;登录&#x27;</span>, error&#125;;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>和正常注册模板控制器一样，这里多了一项<code>req.flash(&#39;loginError&#39;)[0]</code>，其实它是<code>connect-flash</code>中间件。其实我们自己写一个也完全没有问题，本身就没有几行代码，既然有轮子就用呗，它是做什么，就是帮我们去<code>session</code>记录消息，然后去获取，绑定在<code>Request</code>上。你需要安装它<code>npm install connect-flash -S</code>。</p>
<p>模板直接拷贝<code>cnode</code>的登录模板，改了一下请求地址。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs ts"> <span class="hljs-comment">/** 本地登录提交 */</span><br><span class="hljs-meta">@Post</span>(<span class="hljs-string">&#x27;/login&#x27;</span>)<br><span class="hljs-meta">@UseGuards</span>(<span class="hljs-title class_">AuthGuard</span>(<span class="hljs-string">&#x27;local&#x27;</span>))<br><span class="hljs-keyword">async</span> <span class="hljs-title function_">passportLocal</span>(<span class="hljs-params"><span class="hljs-meta">@Req</span>() req: TRequest, <span class="hljs-meta">@Res</span>() res: TResponse</span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(req.<span class="hljs-property">user</span>));<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">verifyLogin</span>(req, res, req.<span class="hljs-property">user</span>);<br>&#125;<br><span class="hljs-comment">/** 验证登录 */</span><br><span class="hljs-keyword">private</span> <span class="hljs-title function_">verifyLogin</span>(<span class="hljs-params"><span class="hljs-meta">@Req</span>() req, <span class="hljs-meta">@Res</span>() res, user: User</span>) &#123;<br>    <span class="hljs-comment">// id 存入 Cookie, 用于验证过期.</span><br>    <span class="hljs-keyword">const</span> auth_token = user.<span class="hljs-property">_id</span> + <span class="hljs-string">&#x27;$$$$&#x27;</span>; <span class="hljs-comment">// 以后可能会存储更多信息，用 $$$$ 来分隔</span><br>    <span class="hljs-comment">// 配置 Cookie</span><br>    <span class="hljs-keyword">const</span> opts = &#123;<br>        <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/&#x27;</span>,<br>        <span class="hljs-attr">maxAge</span>: <span class="hljs-number">1000</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">24</span> * <span class="hljs-number">30</span>,<br>        <span class="hljs-attr">signed</span>: <span class="hljs-literal">true</span>,<br>        <span class="hljs-attr">httpOnly</span>: <span class="hljs-literal">true</span>,<br>    &#125;;<br>    res.<span class="hljs-title function_">cookie</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;AUTH_COOKIE_NAME&#x27;</span>), auth_token, opts); <span class="hljs-comment">// cookie 有效期30天</span><br>    <span class="hljs-comment">// 调用 passport 的 login方法 传递 user信息</span><br>    req.<span class="hljs-title function_">login</span>(user, <span class="hljs-function">() =&gt;</span> &#123;<br>        <span class="hljs-comment">// 重定向首页</span><br>        res.<span class="hljs-title function_">redirect</span>(<span class="hljs-string">&#x27;/&#x27;</span>);<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里使用守卫，<code>AuthGuard</code>首页是<code>@nestjs/passport</code>。verifyLogin 是登录以后操作。为什么封装一个方法，等下 github 登录成功也是一样的操作。<code>login</code>方法是<code>passport</code>的方法，<code>user</code>就是我们拿到的用户信息。</p>
<p><strong>注意</strong>：这里的<code>passport-local</code>是网上的栗子实现有差别，网上栗子都可以配置，重定向的功能，</p>
<p>这是<a target="_blank" rel="noopener" href="http://www.passportjs.org/docs/authenticate/">passport</a>文档里面的栗子。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs ts">app.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/login&#x27;</span>,<br>  passport.<span class="hljs-title function_">authenticate</span>(<span class="hljs-string">&#x27;local&#x27;</span>,<br>   &#123;<br>       <span class="hljs-attr">successRedirect</span>: <span class="hljs-string">&#x27;/&#x27;</span>,<br>      <span class="hljs-attr">failureRedirect</span>: <span class="hljs-string">&#x27;/login&#x27;</span>,<br>   &#125;),t<br>  <span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) &#123;<br>    res.<span class="hljs-title function_">redirect</span>(<span class="hljs-string">&#x27;/&#x27;</span>);<br>  &#125;);<br></code></pre></td></tr></table></figure>

<p>这个坑我也捣鼓很久，无论成功还是失败重定向都需要手动去处理它。成功就是上面我那个<code>login</code>。</p>
<p>我们需要新增一个<code>passport</code>文件夹，里面放 passport 相关的业务。</p>
<p>新建一个<code>local.strategy.ts</code>，处理<code>passport-local</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Injectable</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/common&#x27;</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">PassportStrategy</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/passport&#x27;</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Strategy</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;passport-local&#x27;</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">AuthService</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../auth.service&#x27;</span><br><br><span class="hljs-meta">@Injectable</span>()<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LocalStrategy</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">PassportStrategy</span>(<span class="hljs-title class_">Strategy</span>, <span class="hljs-string">&#x27;local&#x27;</span>) &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> authService: AuthService</span>) &#123;<br>    <span class="hljs-variable language_">super</span>(&#123;<br>      <span class="hljs-attr">usernameField</span>: <span class="hljs-string">&#x27;name&#x27;</span>,<br>      <span class="hljs-attr">passwordField</span>: <span class="hljs-string">&#x27;pass&#x27;</span>,<br>      <span class="hljs-attr">passReqToCallback</span>: <span class="hljs-literal">false</span>,<br>    &#125;)<br>  &#125;<br><br>  <span class="hljs-comment">// tslint:disable-next-line:ban-types</span><br>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">validate</span>(<span class="hljs-params">username: <span class="hljs-built_in">string</span>, password: <span class="hljs-built_in">string</span>, done: <span class="hljs-built_in">Function</span></span>) &#123;<br>    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">authService</span><br>      .<span class="hljs-title function_">local</span>(username, password)<br>      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> <span class="hljs-title function_">done</span>(<span class="hljs-literal">null</span>, user))<br>      .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> <span class="hljs-title function_">done</span>(err, <span class="hljs-literal">false</span>))<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里就比较简单，就这么几行代码，自定义一个本地策略，去继承<code>@nestjs/passport</code>一个父类，super 需要传递是<code>new LocalStrategy(&#39;配置对象&#39;)</code>，<code>validate</code>是一个抽象方法，我们必须要去实现的，因为<code>@nestjs/passport</code>也不知道我们是怎么样查询用户是否存在，这个验证方法暴露给我们的去实现。<code>done</code>就相当于是<code>callback</code>，标准 nodejs 回调函数参数，第一个是表示错误，第二个是用户信息。</p>
<p>放到<code>AuthModule</code>里面去做服务申明。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-meta">@Module</span>(&#123;<br>  <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">SharedModule</span>],<br>  <span class="hljs-attr">providers</span>: [<span class="hljs-title class_">AuthService</span>, <span class="hljs-title class_">AuthSerializer</span>, <span class="hljs-title class_">LocalStrategy</span>],<br>  <span class="hljs-attr">controllers</span>: [<span class="hljs-title class_">AuthController</span>],<br>&#125;)<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthModule</span> &#123;&#125;<br></code></pre></td></tr></table></figure>

<p>AuthSerializer 也是和<code>passport</code>相关的，它里面需要实现 2 个方法<code>serializeUser</code>,<code>deserializeUser</code>。</p>
<ul>
<li>serializeUser：将用户信息序列化后存进 session 里面，一般需要精简，只保存个别字段</li>
<li>deserializeUser：反序列化后把用户信息从 session 中取出来，反查数据库拿到完整信息</li>
</ul>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">PassportSerializer</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/passport&#x27;</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Injectable</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/common&#x27;</span><br><br><span class="hljs-meta">@Injectable</span>()<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthSerializer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">PassportSerializer</span> &#123;<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 序列化用户</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> <span class="hljs-variable">user</span></span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> <span class="hljs-variable">done</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-title function_">serializeUser</span>(<span class="hljs-params">user: <span class="hljs-built_in">any</span>, done: (error: <span class="hljs-literal">null</span>, user: <span class="hljs-built_in">any</span>) =&gt; <span class="hljs-built_in">any</span></span>) &#123;<br>    <span class="hljs-title function_">done</span>(<span class="hljs-literal">null</span>, user)<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 反序列化用户</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> <span class="hljs-variable">payload</span></span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> <span class="hljs-variable">done</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">deserializeUser</span>(<span class="hljs-params">payload: <span class="hljs-built_in">any</span>, done: (error: <span class="hljs-literal">null</span>, payload: <span class="hljs-built_in">any</span>) =&gt; <span class="hljs-built_in">any</span></span>) &#123;<br>    <span class="hljs-title function_">done</span>(<span class="hljs-literal">null</span>, payload)<br>  &#125;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">super</span>()<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>我们这里先简单粗暴把所有信息全部存到<code>session</code>，先实现功能，其他后面再优化。</p>
<p>接下来去服务实现<code>local</code>方法：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-comment">// Validation methods</span><br><span class="hljs-keyword">const</span> validator = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Validator</span>();<br><br><span class="hljs-meta">@Injectable</span>()<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthService</span> &#123;<br>    ...<br>    <span class="hljs-keyword">async</span> <span class="hljs-title function_">local</span>(<span class="hljs-params">username: <span class="hljs-built_in">string</span>, password: <span class="hljs-built_in">string</span></span>) &#123;<br>        <span class="hljs-comment">// 处理用户名和密码前后空格，用户名全部小写 保证和注册一致</span><br>        username = username.<span class="hljs-title function_">trim</span>().<span class="hljs-title function_">toLowerCase</span>();<br>        password = password.<span class="hljs-title function_">trim</span>();<br>        <span class="hljs-comment">// 验证用户名</span><br>        <span class="hljs-comment">// 可以用户名登录 /^[a-zA-Z0-9\-_]\w&#123;4,20&#125;$/</span><br>        <span class="hljs-comment">// 可以邮箱登录 标准邮箱格式</span><br>        <span class="hljs-comment">// 做一个验证用户名适配器</span><br>        <span class="hljs-keyword">const</span> <span class="hljs-title function_">verifyUsername</span> = (<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>) =&gt; &#123;<br>            <span class="hljs-comment">// 如果输入账号里面有@，表示是邮箱</span><br>            <span class="hljs-keyword">if</span> (name.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&#x27;@&#x27;</span>) &gt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-keyword">return</span> validator.<span class="hljs-title function_">isEmail</span>(name);<br>            &#125;<br>            <span class="hljs-keyword">return</span> validator.<span class="hljs-title function_">matches</span>(name, <span class="hljs-regexp">/^[a-zA-Z0-9\-_]\w&#123;4,20&#125;$/</span>);<br>        &#125;;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">verifyUsername</span>(username)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnauthorizedException</span>(<span class="hljs-string">&#x27;用户名格式不正确。&#x27;</span>);<br>        &#125;<br>        <span class="hljs-comment">// 验证密码 密码长度是6-18位</span><br>        <span class="hljs-keyword">if</span> (!validator.<span class="hljs-title function_">isByteLength</span>(password, <span class="hljs-number">6</span>, <span class="hljs-number">18</span>)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnauthorizedException</span>(<span class="hljs-string">&#x27;密码长度不是6-18位。&#x27;</span>);<br>        &#125;<br>        <span class="hljs-comment">// 做一个获取用户适配器</span><br>        <span class="hljs-keyword">const</span> <span class="hljs-title function_">getUser</span> = (<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>) =&gt; &#123;<br>            <span class="hljs-comment">// 如果输入账号里面有@，表示是邮箱</span><br>            <span class="hljs-keyword">if</span> (name.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&#x27;@&#x27;</span>) &gt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">userService</span>.<span class="hljs-title function_">getUserByMail</span>(name);<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">userService</span>.<span class="hljs-title function_">getUserByLoginName</span>(name);<br>        &#125;;<br>        <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getUser</span>(username);<br>        <span class="hljs-comment">// 检查用户是否存在</span><br>        <span class="hljs-keyword">if</span> (!user) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnauthorizedException</span>(<span class="hljs-string">&#x27;用户不存在。&#x27;</span>);<br>        &#125;<br>        <span class="hljs-keyword">const</span> equal = <span class="hljs-title function_">compareSync</span>(password, user.<span class="hljs-property">pass</span>);<br>        <span class="hljs-comment">// 密码不匹配</span><br>        <span class="hljs-keyword">if</span> (!equal) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnauthorizedException</span>(<span class="hljs-string">&#x27;用户密码不匹配。&#x27;</span>);<br>        &#125;<br>        <span class="hljs-comment">// 用户未激活</span><br>        <span class="hljs-keyword">if</span> (!user.<span class="hljs-property">active</span>) &#123;<br>            <span class="hljs-comment">// 发送激活邮件</span><br>            <span class="hljs-keyword">const</span> token = utility.<span class="hljs-title function_">md5</span>(user.<span class="hljs-property">email</span> + user.<span class="hljs-property">pass</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;SESSION_SECRET&#x27;</span>));<br>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">mailService</span>.<span class="hljs-title function_">sendActiveMail</span>(user.<span class="hljs-property">email</span>, token, user.<span class="hljs-property">loginname</span>);<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnauthorizedException</span>(<span class="hljs-string">&#x27;此帐号还没有被激活，激活链接已发送到 &#x27;</span> + user.<span class="hljs-property">email</span> + <span class="hljs-string">&#x27; 邮箱，请查收。&#x27;</span>);<br>        &#125;<br>        <span class="hljs-comment">// 验证通过</span><br>        <span class="hljs-keyword">return</span> user;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>上面都有注释，这里说明一下为什么需要在这里去验证字段信息，这也是使用<code>@nestjs/passport</code>坑。</p>
<p>验证使用<code>class-validator</code>提供的验证器类<code>Validator</code>，其他验证方法和我们注册保持一致。注释都已经一一说明。</p>
<p>错误都使用<code>throw new UnauthorizedException(&#39;错误信息&#39;);</code>这样的方式去抛出，这也是在<code>AuthGuard</code>源码里面，有个处理请求方法：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-title function_">handleRequest</span>(err, user, info): <span class="hljs-title class_">TUser</span> &#123;<br>      <span class="hljs-keyword">if</span> (err || !user) &#123;<br>        <span class="hljs-keyword">throw</span> err || <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnauthorizedException</span>();<br>      &#125;<br>      <span class="hljs-keyword">return</span> user;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>只要有错误，就回去走错误，这个错误就被<code>ExceptionFilter</code>捕获，我们有自定义的<code>HttpExceptionFilter</code>，等下就来讲它。<br>只有没有错误，成功才会返回 user，这时候去走，<code>serializeUser</code>, <code>deserializeUser</code>, <code>passportLocal</code>最后重定向到首页。</p>
<p><strong>注意</strong>：抛出异常一定要用<code>throw</code>，不用使用<code>return</code>。用<code>return</code>就直接走<code>serializeUser</code>，然后报错了。</p>
<p>错误处理，因为这个身份认证只要出错返回都是 401，那么我们需要去捕获处理一下，</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs ts">...<br>            <span class="hljs-keyword">case</span> <span class="hljs-title class_">HttpStatus</span>.<span class="hljs-property">UNAUTHORIZED</span>: <span class="hljs-comment">// 如果错误码 401</span><br>                request.<span class="hljs-title function_">flash</span>(<span class="hljs-string">&#x27;loginError&#x27;</span>, exception.<span class="hljs-property">message</span>.<span class="hljs-property">message</span> || <span class="hljs-string">&#x27;信息不全。&#x27;</span>);<br>                response.<span class="hljs-title function_">redirect</span>(<span class="hljs-string">&#x27;/login&#x27;</span>);<br>                <span class="hljs-keyword">break</span>;<br> ...<br></code></pre></td></tr></table></figure>

<p>默认<code>handleRequest</code>返回是一个空的，<code>exception.message.message</code>是<code>undefined</code>，这是<code>passport</code>返回，只要用户名或者密码没有填，都会返回这个错误信息，对应我们来捕获错误也是一脸懵逼，我看<code>cndoe</code>是直接返回<code>信息不全。</code>，这里就一样简单粗暴处理了。</p>
<blockquote>
<p>说多了都是眼泪，这个地方卡了我很久。这篇文章卡壳，它需要付 50%责任，因为网上没有关于<code>@nestjs/passport</code>的<code>passport-local</code>的栗子。大多数都是<code>jwt</code>栗子，比较折腾，试过各种方法方式。</p>
</blockquote>
<h3 id="github-登录"><a href="#github-登录" class="headerlink" title="github 登录"></a>github 登录</h3><p>这个玩意就本地登录简单多了。先说下流程：</p>
<p>我们网站叫<code>nest-cnode</code></p>
<ol>
<li>nest-cnode 网站让用户跳转到 GitHub。</li>
<li>GitHub 要求用户登录，然后询问”nest-cnode 网站要求获得 xx 权限，你是否同意？”</li>
<li>用户同意，GitHub 就会重定向回 nest-cnode 网站，同时发回一个授权码。</li>
<li>nest-cnode 网站使用授权码，向 GitHub 请求令牌。</li>
<li>GitHub 返回令牌.</li>
<li>nest-cnode 网站使用令牌，向 GitHub 请求用户数据。</li>
</ol>
<p>接下来我们就去实现一下：</p>
<p>先 github 申请一个认证，应用登记。</p>
<p>一个应用要求 OAuth 授权，必须先到对方网站登记，让对方知道是谁在请求。</p>
<p>所以，我们要先去 GitHub 登记一下。这是免费的。</p>
<p>访问这个<a target="_blank" rel="noopener" href="https://github.com/settings/applications/new">网址</a>，填写登记表。</p>
<p><a target="_blank" rel="noopener" href="https://user-images.githubusercontent.com/6111778/56720050-78ad4780-6774-11e9-8503-e494f8bc79b9.png"><img src="https://user-images.githubusercontent.com/6111778/56720050-78ad4780-6774-11e9-8503-e494f8bc79b9.png" srcset="/blog/img/loading.gif" lazyload alt="%V}9$D4LD_4YLFKXRTVJ7QP"></a></p>
<p>应用的名称随便填，主页 URL 填写<code>http://localhost:3000</code>，跳转网址填写 <code>http://localhost:3000/github/callback</code>。</p>
<p>提交表单以后，GitHub 应该会返回客户端 ID（client ID）和客户端密钥（client secret），这就是应用的身份识别码。</p>
<p>我们创建一个<code>github.strategy.ts</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-meta">@Injectable</span>()<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GithubStrategy</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">PassportStrategy</span>(<span class="hljs-title class_">Strategy</span>) &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> config: ConfigService</span>) &#123;<br>    <span class="hljs-variable language_">super</span>(&#123;<br>      <span class="hljs-attr">clientID</span>: config.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;GITHUB_CLIENT_ID&#x27;</span>),<br>      <span class="hljs-attr">clientSecret</span>: config.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;GITHUB_CLIENT_SECRET&#x27;</span>),<br>      <span class="hljs-attr">callbackURL</span>: <span class="hljs-string">`<span class="hljs-subst">$&#123;config.get(<span class="hljs-string">&#x27;HOST&#x27;</span>)&#125;</span>:<span class="hljs-subst">$&#123;config.get(<span class="hljs-string">&#x27;PORT&#x27;</span>)&#125;</span>/github/callback`</span>,<br>    &#125;)<br>  &#125;<br><br>  <span class="hljs-comment">// tslint:disable-next-line:ban-types</span><br>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">validate</span>(<span class="hljs-params">accessToken, refreshToken, profile: GitHubProfile, done: <span class="hljs-built_in">Function</span></span>) &#123;<br>    profile.<span class="hljs-property">accessToken</span> = accessToken<br>    <span class="hljs-title function_">done</span>(<span class="hljs-literal">null</span>, profile)<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>需要配置<code>clientID</code>, <code>clientSecret</code>, <code>callbackURL</code>, 这 3 个东西，我们上面图里面都有。把它申明到模块里面去。</p>
<p>github2 个必备的路由：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-comment">/** github登录提交 */</span><br><span class="hljs-meta">@Get</span>(<span class="hljs-string">&#x27;/github&#x27;</span>)<br><span class="hljs-meta">@UseGuards</span>(<span class="hljs-title class_">AuthGuard</span>(<span class="hljs-string">&#x27;github&#x27;</span>))<br><span class="hljs-keyword">async</span> <span class="hljs-title function_">github</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br><br><span class="hljs-meta">@Get</span>(<span class="hljs-string">&#x27;/github/callback&#x27;</span>)<br><span class="hljs-keyword">async</span> <span class="hljs-title function_">githubCallback</span>(<span class="hljs-params"><span class="hljs-meta">@Req</span>() req: TRequest, <span class="hljs-meta">@Res</span>() res: TResponse</span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(req.<span class="hljs-property">user</span>));<br>    <span class="hljs-keyword">const</span> existUser = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">authService</span>.<span class="hljs-title function_">github</span>(req.<span class="hljs-property">user</span>);<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">verifyLogin</span>(req, res, existUser);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>我们需要 github 登录时候就去请求<code>/github</code>路由，使用守卫，告诉守卫使用<code>github</code>策略。这个方法随便写，返回都会重定向到<a target="_blank" rel="noopener" href="https://github.com/">github.com</a>，填完登录信息，就会自动跳转到<code>githubCallback</code>方法里面，<code>req.user</code>返回就是 github 给我们提供的所有信息。我们需要去和我们用户系统做关联。</p>
<p>服务 github 方法：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">async</span> <span class="hljs-title function_">github</span>(<span class="hljs-params">profile: GitHubProfile</span>) &#123;<br>        <span class="hljs-keyword">if</span> (!profile) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnauthorizedException</span>(<span class="hljs-string">&#x27;您 GitHub 账号的 认证失败&#x27;</span>);<br>        &#125;<br>        <span class="hljs-comment">// 获取用户的邮箱</span><br>        <span class="hljs-keyword">const</span> email = profile.<span class="hljs-property">emails</span> &amp;&amp; profile.<span class="hljs-property">emails</span>[<span class="hljs-number">0</span>] &amp;&amp; profile.<span class="hljs-property">emails</span>[<span class="hljs-number">0</span>].<span class="hljs-property">value</span>;<br>        <span class="hljs-comment">// 根据 githubId 查找用户</span><br>        <span class="hljs-keyword">let</span> existUser = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">userService</span>.<span class="hljs-title function_">getUserByGithubId</span>(profile.<span class="hljs-property">id</span>);<br><br>        <span class="hljs-comment">// 用户不存在则创建</span><br>        <span class="hljs-keyword">if</span> (!existUser) &#123;<br>            existUser = <span class="hljs-keyword">new</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">userService</span>.<span class="hljs-title function_">getMode</span>();<br>            existUser.<span class="hljs-property">githubId</span> = profile.<span class="hljs-property">id</span>;<br>            existUser.<span class="hljs-property">active</span> = <span class="hljs-literal">true</span>;<br>            existUser.<span class="hljs-property">accessToken</span> = profile.<span class="hljs-property">accessToken</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// 用户存在，更新字段</span><br>        existUser.<span class="hljs-property">loginname</span> = profile.<span class="hljs-property">username</span>;<br>        existUser.<span class="hljs-property">email</span> = email || existUser.<span class="hljs-property">email</span>;<br>        existUser.<span class="hljs-property">avatar</span> = profile.<span class="hljs-property">_json</span>.<span class="hljs-property">avatar_url</span>;<br>        existUser.<span class="hljs-property">githubUsername</span> = profile.<span class="hljs-property">username</span>;<br>        existUser.<span class="hljs-property">githubAccessToken</span> = profile.<span class="hljs-property">accessToken</span>;<br><br>        <span class="hljs-comment">// 保存用户到数据库</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">await</span> existUser.<span class="hljs-title function_">save</span>();<br>            <span class="hljs-comment">// 返回用户</span><br>            <span class="hljs-keyword">return</span> existUser;<br>        &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>            <span class="hljs-comment">// 获取MongoError错误信息</span><br>            <span class="hljs-keyword">const</span> errmsg = error.<span class="hljs-property">errmsg</span> || <span class="hljs-string">&#x27;&#x27;</span>;<br>            <span class="hljs-comment">// 处理邮箱和用户名重复问题</span><br>            <span class="hljs-keyword">if</span> (errmsg.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&#x27;duplicate key error&#x27;</span>) &gt; -<span class="hljs-number">1</span>) &#123;<br>                <span class="hljs-keyword">if</span> (errmsg.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&#x27;email&#x27;</span>) &gt; -<span class="hljs-number">1</span>) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnauthorizedException</span>(<span class="hljs-string">&#x27;您 GitHub 账号的 Email 与之前在 CNodejs 注册的 Email 重复了&#x27;</span>);<br>                &#125;<br><br>                <span class="hljs-keyword">if</span> (errmsg.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&#x27;loginname&#x27;</span>) &gt; -<span class="hljs-number">1</span>) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnauthorizedException</span>(<span class="hljs-string">&#x27;您 GitHub 账号的用户名与之前在 CNodejs 注册的用户名重复了&#x27;</span>);<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InternalServerErrorException</span>(error);<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p><strong>注意</strong>：<code>profile</code>返回信息可能是个<code>undefined</code>，因为认证可能会失败，需要去处理一下，不然后面代码全挂了。O(∩_∩)O 哈哈~。</p>
<p>登录功能基本完成了，需要判断用户登录。</p>
<p>我们需要写一个中间件，<code>current_user.middleware.ts</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Injectable</span>, <span class="hljs-title class_">NestMiddleware</span>, <span class="hljs-title class_">MiddlewareFunction</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/common&#x27;</span><br><br><span class="hljs-meta">@Injectable</span>()<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CurrentUserMiddleware</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NestMiddleware</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) &#123;&#125;<br>  <span class="hljs-title function_">resolve</span>(...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>[]): <span class="hljs-title class_">MiddlewareFunction</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> &#123;<br>      res.<span class="hljs-property">locals</span>.<span class="hljs-property">current_user</span> = <span class="hljs-literal">null</span><br>      <span class="hljs-keyword">const</span> &#123; user &#125; = req<br>      <span class="hljs-keyword">if</span> (!user) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title function_">next</span>()<br>      &#125;<br>      res.<span class="hljs-property">locals</span>.<span class="hljs-property">current_user</span> = user<br>      <span class="hljs-title function_">next</span>()<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>因为<code>passport</code>登录成功以后，会自动给<code>req</code>添加一个属性<code>user</code>，我们只需要去判断它就可以了。</p>
<p><strong>注意</strong>：<code>nestjs</code>中间件和<code>express</code>中间件有区别：</p>
<p>express 定义的中间件，如果全局可以直接通过<code>express.use(中间件)</code>去申明使用。</p>
<p>nestjs 定义的中间件不能这么玩，需要在模块里面去申明使用。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppModule</span> &#123;<br>  <span class="hljs-title function_">configure</span>(<span class="hljs-params">consumer: MiddlewareConsumer</span>) &#123;<br>    consumer.<span class="hljs-title function_">apply</span>(<span class="hljs-title class_">CurrentUserMiddleware</span>).<span class="hljs-title function_">forRoutes</span>(&#123; <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;*&#x27;</span>, <span class="hljs-attr">method</span>: <span class="hljs-title class_">RequestMethod</span>.<span class="hljs-property">ALL</span> &#125;)<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>我们把全局的中间件都丢到<code>AppModule</code>，里面去申明使用。</p>
<p>修改一下<code>AppController</code>首页：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-meta">@Get</span>()<br>  <span class="hljs-meta">@Render</span>(<span class="hljs-string">&#x27;index&#x27;</span>)<br>  <span class="hljs-title function_">root</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> &#123;&#125;;<br>  &#125;<br></code></pre></td></tr></table></figure>

<p>登录前：</p>
<p><a target="_blank" rel="noopener" href="https://user-images.githubusercontent.com/6111778/56723079-dc3a7380-677a-11e9-8429-d562ae754c3c.png">![KZWPT O)_GKL`$6 RAISBOX](https://user-images.githubusercontent.com/6111778/56723079-dc3a7380-677a-11e9-8429-d562ae754c3c.png)</a></p>
<p>登录后：</p>
<p><a target="_blank" rel="noopener" href="https://user-images.githubusercontent.com/6111778/56723112-eb212600-677a-11e9-82da-c7a0b24700ec.png">![0SJTB2VL`C)C7P6F34KT6V5](https://user-images.githubusercontent.com/6111778/56723112-eb212600-677a-11e9-82da-c7a0b24700ec.png)</a></p>
<p>在弄个退出就完美了：它就更简单了:</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-meta">@Controller</span>()<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthController</span> &#123;<br>  <span class="hljs-comment">/** 登出 */</span><br>  <span class="hljs-meta">@All</span>(<span class="hljs-string">&#x27;/logout&#x27;</span>)<br>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">logout</span>(<span class="hljs-params"><span class="hljs-meta">@Req</span>() req: TRequest, <span class="hljs-meta">@Res</span>() res: TResponse</span>) &#123;<br>    <span class="hljs-comment">// 销毁 session</span><br>    req.<span class="hljs-property">session</span>.<span class="hljs-title function_">destroy</span>()<br>    <span class="hljs-comment">// 清除 cookie</span><br>    res.<span class="hljs-title function_">clearCookie</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;AUTH_COOKIE_NAME&#x27;</span>), &#123; <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/&#x27;</span> &#125;)<br>    <span class="hljs-comment">// 调用 passport 的 logout方法</span><br>    req.<span class="hljs-title function_">logout</span>()<br>    <span class="hljs-comment">// 重定向到首页</span><br>    res.<span class="hljs-title function_">redirect</span>(<span class="hljs-string">&#x27;/&#x27;</span>)<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>就是一波清空操作，调用<code>passport</code>的<code>logout</code>方法。</p>
<p>代码已更新，<a target="_blank" rel="noopener" href="https://github.com/jiayisheji/nest-cnode">传送门</a>。</p>
<p>欲知后事如何，请听下回分解。</p>
<blockquote>
<p>中篇就到此为止了，最后感谢大家暴力吹更，让我坚持不懈的把它写完。后面就比较容易了。<a target="_blank" rel="noopener" href="https://github.com/typeorm/typeorm">Typeorm</a>比较火，等我把全部业面写完了，会更新<code>typeorm</code>版操作<code>MongoDB</code>。回馈大家不离不弃的关注，再次感谢大家阅读。</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/jiayisheji/blog/issues/18">本文来自 https://github.com/jiayisheji/blog/issues/19</a></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/blog/categories/node/" class="category-chain-item">node</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/blog/tags/node/">#node</a>
      
        <a href="/blog/tags/nest/">#nest</a>
      
    </div>
  
</div>


              

              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/blog/2021/01/31/vue/vue_router/" title="Vue解决同一页面跳转页面不更新">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Vue解决同一页面跳转页面不更新</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/blog/2021/01/28/node/nest_1/" title="nest.js学习（一）">
                        <span class="hidden-mobile">nest.js学习（一）</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.5.1/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"rjYK8gArXwKlWNAj87aLDjel-gzGzoHsz","appKey":"nwLIBSLqc2For9OE49wSuWaf","path":"window.location.pathname","placeholder":"说点什么","avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":null,"emojiCDN":null,"emojiMaps":null,"enableQQ":false,"appid":"rjYK8gArXwKlWNAj87aLDjel-gzGzoHsz","appkey":"nwLIBSLqc2For9OE49wSuWaf"},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <i class="iconfont icon-mail"></i> <a href="#" rel="nofollow noopener"><span>1793980864@qq.com</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":200})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/blog/js/events.js" ></script>
<script  src="/blog/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/blog/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/blog/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/blog/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
